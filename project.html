<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projet | GECC - Gestion √âlectronique des Contrats de Construction</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta name="description" content="D√©tails du projet GECC - Documents, t√¢ches, suivi et √©changes">
    <meta name="theme-color" content="#667eea">
    <link rel="stylesheet" href="styles/design-system.css">
    <link rel="stylesheet" href="styles/header-design.css">
    
    <style>
        /* Correction imm√©diate de l'espacement des boutons de navigation */
        .header .nav {
            gap: 24px !important;
        }
        
        .header .nav-link {
            padding: 12px 20px !important;
            margin: 0 8px !important;
            white-space: nowrap !important;
        }
        
        /* Assurer que les boutons ne se collent pas */
        .header .nav-link:not(:last-child) {
            margin-right: 16px !important;
        }
        
        /* Style pour les s√©parateurs de navigation */
        .nav-separator {
            color: #cbd5e1 !important;
            font-weight: 300 !important;
            margin: 0 8px !important;
            user-select: none !important;
        }
        
        /* Espacement forc√© entre les √©l√©ments de navigation */
        .header .nav > * {
            margin: 0 12px !important;
        }
        
        /* Correction de la superposition du bouton Accueil et du profil */
        .header .user-section {
            position: relative !important;
            z-index: 10 !important;
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
        }
        
        .header .logout-btn {
            position: relative !important;
            z-index: 11 !important;
            margin-left: 8px !important;
        }
        
        /* Assurer que le header ne d√©borde pas */
        .header .container {
            overflow: visible !important;
            position: relative !important;
        }
        
        /* Style pour le logo PNG */
        .header .logo-icon {
            background: transparent !important; /* Enlever le fond violet */
            box-shadow: none !important; /* Enlever l'ombre */
        }
        
        .header .logo-icon img {
            width: 32px !important;
            height: 32px !important;
            object-fit: contain !important;
            /* Pas de filtre n√©cessaire car le PNG a un fond transparent */
        }
    </style>
    
    <!--
    ========================================================================================
    üìß √âTAPE 30 - ENVOI D'E-MAILS (P√âDAGOGIQUE, SANS BACKEND)
    ========================================================================================
    
    üéØ OBJECTIF : Simuler l'envoi r√©el et pr√©parer l'interface pour l'int√©gration backend
    
    üìã √âTAT ACTUEL (MVP) :
    - ‚úÖ G√©n√©ration de liens d'invitation fonctionnelle
    - ‚úÖ Copie dans le presse-papiers op√©rationnelle
    - ‚úÖ Interface utilisateur pr√™te pour l'int√©gration backend
    
    üöÄ INT√âGRATION BACKEND (Node.js + nodemailer) :
    
    1. INSTALLATION :
       npm install nodemailer
    
    2. SERVICE E-MAIL :
       - Cr√©er services/emailService.js
       - Configurer SMTP (Gmail, SendGrid, etc.)
       - Impl√©menter sendInvitationEmail()
       - G√©n√©rer templates HTML responsifs
    
    3. API ENDPOINT :
       - POST /api/invitations/send-invitation
       - Validation des donn√©es
       - Cr√©ation de l'invitation en BDD
       - Envoi automatique de l'e-mail
    
    4. VARIABLES D'ENVIRONNEMENT :
       SMTP_HOST=smtp.gmail.com
       SMTP_PORT=587
       SMTP_USER=your-email@gmail.com
       SMTP_PASS=your-app-password
       SMTP_FROM=noreply@geccproject.com
       FRONTEND_URL=http://localhost:3000
    
    5. INT√âGRATION FRONTEND :
       - D√©tection automatique du mode backend/MVP
       - Interface adaptative selon le mode
       - Gestion d'erreurs robuste
       - Fallback vers le mode MVP
    
    üîß MODIFICATIONS N√âCESSAIRES :
    
    A. D√©tection du mode backend :
       function detectBackendMode() {
           fetch('/api/health')
               .then(response => response.json())
               .then(data => {
                   window.GECC_BACKEND_AVAILABLE = (data.status === 'ok');
                   updateUIForCurrentMode();
               })
               .catch(() => {
                   window.GECC_BACKEND_AVAILABLE = false;
                   updateUIForMVPMode();
               });
       }
    
    B. Interface adaptative :
       - Mode MVP : "Copier le lien" + instructions manuelles
       - Mode Backend : "Envoyer l'e-mail" + envoi automatique
    
    C. Gestion des erreurs :
       - Fallback automatique vers le mode MVP
       - Messages d'erreur informatifs
       - Logs pour le debugging
    
    üìß TEMPLATE E-MAIL HTML :
    - Design responsive et professionnel
    - Couleurs coh√©rentes avec GECC Project
    - Call-to-action clair
    - Informations de s√©curit√©
    
    üéØ CRIT√àRES D'ACCEPTATION :
    - ‚úÖ Documentation claire pour l'int√©gration backend
    - ‚úÖ Interface pr√™te √† passer au backend
    - ‚úÖ Mode MVP fonctionnel sans backend
    - ‚úÖ Transition transparente entre les modes
    
    üìö DOCUMENTATION COMPL√àTE :
    Voir README-EMAIL-INTEGRATION.md pour le guide d√©taill√© d'int√©gration.
    
    ========================================================================================
    üß™ √âTAPE 31 - TESTS MANUELS & CAS LIMITES
    ========================================================================================
    
    üéØ OBJECTIF : Robustesse minimale - Gestion des cas limites d'invitations
    
    üìã CAS LIMITES √Ä TESTER :
    
    1. INVITATION EXPIR√âE :
       - URL : project.html?id=PROJECT_ID&invite=EXPIRED_TOKEN
       - Comportement : Afficher banni√®re d'erreur "‚ùå Cette invitation a expir√©"
       - Action : Ne pas alt√©rer les donn√©es, proposer de demander une nouvelle invitation
    
    2. INVITATION D√âJ√Ä ACCEPT√âE :
       - URL : project.html?id=PROJECT_ID&invite=ACCEPTED_TOKEN
       - Comportement : Afficher message "‚úÖ Vous avez d√©j√† accept√© cette invitation"
       - Action : Rediriger vers le projet, ne pas alt√©rer les donn√©es
    
    3. UTILISATEUR D√âJ√Ä MEMBRE :
       - URL : project.html?id=PROJECT_ID&invite=ANY_TOKEN (utilisateur connect√© d√©j√† membre)
       - Comportement : Afficher message "‚ÑπÔ∏è Vous √™tes d√©j√† membre de ce projet"
       - Action : Rediriger vers le projet, ne pas alt√©rer les donn√©es
    
    4. INVITATION ANNUL√âE :
       - URL : project.html?id=PROJECT_ID&invite=CANCELLED_TOKEN
       - Comportement : Afficher banni√®re d'erreur "‚ùå Cette invitation a √©t√© annul√©e"
       - Action : Ne pas alt√©rer les donn√©es, proposer de contacter le propri√©taire
    
    üîß IMPL√âMENTATION :
    
    A. V√©rification du statut de l'invitation :
       - V√©rifier expiresAt vs Date.now()
       - V√©rifier status (pending, accepted, cancelled)
       - V√©rifier si l'utilisateur est d√©j√† membre du projet
    
    B. Messages adapt√©s :
       - Banni√®re d'erreur pour les cas d'erreur
       - Message d'info pour les cas normaux
       - Actions appropri√©es selon le contexte
    
    C. Protection des donn√©es :
       - Aucune modification des donn√©es pour les cas d'erreur
       - Logs informatifs pour le debugging
       - Gestion gracieuse des erreurs
    
    üéØ CRIT√àRES D'ACCEPTATION :
    - ‚úÖ Invitation expir√©e ‚Üí banni√®re d'erreur
    - ‚úÖ Invitation d√©j√† accept√©e ‚Üí message adapt√©
    - ‚úÖ Utilisateur d√©j√† membre ‚Üí message d'info
    - ‚úÖ Invitation annul√©e ‚Üí lien invalide
    - ‚úÖ Aucune alt√©ration des donn√©es pour les cas d'erreur
    - ‚úÖ Messages clairs et informatifs
    
    üìö DOCUMENTATION COMPL√àTE :
    Voir TEST-MANUELS-GUIDE.md pour les instructions d√©taill√©es de test.
    
    ========================================================================================
    -->
    
    <style>
        /* Styles pour la modal d'import CSV */
        .import-instructions {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .import-instructions h4 {
            margin: 0 0 12px 0;
            color: #495057;
            font-size: 16px;
        }
        
        .import-instructions ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .import-instructions li {
            margin: 4px 0;
            color: #6c757d;
        }
        
        .csv-example {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 12px;
            margin-top: 8px;
            font-family: monospace;
            font-size: 12px;
            color: #495057;
            overflow-x: auto;
        }
        
        .form-help {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }
        
        .import-result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }
        
        .result-header h3 {
            margin: 0 0 16px 0;
            color: #495057;
            font-size: 18px;
        }
        
        .import-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }
        
        .summary-label {
            font-size: 14px;
            color: #6c757d;
        }
        
        .summary-value {
            font-weight: 600;
            font-size: 16px;
        }
        
        .summary-value.success {
            color: #28a745;
        }
        
        .summary-value.info {
            color: #17a2b8;
        }
        
        .summary-value.error {
            color: #dc3545;
        }
        
        .import-details {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background: #ffffff;
        }
        
        .detail-item {
            padding: 8px 12px;
            border-bottom: 1px solid #f8f9fa;
            font-size: 14px;
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .detail-item.success {
            color: #28a745;
        }
        
        .detail-item.info {
            color: #17a2b8;
        }
        
        .detail-item.error {
            color: #dc3545;
        }

        /* Styles pour l'interface adaptative d'envoi d'e-mails */
        .mvp-instructions {
            margin-top: 20px;
        }

        .mvp-instructions .alert {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .mvp-instructions .alert h4 {
            color: #0c5460;
            margin: 0 0 12px 0;
            font-size: 16px;
        }

        .mvp-instructions .alert p {
            color: #0c5460;
            margin: 8px 0;
        }

        .mvp-instructions .alert ol {
            color: #0c5460;
            margin: 12px 0;
            padding-left: 20px;
        }

        .mvp-instructions .alert li {
            margin: 4px 0;
        }

        .email-template {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-top: 16px;
        }

        .email-template h5 {
            color: #495057;
            margin: 0 0 8px 0;
            font-size: 14px;
        }

        .template-content {
            font-family: monospace;
            font-size: 12px;
            color: #495057;
            line-height: 1.4;
        }

        .template-content p {
            margin: 4px 0;
        }

        .template-content strong {
            color: #212529;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
        }

        .success-message p {
            color: #155724;
            margin: 8px 0;
        }

        .success-message code {
            background: #c3e6cb;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        /* Mode adaptatif pour les boutons */
        .btn-adaptive {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-adaptive .btn-text {
            flex: 1;
        }

        .btn-adaptive .btn-icon {
            font-size: 16px;
        }

        /* Styles pour les banni√®res d'invitation (√âtape 31) */
        .invitation-banner {
            position: relative;
            margin: 0 0 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            animation: slideDown 0.3s ease-out;
        }

        .invitation-banner.error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .invitation-banner.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .invitation-banner.info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .banner-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
        }

        .banner-message {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .banner-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .banner-text {
            font-weight: 500;
            font-size: 16px;
        }

        .banner-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: inherit;
            opacity: 0.7;
            transition: opacity 0.3s;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .banner-close:hover {
            opacity: 1;
            background: rgba(0,0,0,0.1);
        }

        .banner-actions {
            padding: 0 20px 16px 20px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .banner-actions .btn {
            font-size: 14px;
            padding: 8px 16px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive pour les banni√®res */
        @media (max-width: 768px) {
            .banner-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .banner-close {
                align-self: flex-end;
                margin-top: -8px;
            }

            .banner-actions {
                flex-direction: column;
                width: 100%;
            }

            .banner-actions .btn {
                width: 100%;
            }
        }
    </style>
    
    <!-- 
    ‚ö†Ô∏è  LIMITES DE S√âCURIT√â DU MVP ‚ö†Ô∏è
    ========================================
    Cette page pr√©sente des contr√¥les d'acc√®s c√¥t√© front uniquement :
    
    1. CONTR√îLES D'ACC√àS NON S√âCURIS√âS :
       - Tous les contr√¥les de permissions sont c√¥t√© client
       - Facilement contournables via DevTools ou scripts
       - Pas de v√©rification c√¥t√© serveur
       - R√¥les et permissions modifiables c√¥t√© client
    
    2. VALIDATION C√îT√â CLIENT :
       - Validation des formulaires contournable
       - Pas de sanitisation des donn√©es
       - Vuln√©rable aux attaques XSS
       - Pas de protection CSRF
    
    3. GESTION DES DOCUMENTS :
       - Fichiers stock√©s en base64 dans localStorage
       - Pas de chiffrement des documents
       - Pas de contr√¥le d'acc√®s aux fichiers
       - Taille limit√©e par localStorage
    
    üîí RECOMMANDATIONS POUR LA PRODUCTION :
    ========================================
    - API REST avec authentification JWT
    - Contr√¥les d'acc√®s c√¥t√© serveur (middleware)
    - Validation et sanitisation serveur
    - Stockage s√©curis√© des fichiers (AWS S3, etc.)
    - Chiffrement des documents sensibles
    - Audit trail des acc√®s aux documents
    - Rate limiting sur les uploads
    - Protection contre les attaques XSS/CSRF
    ========================================
    -->
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <div class="logo-icon">
                    <img src="assets/logo-removebg-preview.png" alt="GECC Logo" style="width: 32px; height: 32px;">
                </div>
                <div class="logo-text">GECC PROJECT</div>
            </div>
            <nav class="nav">
                <a href="dashboard.html" class="nav-link">
                    Dashboard
                    <span id="dashboardNotificationBadge" class="notification-badge" style="display: none;">0</span>
                </a>
                <span class="nav-separator">|</span>
                <a href="projects.html" class="nav-link">Projets</a>
                <span class="nav-separator">|</span>
                <a href="profile.html" class="nav-link">Mon Profil</a>
                <span class="nav-separator">|</span>
                <a href="settings.html" class="nav-link">Param√®tres</a>
                <a href="admin.html" class="nav-link admin-link" id="adminLink" style="display: none;">üëë Administration</a>
            </nav>
            <div class="user-section">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">JD</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Jean Dupont</div>
                        <div class="user-role" id="userRole">Administrateur</div>
                    </div>
                </div>
                <a href="landing.html" class="logout-btn" id="logoutBtn">
                    <span>üè†</span>
                    Accueil
                </a>
            </div>
        </div>
    </header>
    <hr class="header-separator">

    <main class="main">
        <!-- Banni√®re d'invitation -->
        <div id="invitationBanner" class="invitation-banner" style="display: none;">
            <div class="invitation-banner-content">
                <div class="invitation-info">
                    <div class="invitation-icon">üéâ</div>
                    <div class="invitation-text">
                        <h3>Vous √™tes invit√© √† rejoindre ce projet</h3>
                        <p>En tant que <strong id="invitationRole"></strong></p>
                    </div>
                </div>
                <div class="invitation-actions">
                    <button id="acceptInvitationBtn" class="btn btn-success">
                        ‚úÖ Accepter
                    </button>
                    <button id="declineInvitationBtn" class="btn btn-cancel">
                        ‚ùå Refuser
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- En-t√™te du projet - Design Photo 2 -->
            <section class="project-header-new">
                <div class="project-card">
                    <!-- Identifiant du projet (badge violet) -->
                    <div class="project-identifier">
                        <div class="project-code-badge" id="projectCode">Nom du projet</div>
                    </div>
                    
                    <!-- Informations du projet en 3 colonnes -->
                    <div class="project-info-grid">
                        <div class="info-column">
                            <div class="info-label">CLIENT</div>
                            <div class="info-value client-value" id="projectClient">Non d√©fini</div>
                        </div>
                        
                        <div class="info-column">
                            <div class="info-label">STATUT</div>
                            <div class="info-value status-value" id="projectStatus">
                                <span class="status-icon">‚óè</span>
                                <span id="projectStatusText">Actif</span>
                            </div>
                        </div>
                        
                        <div class="info-column">
                            <div class="info-label">LOCALISATION</div>
                            <div class="info-value location-value" id="projectLocation">
                                <span>Non d√©finie</span>
                                <div class="progress-indicator">
                                    <div class="progress-bar-mini">
                                        <div class="progress-fill-mini" id="progressFillMini" style="width: 0%"></div>
                                    </div>
                                    <span class="progress-percentage" id="projectProgressText">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Boutons d'action en grille 2x2 -->
                    <div class="project-actions-grid">
                        <button id="printProjectBtn" class="btn btn-print">
                            <span class="btn-icon">üñ®Ô∏è</span>
                            <span class="btn-text">Imprimer</span>
                        </button>
                        
                        <button id="editProjectBtn" class="btn btn-edit">
                            <span class="btn-icon">‚úèÔ∏è</span>
                            <span class="btn-text">Modifier</span>
                        </button>
                        
                        <button id="deleteProjectBtn" class="btn btn-delete">
                            <span class="btn-icon">üóëÔ∏è</span>
                            <span class="btn-text">Supprimer</span>
                        </button>
                        
                        <button id="backToProjectsBtn" class="btn btn-back">
                            <span class="btn-icon">‚Üê</span>
                            <span class="btn-text">Retour aux projets</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Onglets de navigation -->
            <section class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-button active" data-tab="documents">
                        üìÑ Documents
                    </button>
                    <button class="tab-button" data-tab="tasks">
                        ‚úÖ T√¢ches
                    </button>
                    <button class="tab-button" data-tab="tracking">
                        üìä Suivi
                    </button>
                    <button class="tab-button" data-tab="members">
                        üë• Membres
                    </button>
                    <button class="tab-button" data-tab="exchanges">
                        üí¨ √âchanges
                    </button>
                    <button class="tab-button" data-tab="journal">
                        üìù Journal
                    </button>
                </div>

                <!-- Contenu des onglets -->
                <div class="tab-content active" id="documents-tab">
                    <div class="documents-header">
                        <h3 class="documents-title section-title">Documents du projet</h3>
                        <div class="documents-actions">
                            <button id="submitDocumentBtn" class="btn btn-primary">
                                <span>üìÑ</span>
                                Soumettre un document
                            </button>
                            <button id="downloadSelectedBtn" class="btn btn-info" style="display: none;">
                                <span>‚¨áÔ∏è</span>
                                T√©l√©charger s√©lectionn√©s
                            </button>
                            <button onclick="debugPermissions()" class="btn btn-secondary">
                                <span>üîç</span>
                                Debug Permissions
                            </button>
                        </div>
                    </div>
                    <div id="documentsTableContainer">
                        <div class="documents-table-container">
                            <div class="table-responsive">
                                <table class="documents-table" id="documentsTable">
                                    <thead>
                                        <tr>
                                            <th>
                                                <input type="checkbox" id="selectAllDocuments" title="S√©lectionner tout">
                                            </th>
                                            <th>Titre</th>
                                            <th>Type</th>
                                            <th>Destinataires</th>
                                            <th>√âtat</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                            <th>T√©l√©charger</th>
                                        </tr>
                                    </thead>
                                    <tbody id="documentsTableBody">
                                        <!-- Les documents seront charg√©s ici -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="documentsEmptyState" class="empty-state" style="display: none;">
                                <div class="empty-state-icon">üìÑ</div>
                                <h4>Aucun document</h4>
                                <p>Commencez par soumettre votre premier document.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tasks-tab">
                    <div class="tasks-header">
                        <h3 class="tasks-title">T√¢ches du projet</h3>
                        <div class="tasks-actions">
                            <button id="createTaskBtn" class="btn btn-primary">
                                <span>‚ûï</span>
                                Nouvelle t√¢che
                            </button>
                        </div>
                    </div>
                    
                    <div class="kanban-board" id="kanbanBoard">
                        <div class="kanban-column" data-status="todo">
                            <div class="kanban-column-header">
                                <h4>√Ä faire</h4>
                                <span class="task-count" id="todoCount">0</span>
                            </div>
                            <div class="kanban-column-content" id="todoColumn">
                                <!-- T√¢ches √† faire -->
                            </div>
                        </div>
                        
                        <div class="kanban-column" data-status="in_progress">
                            <div class="kanban-column-header">
                                <h4>En cours</h4>
                                <span class="task-count" id="inProgressCount">0</span>
                            </div>
                            <div class="kanban-column-content" id="inProgressColumn">
                                <!-- T√¢ches en cours -->
                            </div>
                        </div>
                        
                        <div class="kanban-column" data-status="review">
                            <div class="kanban-column-header">
                                <h4>En revue</h4>
                                <span class="task-count" id="reviewCount">0</span>
                            </div>
                            <div class="kanban-column-content" id="reviewColumn">
                                <!-- T√¢ches en revue -->
                            </div>
                        </div>
                        
                        <div class="kanban-column" data-status="done">
                            <div class="kanban-column-header">
                                <h4>Termin√©</h4>
                                <span class="task-count" id="completedCount">0</span>
                            </div>
                            <div class="kanban-column-content" id="completedColumn">
                                <!-- T√¢ches termin√©es -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tracking-tab">
                    <div class="tracking-header">
                        <h3 class="tracking-title">Suivi du projet</h3>
                    </div>
                    
                    <div class="tracking-content">
                        <!-- Section Avancement Global -->
                        <div class="tracking-section">
                            <div class="section-header">
                                <h4>Avancement global</h4>
                                <div class="progress-badge" id="progressBadge">
                                    <span id="progressValue">0</span>%
                                </div>
                            </div>
                            
                            <div class="progress-control">
                                <div class="progress-slider-container">
                                    <label for="progressSlider">Ajuster l'avancement :</label>
                                    <div class="slider-wrapper">
                                        <input type="range" id="progressSlider" min="0" max="100" value="0" class="progress-slider">
                                        <div class="slider-labels">
                                            <span>0%</span>
                                            <span>25%</span>
                                            <span>50%</span>
                                            <span>75%</span>
                                            <span>100%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="progress-bar-container">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                                    </div>
                                    <div class="progress-text">
                                        <span id="progressText">Projet en cours de d√©marrage</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section Statistiques -->
                        <div class="tracking-section">
                            <div class="section-header">
                                <h4>Statistiques du projet</h4>
                            </div>
                            
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon">üìÑ</div>
                                    <div class="stat-content">
                                        <div class="stat-number" id="documentsCount">0</div>
                                        <div class="stat-label">Documents</div>
                                    </div>
                                </div>
                                
                                <div class="stat-card">
                                    <div class="stat-icon">‚úÖ</div>
                                    <div class="stat-content">
                                        <div class="stat-number" id="tasksCount">0</div>
                                        <div class="stat-label">T√¢ches</div>
                                    </div>
                                </div>
                                
                                <div class="stat-card">
                                    <div class="stat-icon">üèÅ</div>
                                    <div class="stat-content">
                                        <div class="stat-number" id="completedTasksCount">0</div>
                                        <div class="stat-label">T√¢ches termin√©es</div>
                                    </div>
                                </div>
                                
                                <div class="stat-card">
                                    <div class="stat-icon">üìÖ</div>
                                    <div class="stat-content">
                                        <div class="stat-number" id="projectDuration">0</div>
                                        <div class="stat-label">Jours √©coul√©s</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Onglet Membres -->
                <div class="tab-content" id="members-tab">
                    <div class="members-header">
                        <h3 class="members-title section-title">Membres du projet</h3>
                        <div class="members-actions">
                            <button id="inviteMembersBtn" class="btn btn-primary">
                                <span>üë•</span>
                                Inviter des membres
                            </button>
                            <button id="importCsvBtn" class="btn btn-secondary">
                                <span>üìä</span>
                                Importer CSV
                            </button>
                        </div>
                    </div>
                    
                    <div class="members-content">
                        <!-- Propri√©taire du projet -->
                        <div class="project-owner-section">
                            <h4 class="section-subtitle">üëë Propri√©taire du projet</h4>
                            <div class="member-card owner-card" id="projectOwnerCard">
                                <div class="member-avatar">
                                    <span class="avatar-text" id="ownerInitials">--</span>
                                </div>
                                <div class="member-info">
                                    <div class="member-name" id="ownerName">Chargement...</div>
                                    <div class="member-email" id="ownerEmail">--</div>
                                    <div class="member-role owner-role">Propri√©taire</div>
                                </div>
                                <div class="member-status">
                                    <span class="status-badge owner-badge">üëë</span>
                                </div>
                            </div>
                        </div>

                        <!-- Liste des membres -->
                        <div class="project-members-section">
                            <h4 class="section-subtitle">üë• √âquipe du projet</h4>
                            <div class="members-list" id="membersList">
                                <!-- Les membres seront charg√©s dynamiquement -->
                            </div>
                            
                            <!-- √âtat vide -->
                            <div class="empty-state" id="membersEmptyState" style="display: none;">
                                <div class="empty-icon">üë•</div>
                                <h3>Aucun membre</h3>
                                <p>Ce projet n'a pas encore d'autres membres.</p>
                                <button class="btn btn-primary" onclick="document.getElementById('inviteMembersBtn').click()">
                                    Inviter des membres
                                </button>
                            </div>
                        </div>

                        <!-- Invitations en cours -->
                        <div class="project-invitations-section">
                            <h4 class="section-subtitle">üì® Invitations en cours</h4>
                            <div class="invitations-table-container">
                                <table class="invitations-table" id="invitationsTable">
                                    <thead>
                                        <tr>
                                            <th>Email</th>
                                            <th>R√¥le</th>
                                            <th>Statut</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invitationsTableBody">
                                        <!-- Les invitations seront charg√©es dynamiquement -->
                                    </tbody>
                                </table>
                                
                                <!-- √âtat vide pour les invitations -->
                                <div class="empty-state" id="invitationsEmptyState">
                                    <div class="empty-icon">üì®</div>
                                    <h3>Aucune invitation</h3>
                                    <p>Il n'y a pas d'invitations en cours pour ce projet.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="exchanges-tab">
                    <div class="exchanges-header">
                        <h3 class="exchanges-title">√âchanges et commentaires</h3>
                    </div>
                    
                    <div class="exchanges-content">
                        <!-- Formulaire de nouveau commentaire -->
                        <div class="comment-form-card">
                            <div class="comment-form-header">
                                <h4>üí¨ Nouveau commentaire</h4>
                            </div>
                            <form id="commentForm" class="comment-form">
                                <div class="form-group">
                                    <label for="commentText" class="form-label">VOTRE MESSAGE</label>
                                    <textarea id="commentText" name="text" rows="4" required 
                                              placeholder="Partagez vos observations, questions ou mises √† jour sur le projet..."></textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary btn-publish">
                                        <span>Publier le commentaire</span>
                                        <span class="btn-icon">‚Üí</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Liste des commentaires -->
                        <div class="comments-card">
                            <div class="comments-header">
                                <h4>üí¨ Commentaires du projet</h4>
                                <span id="commentsCount" class="comments-count">0 commentaires</span>
                            </div>
                            <div class="comments-divider"></div>
                            <div id="commentsList" class="comments-list">
                                <!-- Les commentaires seront charg√©s ici -->
                            </div>
                            <div id="commentsEmptyState" class="empty-state" style="display: none;">
                                <div class="empty-state-icon">üí¨</div>
                                <h4>Aucun commentaire</h4>
                                <p>Soyez le premier √† partager vos observations sur ce projet.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="journal-tab">
                    <div class="journal-header">
                        <h3 class="journal-title section-title">üìù Journal d'activit√©</h3>
                        <div class="journal-subtitle">Historique des actions et transitions</div>
                    </div>
                    
                    <div class="journal-content">
                        <!-- Carte des filtres -->
                        <div class="journal-filters-card">
                            <div class="journal-filters-header">
                                <h4>üîç Filtres et options</h4>
                                <span id="journalCount" class="journal-count">0 action(s)</span>
                            </div>
                            <div class="journal-filters-divider"></div>
                            <div class="journal-filters-content">
                                <div class="filter-group">
                                    <label for="journalFilter" class="filter-label">FILTRER PAR TYPE</label>
                                    <select id="journalFilter" class="filter-select">
                                        <option value="all">Toutes les actions</option>
                                        <option value="document">Documents</option>
                                        <option value="task">T√¢ches</option>
                                        <option value="comment">Commentaires</option>
                                        <option value="project">Projet</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Carte des actions -->
                        <div class="journal-actions-card">
                            <div class="journal-actions-header">
                                <h4>üìã Actions du projet</h4>
                            </div>
                            <div class="journal-actions-divider"></div>
                            <div class="journal-actions-list" id="journalList">
                                <!-- Les actions seront charg√©es ici -->
                            </div>
                            <div id="journalEmptyState" class="empty-state" style="display: none;">
                                <div class="empty-state-icon">üìù</div>
                                <h4>Aucune action enregistr√©e</h4>
                                <p>Les actions effectu√©es sur le projet appara√Ætront ici.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modale de soumission de document -->
    <div id="submitDocumentModal" class="modal document-modal" style="display: none !important;">
        <div class="modal-content document-modal-content">
            <div class="form-container">
                <h1 class="form-title">üìÑ Soumettre un Document</h1>
                
                <form id="submitDocumentForm">
                        <div class="form-group">
                            <label class="form-label" for="documentTitle">Titre du document *</label>
                            <input type="text" id="documentTitle" name="title" class="form-input" required 
                                   placeholder="Ex: Plan architectural - Niveau RDC"
                                   aria-describedby="documentTitleHelp"
                                   aria-required="true">
                            <div id="documentTitleHelp" class="form-help">Titre descriptif du document √† soumettre</div>
                        </div>

                    <div class="form-group">
                        <label class="form-label" for="documentType">Type de document *</label>
                        <select id="documentType" name="type" class="form-select" required
                                aria-describedby="documentTypeHelp"
                                aria-required="true">
                            <option value="">S√©lectionner un type</option>
                            
                            <!-- Plans et dessins -->
                            <optgroup label="üìê Plans et dessins">
                                <option value="plan_architectural">Plan architectural</option>
                                <option value="plan_technique">Plan technique</option>
                                <option value="plan_execution">Plan d'ex√©cution</option>
                                <option value="plan_structure">Plan de structure</option>
                                <option value="plan_vrd">Plan VRD</option>
                                <option value="plan_electrique">Plan √©lectrique</option>
                                <option value="plan_plomberie">Plan plomberie</option>
                                <option value="plan_cvc">Plan CVC</option>
                                <option value="plan_securite">Plan de s√©curit√©</option>
                            </optgroup>
                            
                            <!-- Rapports et √©tudes -->
                            <optgroup label="üìä Rapports et √©tudes">
                                <option value="rapport_controle">Rapport de contr√¥le</option>
                                <option value="rapport_technique">Rapport technique</option>
                                <option value="rapport_geotechnique">Rapport g√©otechnique</option>
                                <option value="rapport_acoustique">Rapport acoustique</option>
                                <option value="rapport_thermique">Rapport thermique</option>
                                <option value="rapport_structure">Rapport de structure</option>
                                <option value="rapport_electrique">Rapport √©lectrique</option>
                                <option value="rapport_plomberie">Rapport plomberie</option>
                                <option value="rapport_cvc">Rapport CVC</option>
                                <option value="rapport_securite">Rapport de s√©curit√©</option>
                                <option value="rapport_environnemental">Rapport environnemental</option>
                            </optgroup>
                            
                            <!-- Proc√®s-verbaux et attestations -->
                            <optgroup label="üìã Proc√®s-verbaux et attestations">
                                <option value="pv_reception">PV de r√©ception</option>
                                <option value="pv_controle">PV de contr√¥le</option>
                                <option value="pv_verification">PV de v√©rification</option>
                                <option value="pv_essai">PV d'essai</option>
                                <option value="pv_reunion">PV de r√©union</option>
                                <option value="attestation_controle">Attestation de contr√¥le</option>
                                <option value="attestation_suivi">Attestation de suivi</option>
                                <option value="attestation_conformite">Attestation de conformit√©</option>
                                <option value="attestation_qualite">Attestation de qualit√©</option>
                                <option value="attestation_securite">Attestation de s√©curit√©</option>
                            </optgroup>
                            
                            <!-- Cahiers des charges et sp√©cifications -->
                            <optgroup label="üìù Cahiers des charges et sp√©cifications">
                                <option value="cahier_charges">Cahier des charges</option>
                                <option value="cahier_clauses_techniques">Cahier des clauses techniques</option>
                                <option value="cahier_clauses_particulieres">Cahier des clauses particuli√®res</option>
                                <option value="specifications_techniques">Sp√©cifications techniques</option>
                                <option value="specifications_materiaux">Sp√©cifications mat√©riaux</option>
                            </optgroup>
                            
                            <!-- Contrats et documents administratifs -->
                            <optgroup label="üìÑ Contrats et documents administratifs">
                                <option value="contrat_travaux">Contrat de travaux</option>
                                <option value="marche_public">March√© public</option>
                                <option value="devis">Devis</option>
                                <option value="facture">Facture</option>
                                <option value="bon_commande">Bon de commande</option>
                                <option value="bon_livraison">Bon de livraison</option>
                            </optgroup>
                            
                            <!-- Permis et autorisations -->
                            <optgroup label="üèõÔ∏è Permis et autorisations">
                                <option value="permis_construire">Permis de construire</option>
                                <option value="permis_amenager">Permis d'am√©nager</option>
                                <option value="autorisation_travaux">Autorisation de travaux</option>
                                <option value="declaration_travaux">D√©claration de travaux</option>
                                <option value="autorisation_environnementale">Autorisation environnementale</option>
                            </optgroup>
                            
                            <!-- Photos et m√©dias -->
                            <optgroup label="üì∏ Photos et m√©dias">
                                <option value="photo_avant">Photo avant travaux</option>
                                <option value="photo_pendant">Photo pendant travaux</option>
                                <option value="photo_apres">Photo apr√®s travaux</option>
                                <option value="video_suivi">Vid√©o de suivi</option>
                                <option value="schema">Sch√©ma</option>
                                <option value="diagramme">Diagramme</option>
                            </optgroup>
                            
                            <!-- Autres documents -->
                            <optgroup label="üìö Autres documents">
                                <option value="note_calcul">Note de calcul</option>
                                <option value="fiche_technique">Fiche technique</option>
                                <option value="mode_operatoire">Mode op√©ratoire</option>
                                <option value="plan_secours">Plan de secours</option>
                                <option value="reglement_interieur">R√®glement int√©rieur</option>
                                <option value="autre">Autre</option>
                            </optgroup>
                        </select>
                        <div id="documentTypeHelp" class="form-help">Cat√©gorie du document selon sa nature</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="documentFile">Fichier du document *</label>
                        <div class="file-upload-container">
                            <input type="file" id="documentFile" name="file" class="file-upload-input" 
                                   accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.dwg,.xlsx,.xls" required
                                   aria-describedby="documentFileHelp"
                                   aria-required="true">
                            <label for="documentFile" class="file-upload-label">
                                <span class="file-upload-icon" aria-hidden="true">üìé</span>
                                <span>Choisir un fichier ou glisser-d√©poser</span>
                            </label>
                        </div>
                        <div id="documentFileHelp" class="form-help">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG, DWG, XLSX</div>
                    </div>

                    <div class="form-group">
                        <fieldset>
                            <legend class="form-label">Destinataires (r√¥les) *</legend>
                            <div class="checkbox-group" role="group" aria-labelledby="targetRolesLegend">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="moa" name="targetRoles" value="moa" class="checkbox-input">
                                    <label for="moa" class="checkbox-label">
                                        <span aria-hidden="true">üë§</span> Ma√Ætre d'ouvrage
                                    </label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="architect" name="targetRoles" value="architect" class="checkbox-input">
                                    <label for="architect" class="checkbox-label">
                                        <span aria-hidden="true">üèõÔ∏è</span> Architecte
                                    </label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="bet" name="targetRoles" value="bet" class="checkbox-input">
                                    <label for="bet" class="checkbox-label">
                                        <span aria-hidden="true">‚öôÔ∏è</span> BET (Bureau d'√âtudes Techniques)
                                    </label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="bct" name="targetRoles" value="bct" class="checkbox-input">
                                    <label for="bct" class="checkbox-label">
                                        <span aria-hidden="true">üèóÔ∏è</span> BCT (Bureau de Contr√¥le Technique)
                                    </label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="entreprise" name="targetRoles" value="entreprise" class="checkbox-input">
                                    <label for="entreprise" class="checkbox-label">
                                        <span aria-hidden="true">üè¢</span> Entreprise
                                    </label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="urbanisme" name="targetRoles" value="urbanisme" class="checkbox-input">
                                    <label for="urbanisme" class="checkbox-label">
                                        <span aria-hidden="true">üèôÔ∏è</span> Services d'urbanisme
                                    </label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="mairie" name="targetRoles" value="mairie" class="checkbox-input">
                                    <label for="mairie" class="checkbox-label">
                                        <span aria-hidden="true">üèòÔ∏è</span> Mairie/Commune
                                    </label>
                                </div>
                            </div>
                        </fieldset>
                        <div class="form-help">S√©lectionnez au moins un destinataire pour le document</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="externalUrl">Lien URL (facultatif)</label>
                        <input type="url" id="externalUrl" name="externalUrl" class="form-input" 
                               placeholder="https://exemple.com/document"
                               aria-describedby="externalUrlHelp">
                        <div id="externalUrlHelp" class="form-help">Lien vers un document externe ou une ressource en ligne</div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-cancel" id="cancelDocumentBtn"
                                aria-label="Annuler la soumission du document">
                            <span aria-hidden="true">‚úï</span> Annuler
                        </button>
                        <button type="submit" class="btn btn-submit" id="createDocumentBtn"
                                aria-label="Soumettre le document">
                            <span aria-hidden="true">‚úì</span> Soumettre
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modale de cr√©ation de t√¢che -->
    <div id="createTaskModal" class="modal" style="display: none !important;">
        <div class="modal-content task-modal-content">
            <div class="form-container">
                <div class="task-icon">üìã</div>
                <h1 class="form-title">Nouvelle T√¢che</h1>
                
                <form id="createTaskForm">
                    <div class="form-group">
                        <label class="form-label" for="taskTitle">
                            Titre de la t√¢che <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="taskTitle" 
                            class="form-input" 
                            placeholder="Ex: R√©viser les plans architecturaux"
                            required
                        >
                        <div class="validation-message" id="title-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="taskDescription">
                            Description (facultatif)
                        </label>
                        <textarea 
                            id="taskDescription" 
                            class="form-input" 
                            placeholder="Description d√©taill√©e de la t√¢che..."
                            rows="3"
                        ></textarea>
                        <div class="validation-message" id="description-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="taskAssignee">
                            Responsable <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="taskAssignee" 
                            class="form-input" 
                            placeholder="Ex: Marie Dubois"
                            required
                        >
                        <div class="form-hint">Nom de la personne responsable de cette t√¢che</div>
                        <div class="validation-message" id="assignee-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="taskDueDate">
                            Date limite
                        </label>
                        <input 
                            type="date" 
                            id="taskDueDate" 
                            class="form-input"
                        >
                        <div class="form-hint">Date d'√©ch√©ance de la t√¢che (facultatif)</div>
                        <div class="validation-message" id="duedate-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="taskPriority">
                            Priorit√©
                        </label>
                        <select id="taskPriority" class="form-select">
                            <option value="low">Faible</option>
                            <option value="medium" selected>Moyenne</option>
                            <option value="high">√âlev√©e</option>
                            <option value="urgent">Urgente</option>
                        </select>
                        <div class="validation-message" id="priority-message"></div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-cancel" id="cancelTaskBtn">
                            ‚úï Annuler
                        </button>
                        <button type="button" class="btn btn-save" id="submitTaskBtn">
                            üíæ Cr√©er la t√¢che
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modale de modification de t√¢che -->
    <div id="editTaskModal" class="modal" style="display: none !important;">
        <div class="modal-content task-modal-content">
            <div class="form-container">
                <div class="task-icon">‚úèÔ∏è</div>
                <h1 class="form-title">Modifier la T√¢che</h1>
                
                <form id="editTaskForm">
                    <div class="form-group">
                        <label class="form-label" for="editTaskTitle">
                            Titre de la t√¢che <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="editTaskTitle" 
                            class="form-input" 
                            placeholder="Ex: R√©viser les plans architecturaux"
                            required
                        >
                        <div class="validation-message" id="edit-title-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editTaskDescription">
                            Description (facultatif)
                        </label>
                        <textarea 
                            id="editTaskDescription" 
                            class="form-input" 
                            placeholder="Description d√©taill√©e de la t√¢che..."
                            rows="3"
                        ></textarea>
                        <div class="validation-message" id="edit-description-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editTaskAssignee">
                            Responsable <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="editTaskAssignee" 
                            class="form-input" 
                            placeholder="Ex: Marie Dubois"
                            required
                        >
                        <div class="form-hint">Nom de la personne responsable de cette t√¢che</div>
                        <div class="validation-message" id="edit-assignee-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editTaskDueDate">
                            Date limite
                        </label>
                        <input 
                            type="date" 
                            id="editTaskDueDate" 
                            class="form-input"
                        >
                        <div class="form-hint">Date d'√©ch√©ance de la t√¢che (facultatif)</div>
                        <div class="validation-message" id="edit-duedate-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editTaskPriority">
                            Priorit√©
                        </label>
                        <select id="editTaskPriority" class="form-select">
                            <option value="low">Faible</option>
                            <option value="medium">Moyenne</option>
                            <option value="high">√âlev√©e</option>
                            <option value="urgent">Urgente</option>
                        </select>
                        <div class="validation-message" id="edit-priority-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editTaskStatus">
                            Statut
                        </label>
                        <select id="editTaskStatus" class="form-select">
                            <option value="todo">√Ä faire</option>
                            <option value="in_progress">En cours</option>
                            <option value="review">En revue</option>
                            <option value="done">Termin√©</option>
                        </select>
                        <div class="validation-message" id="edit-status-message"></div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-cancel" id="cancelEditTaskBtn">
                            ‚úï Annuler
                        </button>
                        <button type="button" class="btn btn-save" id="submitEditTaskBtn">
                            üíæ Modifier la t√¢che
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modale d'invitation de membres -->
    <div id="inviteMembersModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üë• Inviter des membres</h2>
                <button type="button" class="modal-close" id="closeInviteModal">√ó</button>
            </div>
            
            <div class="modal-body">
                <form id="inviteMembersForm">
                    <div class="form-group">
                        <label for="inviteEmail" class="form-label">EMAIL</label>
                        <input type="email" id="inviteEmail" name="email" class="form-input" 
                               placeholder="exemple@entreprise.fr" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteRole" class="form-label">R√îLE PROPOS√â</label>
                        <select id="inviteRole" name="role" class="form-select" required>
                            <option value="">S√©lectionner un r√¥le</option>
                            <option value="architect">üèóÔ∏è Architecte</option>
                            <option value="bct">üîç Bureau de Contr√¥le (BCT)</option>
                            <option value="bet">üìê Bureau d'√âtudes (BET)</option>
                            <option value="contractor">üë∑ Entrepreneur</option>
                            <option value="admin">‚öôÔ∏è Administrateur</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">TYPE D'INVITATION</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="inviteType" value="email" checked>
                                <span class="radio-label">
                                    <strong>üìß Inviter par e-mail</strong>
                                    <small>Envoie un lien d'invitation par e-mail</small>
                                </span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="inviteType" value="link">
                                <span class="radio-label">
                                    <strong>üîó G√©n√©rer un lien d'acc√®s</strong>
                                    <small>Cr√©e un lien public pour rejoindre le projet</small>
                                </span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="inviteMessage" class="form-label">MESSAGE PERSONNALIS√â (OPTIONNEL)</label>
                        <textarea id="inviteMessage" name="message" class="form-textarea" rows="3"
                                  placeholder="Ajoutez un message personnalis√© √† votre invitation..."></textarea>
                    </div>
                </form>
                
                <!-- Mode MVP - Instructions pour envoi manuel -->
                <div id="mvpInstructions" class="mvp-instructions" style="display: none;">
                    <div class="alert alert-info">
                        <h4>üìã Instructions pour l'envoi manuel</h4>
                        <p>Le lien d'invitation a √©t√© copi√© dans votre presse-papiers.</p>
                        <p><strong>√âtapes pour envoyer l'invitation :</strong></p>
                        <ol>
                            <li>Ouvrez votre client e-mail (Gmail, Outlook, etc.)</li>
                            <li>Cr√©ez un nouveau message</li>
                            <li>Collez le lien dans le corps du message</li>
                            <li>Ajoutez un message personnalis√© si n√©cessaire</li>
                            <li>Envoyez l'e-mail</li>
                        </ol>
                        <div class="email-template">
                            <h5>üí° Template d'e-mail sugg√©r√© :</h5>
                            <div class="template-content">
                                <p><strong>Objet :</strong> Invitation au projet [NOM_DU_PROJET] - GECC Project</p>
                                <p><strong>Message :</strong></p>
                                <p>Bonjour,</p>
                                <p>Vous √™tes invit√©(e) √† rejoindre le projet <strong>[NOM_DU_PROJET]</strong> en tant que <strong>[R√îLE]</strong>.</p>
                                <p>Cliquez sur le lien ci-dessous pour accepter l'invitation :</p>
                                <p><strong>[LIEN_D_INVITATION]</strong></p>
                                <p>Cordialement,<br>[VOTRE_NOM]</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- R√©sultat de l'invitation -->
                <div id="inviteResult" class="invite-result" style="display: none;">
                    <div class="result-header">
                        <h3 id="resultTitle">‚úÖ Invitation cr√©√©e avec succ√®s</h3>
                    </div>
                    <div class="result-content">
                        <!-- Mode Backend - E-mail envoy√© -->
                        <div id="backendResult" style="display: none;">
                            <div class="success-message">
                                <p>üìß <strong>E-mail envoy√© avec succ√®s !</strong></p>
                                <p>L'invitation a √©t√© envoy√©e automatiquement √† <span id="resultEmail"></span></p>
                                <p>ID du message : <code id="messageId"></code></p>
                            </div>
                        </div>
                        
                        <!-- Mode MVP - Lien √† copier -->
                        <div id="mvpResult">
                            <div class="invite-link-container">
                                <label class="form-label">LIEN D'INVITATION</label>
                                <div class="link-input-group">
                                    <input type="text" id="generatedInviteLink" class="form-input link-input" readonly>
                                    <button type="button" id="copyInviteLink" class="btn btn-secondary">
                                        üìã Copier le lien
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="invite-info">
                            <p><strong>Email :</strong> <span id="resultEmail"></span></p>
                            <p><strong>R√¥le :</strong> <span id="resultRole"></span></p>
                            <p><strong>Expire le :</strong> <span id="resultExpiry"></span></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" id="cancelInviteBtn">Annuler</button>
                <button type="button" class="btn btn-primary" id="createInviteBtn">
                    <span id="createInviteText">üöÄ Cr√©er l'invitation</span>
                    <span id="createInviteIcon">üìß</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modale d'import CSV -->
    <div id="importCsvModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìä Importer des membres via CSV</h2>
                <button type="button" class="modal-close" id="closeImportCsvModal">√ó</button>
            </div>
            
            <div class="modal-body">
                <div class="import-instructions">
                    <h4>üìã Instructions</h4>
                    <p>Votre fichier CSV doit contenir les colonnes suivantes :</p>
                    <ul>
                        <li><strong>name</strong> : Nom complet de la personne</li>
                        <li><strong>email</strong> : Adresse e-mail</li>
                        <li><strong>roleInProject</strong> : R√¥le dans le projet (architect, bct, bet, contractor, admin)</li>
                    </ul>
                    <p><strong>Exemple :</strong></p>
                    <div class="csv-example">
                        <code>
                            name,email,roleInProject<br>
                            Jean Dupont,jean.dupont@entreprise.fr,architect<br>
                            Marie Martin,marie.martin@bct.fr,bct<br>
                            Pierre Durand,pierre.durand@bet.fr,bet
                        </code>
                    </div>
                </div>
                
                <form id="importCsvForm">
                    <div class="form-group">
                        <label for="csvFile" class="form-label">FICHIER CSV</label>
                        <input type="file" id="csvFile" name="csvFile" class="form-input" 
                               accept=".csv" required>
                        <div class="form-help">S√©lectionnez un fichier CSV avec les colonnes name, email, roleInProject</div>
                    </div>
                </form>
                
                <!-- R√©sultat de l'import -->
                <div id="importResult" class="import-result" style="display: none;">
                    <div class="result-header">
                        <h3>üìä R√©sultat de l'import</h3>
                    </div>
                    <div class="result-content">
                        <div class="import-summary">
                            <div class="summary-item">
                                <span class="summary-label">Total trait√© :</span>
                                <span class="summary-value" id="totalProcessed">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Membres ajout√©s :</span>
                                <span class="summary-value success" id="membersAdded">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Invitations cr√©√©es :</span>
                                <span class="summary-value info" id="invitationsCreated">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Erreurs :</span>
                                <span class="summary-value error" id="errorsCount">0</span>
                            </div>
                        </div>
                        
                        <div class="import-details" id="importDetails">
                            <!-- D√©tails de l'import -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" id="cancelImportCsvBtn">Annuler</button>
                <button type="button" class="btn btn-primary" id="processCsvBtn" disabled>
                    üìä Traiter le fichier
                </button>
            </div>
        </div>
    </div>

    <!-- Modale de modification de projet -->
    <div id="editProjectModal" class="modal" style="display: none !important;">
        <div class="modal-content">
            <div class="form-container">
                <div class="form-icon">‚úèÔ∏è</div>
                <h1 class="form-title">Modifier le Projet</h1>
                
                <form id="editProjectForm">
                    <div class="form-group">
                        <label class="form-label" for="editProjectName">
                            Nom du projet <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="editProjectName" 
                            class="form-input" 
                            placeholder="Ex: R√©sidence Les Jardins du Marais"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editProjectClient">
                            Client du projet <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="editProjectClient" 
                            class="form-input" 
                            placeholder="Ex: Promoteur Immobilier ABC"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editProjectDescription">
                            Description du projet
                        </label>
                        <textarea 
                            id="editProjectDescription" 
                            class="form-textarea" 
                            rows="4"
                            placeholder="D√©crivez les d√©tails du projet..."
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editProjectLocation">
                            Localisation du projet
                        </label>
                        <input 
                            type="text" 
                            id="editProjectLocation" 
                            class="form-input" 
                            placeholder="Ex: Paris 3√®me, 15 rue du Temple"
                        >
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-cancel" id="cancelEditProjectBtn">
                            ‚úï Annuler
                        </button>
                        <button type="button" class="btn btn-save" id="submitEditProjectBtn">
                            üíæ Modifier le projet
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="./js/store.js"></script>
    <script src="./js/header-utils.js"></script>
    <script>
        // Scripts charg√©s directement sans modules ES6

        // Plus de v√©rification d'authentification n√©cessaire

        // V√©rification automatique des m√©thodes d'invitation
        function checkInviteMethods() {
            const requiredMethods = ['createInvite', 'listInvites', 'acceptInvite', 'cancelInvite', 'getInviteByToken', 'cleanupExpiredInvites'];
            const missingMethods = requiredMethods.filter(method => typeof localRepository[method] !== 'function');
            
            if (missingMethods.length > 0) {
                console.warn('‚ö†Ô∏è M√©thodes d\'invitation manquantes:', missingMethods);
                console.log('üîÑ Rechargement de la page recommand√© (Ctrl+F5)');
                return false;
            } else {
                console.log('‚úÖ Toutes les m√©thodes d\'invitation sont disponibles');
                return true;
            }
        }

        // V√©rifier les m√©thodes au d√©marrage
        if (!checkInviteMethods()) {
            // Rechargement automatique avec cache-busting
            console.log('üîÑ Rechargement automatique avec cache-busting...');
            setTimeout(() => {
                // Incr√©menter le num√©ro de version pour forcer le rechargement
                const currentUrl = new URL(window.location);
                const currentVersion = currentUrl.searchParams.get('v') || '1';
                const newVersion = parseInt(currentVersion) + 1;
                currentUrl.searchParams.set('v', newVersion);
                window.location.href = currentUrl.toString();
            }, 2000);
        }

        // Variables globales
        let currentProject = null;

        // Fonction utilitaire pour obtenir le r√¥le de l'utilisateur dans le projet actuel
        function getCurrentUserRoleInProject() {
            if (!currentProject) return null;
            const currentUser = localRepository.getCurrentUser();
            if (!currentUser) return null;
            
            // Utiliser le nouveau mod√®le Project pour obtenir le r√¥le effectif
            return currentProject.getEffectiveRole(currentUser.id, currentUser.role);
        }

        // Fonction pour v√©rifier si l'utilisateur courant est membre du projet
        function isCurrentUserProjectMember() {
            const currentUser = localRepository.getCurrentUser();
            if (!currentUser) return false;
            
            // TOUS les utilisateurs connect√©s sont consid√©r√©s comme membres
            return true;
        }

        // Fonction pour afficher l'alerte de non-membre
        function showNonMemberAlert() {
            const currentUser = localRepository.getCurrentUser();
            if (!currentUser) return;
            
            alert(`üö´ Vous n'√™tes pas membre de ce projet.\n\nDemandez une invitation au propri√©taire du projet pour pouvoir participer aux actions.`);
        }

        // Fonction pour masquer/afficher les actions selon l'appartenance au projet
        function updateUIPermissions() {
            const isMember = isCurrentUserProjectMember();
            
            if (!isMember) {
                console.log('üîí Utilisateur non-membre d√©tect√©, masquage des actions');
                hideNonMemberActions();
            } else {
                console.log('‚úÖ Utilisateur membre, affichage des actions');
                showMemberActions();
            }
        }

        // Masquer les actions pour les non-membres
        function hideNonMemberActions() {
            // Afficher l'alerte de non-membre
            showNonMemberAlert();
            
            // Masquer les boutons d'action dans les documents
            const documentActions = document.querySelectorAll('.document-actions button');
            documentActions.forEach(btn => {
                if (btn.textContent.includes('Soumettre') || 
                    btn.textContent.includes('R√©viser') || 
                    btn.textContent.includes('Viser') ||
                    btn.textContent.includes('Approuver') ||
                    btn.textContent.includes('Refuser') ||
                    btn.textContent.includes('Observations')) {
                    btn.style.display = 'none';
                }
            });

            // Masquer le bouton "Nouvelle t√¢che"
            const newTaskBtn = document.getElementById('newTaskBtn');
            if (newTaskBtn) {
                newTaskBtn.style.display = 'none';
            }

            // D√©sactiver le drag & drop des t√¢ches
            const taskItems = document.querySelectorAll('.task-item');
            taskItems.forEach(item => {
                item.draggable = false;
                item.style.cursor = 'default';
                item.style.opacity = '0.7';
            });

            // Masquer les boutons d'action dans les t√¢ches
            const taskActions = document.querySelectorAll('.task-actions button');
            taskActions.forEach(btn => {
                btn.style.display = 'none';
            });

            // Rendre l'onglet √âchanges en lecture seule
            const commentForm = document.getElementById('commentForm');
            if (commentForm) {
                commentForm.style.display = 'none';
            }

            const commentInput = document.getElementById('commentInput');
            if (commentInput) {
                commentInput.disabled = true;
                commentInput.placeholder = 'Vous devez √™tre membre du projet pour commenter';
            }

            // Masquer les boutons de suppression de commentaires
            const deleteCommentBtns = document.querySelectorAll('.delete-comment-btn');
            deleteCommentBtns.forEach(btn => {
                btn.style.display = 'none';
            });
        }

        // Afficher les actions pour les membres
        function showMemberActions() {
            // Afficher les boutons d'action dans les documents
            const documentActions = document.querySelectorAll('.document-actions button');
            documentActions.forEach(btn => {
                btn.style.display = '';
            });

            // Afficher le bouton "Nouvelle t√¢che"
            const newTaskBtn = document.getElementById('newTaskBtn');
            if (newTaskBtn) {
                newTaskBtn.style.display = '';
            }

            // R√©activer le drag & drop des t√¢ches
            const taskItems = document.querySelectorAll('.task-item');
            taskItems.forEach(item => {
                item.draggable = true;
                item.style.cursor = 'move';
                item.style.opacity = '1';
            });

            // Afficher les boutons d'action dans les t√¢ches
            const taskActions = document.querySelectorAll('.task-actions button');
            taskActions.forEach(btn => {
                btn.style.display = '';
            });

            // R√©activer l'onglet √âchanges
            const commentForm = document.getElementById('commentForm');
            if (commentForm) {
                commentForm.style.display = '';
            }

            const commentInput = document.getElementById('commentInput');
            if (commentInput) {
                commentInput.disabled = false;
                commentInput.placeholder = 'Ajouter un commentaire...';
            }

            // Afficher les boutons de suppression de commentaires
            const deleteCommentBtns = document.querySelectorAll('.delete-comment-btn');
            deleteCommentBtns.forEach(btn => {
                btn.style.display = '';
            });
        }

        // Initialiser la page
        function init() {
            console.log('üöÄ Initialisation de la page projet...');
            
            // D√©tecter le mode backend pour l'envoi d'e-mails
            detectBackendMode();
            
            // R√©cup√©rer l'ID du projet et le token d'invitation depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            const inviteToken = urlParams.get('invite');
            
            // V√©rifier s'il y a un token d'invitation
            if (inviteToken) {
                console.log('üéâ Token d\'invitation d√©tect√©:', inviteToken);
                handleInvitationFlow(inviteToken, projectId);
                return;
            }
            
            // Plus de v√©rification d'authentification n√©cessaire
            
            // Forcer la fermeture de toutes les modales au chargement
            const allModals = document.querySelectorAll('.modal');
            allModals.forEach(modal => {
                modal.classList.remove('open');
                modal.style.display = 'none'; // Force la fermeture
            });
            
            // Mettre √† jour le header (g√©r√© automatiquement par header-utils.js)
            
            // Charger les d√©tails du projet
            loadProjectDetails();
            
            // Configurer les onglets
            setupTabs();
            
            // Configurer les √©v√©nements
            setupEventListeners();
            
            // Charger le tableau des documents
            loadDocumentsTable();
            
            // Charger le tableau Kanban
            loadKanbanBoard();
            
            // Charger l'onglet de suivi
            loadTrackingTab();
            
            // Charger l'onglet membres
            loadMembersTab();
            
            // Mettre √† jour les permissions UI selon l'appartenance au projet
            updateUIPermissions();
            
            // Charger l'onglet d'√©changes
            loadExchangesTab();
            
            // Charger l'onglet de journal
            loadJournalTab();
            
            // Configurer les animations de la modal de document
            setupDocumentModalAnimations();
            
            // Ajouter les fonctions de test au scope global pour debug
            window.debugPermissions = debugPermissions;
            window.testPermissions = testPermissions;
            
            // Ajouter les fonctions de gestion des t√¢ches au scope global
            window.editTask = editTask;
            window.deleteTask = deleteTask;
            
            // Configurer la navigation clavier
            setupKeyboardNavigation();
            
            console.log('‚úÖ Page projet initialis√©e');
            console.log('üîê Fonctions de test disponibles: debugPermissions(), testPermissions()');
        }

        // ========================================
        // NAVIGATION CLAVIER POUR ACCESSIBILIT√â
        // ========================================

        function setupKeyboardNavigation() {
            // Navigation par onglets avec les fl√®ches
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach((button, index) => {
                button.addEventListener('keydown', (e) => {
                    let targetIndex = index;
                    
                    switch(e.key) {
                        case 'ArrowRight':
                        case 'ArrowDown':
                            e.preventDefault();
                            targetIndex = (index + 1) % tabButtons.length;
                            break;
                        case 'ArrowLeft':
                        case 'ArrowUp':
                            e.preventDefault();
                            targetIndex = (index - 1 + tabButtons.length) % tabButtons.length;
                            break;
                        case 'Home':
                            e.preventDefault();
                            targetIndex = 0;
                            break;
                        case 'End':
                            e.preventDefault();
                            targetIndex = tabButtons.length - 1;
                            break;
                    }
                    
                    if (targetIndex !== index) {
                        tabButtons[targetIndex].focus();
                        tabButtons[targetIndex].click();
                    }
                });
            });

            // Fermeture de modal avec Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal.open');
                    if (openModal) {
                        if (openModal.id === 'submitDocumentModal') {
                            closeDocumentModal();
                        } else if (openModal.id === 'createTaskModal') {
                            closeTaskModal();
                        }
                    }
                }
            });

            // Navigation dans les formulaires
            const formInputs = document.querySelectorAll('input, select, textarea, button');
            formInputs.forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && input.type === 'button') {
                        e.preventDefault();
                        input.click();
                    }
                });
            });

            console.log('‚å®Ô∏è Navigation clavier configur√©e');
        }

        // Ajouter les animations et effets √† la modal de document
        function setupDocumentModalAnimations() {
            // Animation au changement de fichier
            const fileInput = document.getElementById('documentFile');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const label = document.querySelector('.file-upload-label span:last-child');
                    if (e.target.files.length > 0) {
                        label.textContent = `üìÅ ${e.target.files[0].name}`;
                        label.parentElement.style.borderColor = '#667eea';
                        label.parentElement.style.background = 'rgba(102, 126, 234, 0.1)';
                    }
                });
            }

            // Effet de ripple sur les boutons
            document.querySelectorAll('.document-modal .btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const rect = button.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    ripple.style.position = 'absolute';
                    ripple.style.borderRadius = '50%';
                    ripple.style.background = 'rgba(255, 255, 255, 0.3)';
                    ripple.style.transform = 'scale(0)';
                    ripple.style.animation = 'ripple 0.6s linear';
                    ripple.style.pointerEvents = 'none';
                    
                    button.appendChild(ripple);
                    setTimeout(() => ripple.remove(), 600);
                });
            });
        }

        // Configurer les √©v√©nements
        function setupEventListeners() {
            // Bouton d'accueil
            const homeBtn = document.getElementById('logoutBtn');
            if (homeBtn) {
                // Le lien redirigera naturellement vers landing.html
            }

            // Bouton d'invitation de membres
            const inviteMembersBtn = document.getElementById('inviteMembersBtn');
            if (inviteMembersBtn) {
                inviteMembersBtn.addEventListener('click', () => {
                    showInviteMembersModal();
                });
            }

            // Gestionnaires pour la modale d'invitation
            const closeInviteModal = document.getElementById('closeInviteModal');
            const cancelInviteBtn = document.getElementById('cancelInviteBtn');
            const createInviteBtn = document.getElementById('createInviteBtn');
            const copyInviteLink = document.getElementById('copyInviteLink');

            if (closeInviteModal) {
                closeInviteModal.addEventListener('click', closeInviteModalHandler);
            }
            if (cancelInviteBtn) {
                cancelInviteBtn.addEventListener('click', closeInviteModalHandler);
            }
            if (createInviteBtn) {
                createInviteBtn.addEventListener('click', createInviteHandler);
            }
            if (copyInviteLink) {
                copyInviteLink.addEventListener('click', copyInviteLinkHandler);
            }

            // Gestionnaires pour la banni√®re d'invitation
            const acceptInvitationBtn = document.getElementById('acceptInvitationBtn');
            const declineInvitationBtn = document.getElementById('declineInvitationBtn');

            if (acceptInvitationBtn) {
                acceptInvitationBtn.addEventListener('click', acceptInvitation);
            }
            if (declineInvitationBtn) {
                declineInvitationBtn.addEventListener('click', declineInvitation);
            }

            // Bouton de soumission de document (avec contr√¥le des droits)
            const submitBtn = document.getElementById('submitDocumentBtn');
            if (submitBtn) {
                const currentUser = localRepository.getCurrentUser();
                if (currentUser) {
                    submitBtn.style.display = 'inline-block';
                    submitBtn.onclick = function() {
                        console.log('Bouton cliqu√©!');
                        const modal = document.getElementById('submitDocumentModal');
                        if (modal) {
                            modal.classList.add('open');
                            modal.style.display = 'flex'; // Force l'ouverture
                            console.log('Modal ouverte');
                        }
                    };
                } else {
                    submitBtn.style.display = 'none';
                    console.log('Bouton de soumission masqu√© - utilisateur non connect√©');
                }
            }
            
            // Modal de document
            const cancelDocumentBtn = document.getElementById('cancelDocumentBtn');
            if (cancelDocumentBtn) {
                cancelDocumentBtn.addEventListener('click', closeDocumentModal);
            }
            
            const submitDocumentForm = document.getElementById('submitDocumentForm');
            if (submitDocumentForm) {
                submitDocumentForm.addEventListener('submit', handleDocumentSubmit);
            }
            
            // Bouton de soumission direct
            const createDocumentBtn = document.getElementById('createDocumentBtn');
            if (createDocumentBtn) {
                createDocumentBtn.addEventListener('click', function(e) {
                    e.preventDefault(); // Emp√™cher le comportement par d√©faut
                    console.log('üîò Bouton Soumettre cliqu√©');
                    const form = document.getElementById('submitDocumentForm');
                    if (form) {
                        // Appeler directement la fonction au lieu de dispatcher l'√©v√©nement
                        handleDocumentSubmit(new Event('submit'));
                    }
                });
            }
            
            // Fermer la modal en cliquant √† l'ext√©rieur
            document.getElementById('submitDocumentModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('submitDocumentModal')) {
                    closeDocumentModal();
                }
            });

            // Bouton de cr√©ation de t√¢che
            const createTaskBtn = document.getElementById('createTaskBtn');
            if (createTaskBtn) {
                createTaskBtn.onclick = function() {
                    console.log('Bouton nouvelle t√¢che cliqu√©!');
                    const modal = document.getElementById('createTaskModal');
                    if (modal) {
                        modal.classList.add('open');
                        modal.style.display = 'flex';
                        console.log('Modal t√¢che ouverte');
                    }
                };
            }
            
            // Modal de t√¢che
            document.getElementById('cancelTaskBtn').addEventListener('click', closeTaskModal);
            document.getElementById('submitTaskBtn').addEventListener('click', handleTaskSubmit);

            // Modal de modification de t√¢che
            document.getElementById('cancelEditTaskBtn').addEventListener('click', closeEditTaskModal);
            document.getElementById('submitEditTaskBtn').addEventListener('click', handleEditTaskSubmit);
            
            // Fermer la modal de t√¢che en cliquant √† l'ext√©rieur
            document.getElementById('createTaskModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('createTaskModal')) {
                    closeTaskModal();
                }
            });

            // Fermer la modal de modification en cliquant √† l'ext√©rieur
            document.getElementById('editTaskModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('editTaskModal')) {
                    closeEditTaskModal();
                }
            });

            // Slider de progression
            const progressSlider = document.getElementById('progressSlider');
            if (progressSlider) {
                progressSlider.addEventListener('input', handleProgressChange);
            }

            // Formulaire de commentaire
            const commentForm = document.getElementById('commentForm');
            if (commentForm) {
                commentForm.addEventListener('submit', handleCommentSubmit);
            }

            // Filtre du journal
            const journalFilter = document.getElementById('journalFilter');
            if (journalFilter) {
                journalFilter.addEventListener('change', handleJournalFilter);
            }

            // Gestion de la s√©lection multiple des documents
            setupDocumentSelection();

            // Bouton retour aux projets
            const backToProjectsBtn = document.getElementById('backToProjectsBtn');
            if (backToProjectsBtn) {
                backToProjectsBtn.addEventListener('click', () => {
                    window.location.href = 'projects.html';
                });
            }

            // Bouton modifier le projet
            const editProjectBtn = document.getElementById('editProjectBtn');
            if (editProjectBtn) {
                editProjectBtn.addEventListener('click', () => {
                    editProject();
                });
            }

            // Bouton supprimer le projet
            const deleteProjectBtn = document.getElementById('deleteProjectBtn');
            if (deleteProjectBtn) {
                deleteProjectBtn.addEventListener('click', () => {
                    deleteProject();
                });
            }

            // Gestionnaires pour la modale de modification de projet
            const cancelEditProjectBtn = document.getElementById('cancelEditProjectBtn');
            const submitEditProjectBtn = document.getElementById('submitEditProjectBtn');
            const editProjectModal = document.getElementById('editProjectModal');

            if (cancelEditProjectBtn) {
                cancelEditProjectBtn.addEventListener('click', closeEditProjectModal);
            }
            if (submitEditProjectBtn) {
                submitEditProjectBtn.addEventListener('click', submitProjectEdit);
            }
            if (editProjectModal) {
                // Fermer la modale en cliquant √† l'ext√©rieur
                editProjectModal.addEventListener('click', (e) => {
                    if (e.target === editProjectModal) {
                        closeEditProjectModal();
                    }
                });
            }
        }

        // ========================================
        // GESTION DE LA S√âLECTION MULTIPLE DES DOCUMENTS
        // ========================================

        function setupDocumentSelection() {
            // Gestionnaire pour "S√©lectionner tout"
            const selectAllCheckbox = document.getElementById('selectAllDocuments');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const documentCheckboxes = document.querySelectorAll('.document-checkbox');
                    documentCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                    updateDownloadSelectedButton();
                });
            }

            // Gestionnaire pour le bouton "T√©l√©charger s√©lectionn√©s"
            const downloadSelectedBtn = document.getElementById('downloadSelectedBtn');
            if (downloadSelectedBtn) {
                downloadSelectedBtn.addEventListener('click', downloadSelectedDocuments);
            }

            // Gestionnaire pour les cases √† cocher individuelles
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('document-checkbox')) {
                    updateSelectAllCheckbox();
                    updateDownloadSelectedButton();
                }
            });
        }

        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAllDocuments');
            const documentCheckboxes = document.querySelectorAll('.document-checkbox');
            
            if (selectAllCheckbox && documentCheckboxes.length > 0) {
                const checkedCount = document.querySelectorAll('.document-checkbox:checked').length;
                selectAllCheckbox.checked = checkedCount === documentCheckboxes.length;
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < documentCheckboxes.length;
            }
        }

        function updateDownloadSelectedButton() {
            const downloadSelectedBtn = document.getElementById('downloadSelectedBtn');
            const checkedBoxes = document.querySelectorAll('.document-checkbox:checked');
            
            if (downloadSelectedBtn) {
                if (checkedBoxes.length > 0) {
                    downloadSelectedBtn.style.display = 'inline-block';
                    downloadSelectedBtn.textContent = `‚¨áÔ∏è T√©l√©charger (${checkedBoxes.length})`;
                } else {
                    downloadSelectedBtn.style.display = 'none';
                }
            }
        }

        function downloadSelectedDocuments() {
            const checkedBoxes = document.querySelectorAll('.document-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('Aucun document s√©lectionn√©');
                return;
            }

            const documentIds = Array.from(checkedBoxes).map(checkbox => checkbox.dataset.documentId);
            const documents = documentIds.map(id => localRepository.getDocument(id)).filter(doc => doc);

            if (documents.length === 0) {
                alert('Aucun document valide trouv√©');
                return;
            }

            // T√©l√©charger chaque document
            documents.forEach((doc, index) => {
                setTimeout(() => {
                    downloadDocument(doc.id);
                }, index * 500); // D√©lai de 500ms entre chaque t√©l√©chargement
            });

            // D√©s√©lectionner tous les documents apr√®s t√©l√©chargement
            checkedBoxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectAllCheckbox();
            updateDownloadSelectedButton();
        }

        // Configurer les onglets
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    
                    // Retirer la classe active de tous les boutons et contenus
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Ajouter la classe active au bouton cliqu√© et au contenu correspondant
                    button.classList.add('active');
                    const targetContent = document.getElementById(`${targetTab}-tab`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                    
                    console.log(`üîÑ Onglet activ√©: ${targetTab}`);
                });
            });
        }

        // Charger les d√©tails du projet
        function loadProjectDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            
            if (!projectId) {
                console.error('‚ùå Aucun ID de projet fourni');
                window.location.href = 'projects.html';
                return;
            }
            
            const project = localRepository.getProject(projectId);
            if (!project) {
                console.error('‚ùå Projet non trouv√©');
                window.location.href = 'projects.html';
                return;
            }
            
            currentProject = project;
            console.log(`‚úÖ Projet charg√©: ${project.name}`);
            
            // Mettre √† jour l'en-t√™te
            updateProjectHeader();
        }

        // Mettre √† jour l'en-t√™te du projet
        function updateProjectHeader() {
            if (!currentProject) return;

            // Mettre √† jour le nom du projet (au lieu du code)
            document.getElementById('projectCode').textContent = currentProject.name || 'Nom du projet';
            
            // Mettre √† jour le statut
            const statusText = document.getElementById('projectStatusText');
            if (statusText) {
                statusText.textContent = getStatusLabel(currentProject.status) || 'Actif';
            }
            
            // Mettre √† jour les d√©tails du projet
            document.getElementById('projectClient').textContent = currentProject.client || 'Non d√©fini';
            document.getElementById('projectLocation').querySelector('span').textContent = currentProject.location || 'Non d√©finie';
            
            // Mettre √† jour la progression
            const progress = currentProject.progress || 0;
            document.getElementById('projectProgressText').textContent = `${progress}%`;
            
            // Mettre √† jour la barre de progression mini
            const progressFillMini = document.getElementById('progressFillMini');
            if (progressFillMini) {
                progressFillMini.style.width = `${progress}%`;
            }
        }

        // Charger le tableau des documents
        function loadDocumentsTable() {
            if (!currentProject) return;
            
            const documents = localRepository.getDocumentsByProject(currentProject.id);
            const tbody = document.getElementById('documentsTableBody');
            const emptyState = document.getElementById('documentsEmptyState');
            const table = document.getElementById('documentsTable');
            
            if (documents.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            table.style.display = 'table';
            emptyState.style.display = 'none';
            
            tbody.innerHTML = documents.map(doc => {
                const targetRolesBadges = doc.targetRoles.map(role => 
                    `<span class="badge badge-secondary">${getRoleLabel(role)}</span>`
                ).join(' ');
                
                const statusClass = getDocStatusClass(doc.status);
                const statusLabel = getDocStatusLabel(doc.status);
                
                const actions = getDocumentActions(doc);
                
                return `
                    <tr>
                        <td>
                            <input type="checkbox" class="document-checkbox" data-document-id="${doc.id}" title="S√©lectionner ce document">
                        </td>
                        <td>
                            <div class="document-title">
                                <strong>${doc.name}</strong>
                                ${doc.externalUrl ? `<a href="${doc.externalUrl}" target="_blank" class="external-link">üîó</a>` : ''}
                            </div>
                        </td>
                        <td>${getDocTypeLabel(doc.type)}</td>
                        <td>${targetRolesBadges}</td>
                        <td><span class="badge badge-${statusClass}">${statusLabel}</span></td>
                        <td>${formatDate(doc.submittedAt)}</td>
                        <td>${actions}</td>
                        <td>
                            ${doc.fileName || doc.externalUrl ? 
                                `<button class="btn btn-sm btn-info" onclick="downloadDocument('${doc.id}')" title="T√©l√©charger le document">
                                    <i class="icon">‚¨áÔ∏è</i> T√©l√©charger
                                </button>` : 
                                '<span class="text-muted">N/A</span>'
                            }
                        </td>
                    </tr>
                `;
            }).join('');
            
            // R√©initialiser la s√©lection apr√®s le chargement du tableau
            updateSelectAllCheckbox();
            updateDownloadSelectedButton();
        }

        // ========================================
        // CONTR√îLE DES DROITS D'ACC√àS
        // ========================================

        /**
         * V√©rifie si l'utilisateur peut soumettre un document
         * Seuls les membres du projet peuvent soumettre des documents
         */
        function canSubmitDocument(doc, user) {
            // TOUS les utilisateurs connect√©s peuvent soumettre des documents
            // V√©rification minimale : utilisateur existe et document en brouillon
            return user && doc && doc.status === 'draft';
        }

        /**
         * V√©rifie si l'utilisateur peut r√©viser un document
         * L'auteur du document peut le r√©viser apr√®s observations ou refus
         */
        function canReviseDocument(doc, user) {
            if (!user || !user.isActive || doc.submittedBy !== user.id || !['observations', 'rejected'].includes(doc.status)) {
                return false;
            }
            
            // V√©rifier que l'utilisateur est membre du projet
            return isCurrentUserProjectMember();
        }

        /**
         * V√©rifie si l'utilisateur peut viser un document
         * Les destinataires peuvent viser, observer, refuser ou demander des modifications
         */
        function canReviewDocument(doc, user) {
            if (!user || !user.isActive || !['submitted', 'under_review'].includes(doc.status)) {
                return false;
            }
            
            // V√©rifier que l'utilisateur est membre du projet
            if (!isCurrentUserProjectMember()) {
                return false;
            }
            
            // Obtenir le r√¥le effectif de l'utilisateur dans le projet
            const effectiveRole = getCurrentUserRoleInProject();
            
            return doc.targetRoles.includes(effectiveRole);
        }

        /**
         * V√©rifie si l'utilisateur peut cr√©er un document
         */
        function canCreateDocument(user) {
            if (!user || !user.isActive) {
                return false;
            }
            
            // TOUS les utilisateurs connect√©s peuvent cr√©er des documents
            return true;
        }

        /**
         * V√©rifie si l'utilisateur peut voir l'historique d'un document
         */
        function canViewDocumentHistory(doc, user) {
            // TOUS les utilisateurs connect√©s peuvent voir l'historique
            return user && user.isActive;
        }
        
        /**
         * V√©rifie si l'utilisateur peut t√©l√©charger un document
         */
        function canDownloadDocument(doc, user) {
            // TOUS les utilisateurs connect√©s peuvent t√©l√©charger des documents
            return user && user.isActive;
        }

        /**
         * Obtient les permissions de l'utilisateur pour un document
         * 
         * ‚ö†Ô∏è  S√âCURIT√â : Cette fonction est c√¥t√© client uniquement !
         * ========================================
         * - Toutes les v√©rifications peuvent √™tre contourn√©es
         * - Un utilisateur malveillant peut modifier les permissions
         * - Pas de v√©rification c√¥t√© serveur
         * 
         * üîí EN PRODUCTION : Impl√©menter c√¥t√© serveur avec JWT
         */
        function getDocumentPermissions(doc, user) {
            return {
                canSubmit: canSubmitDocument(doc, user),
                canRevise: canReviseDocument(doc, user),
                canReview: canReviewDocument(doc, user),
                canViewHistory: canViewDocumentHistory(doc, user),
                canDownload: canDownloadDocument(doc, user)
            };
        }

        // ========================================
        // PERMISSIONS POUR LES T√ÇCHES
        // ========================================

        /**
         * V√©rifie si l'utilisateur peut cr√©er une t√¢che
         */
        function canCreateTask(user) {
            if (!user || !user.isActive) {
                return false;
            }
            
            // Seuls les membres du projet peuvent cr√©er des t√¢ches
            return isCurrentUserProjectMember();
        }

        /**
         * V√©rifie si l'utilisateur peut modifier une t√¢che
         */
        function canEditTask(task, user) {
            if (!user || !user.isActive) {
                return false;
            }
            
            // V√©rifier que l'utilisateur est membre du projet
            if (!isCurrentUserProjectMember()) {
                return false;
            }
            
            // L'auteur de la t√¢che ou les administrateurs peuvent la modifier
            return task.createdBy === user.id || user.role === 'admin' || getCurrentUserRoleInProject() === 'admin';
        }

        /**
         * V√©rifie si l'utilisateur peut supprimer une t√¢che
         */
        function canDeleteTask(task, user) {
            if (!user || !user.isActive) {
                return false;
            }
            
            // V√©rifier que l'utilisateur est membre du projet
            if (!isCurrentUserProjectMember()) {
                return false;
            }
            
            // L'auteur de la t√¢che ou les administrateurs peuvent la supprimer
            return task.createdBy === user.id || user.role === 'admin' || getCurrentUserRoleInProject() === 'admin';
        }

        /**
         * V√©rifie si l'utilisateur peut g√©rer les t√¢ches (drag & drop)
         */
        function canManageTasks(user) {
            if (!user || !user.isActive) {
                return false;
            }
            
            // Seuls les membres du projet peuvent g√©rer les t√¢ches
            return isCurrentUserProjectMember();
        }

        /**
         * Affiche les informations de permissions pour debug
         */
        window.debugPermissions = function() {
            const currentUser = localRepository.getCurrentUser();
            if (!currentUser) {
                console.log('‚ùå Aucun utilisateur connect√©');
                return;
            }

            console.log('üîê Informations de permissions:');
            const userRoleInProject = getCurrentUserRoleInProject();
            console.log('üë§ Utilisateur:', currentUser.name, `(Global: ${currentUser.role}, Projet: ${userRoleInProject || 'N/A'})`);
            
            const documents = localRepository.getDocumentsByProject(currentProject.id);
            documents.forEach(doc => {
                const permissions = getDocumentPermissions(doc, currentUser);
                console.log(`üìÑ Document "${doc.name}" (${doc.status}):`, permissions);
            });
        }

        /**
         * Teste les permissions pour diff√©rents sc√©narios
         */
        function testPermissions() {
            const currentUser = localRepository.getCurrentUser();
            if (!currentUser) {
                alert('Aucun utilisateur connect√©');
                return;
            }

            const userRoleInProject = getCurrentUserRoleInProject();
            let testResults = `üß™ Test des permissions pour ${currentUser.name} (Global: ${currentUser.role}, Projet: ${userRoleInProject || 'N/A'}):\n\n`;
            
            // Test cr√©ation de document
            testResults += `üìù Cr√©er un document: ${canCreateDocument(currentUser) ? '‚úÖ Autoris√©' : '‚ùå Refus√©'}\n`;
            
            const documents = localRepository.getDocumentsByProject(currentProject.id);
            documents.forEach(doc => {
                const permissions = getDocumentPermissions(doc, currentUser);
                testResults += `\nüìÑ "${doc.name}" (${doc.status}):\n`;
                testResults += `  - Soumettre: ${permissions.canSubmit ? '‚úÖ' : '‚ùå'}\n`;
                testResults += `  - R√©viser: ${permissions.canRevise ? '‚úÖ' : '‚ùå'}\n`;
                testResults += `  - Viser: ${permissions.canReview ? '‚úÖ' : '‚ùå'}\n`;
                testResults += `  - Historique: ${permissions.canViewHistory ? '‚úÖ' : '‚ùå'}\n`;
            });
            
            alert(testResults);
        }

        // Obtenir les actions disponibles pour un document
        function getDocumentActions(doc) {
            const currentUser = localRepository.getCurrentUser();
            if (!currentUser) {
                return '<span class="text-muted">Non connect√©</span>';
            }

            const permissions = getDocumentPermissions(doc, currentUser);
            const actions = [];
            
            // Debug: Afficher les permissions dans la console
            const userRoleInProject = getCurrentUserRoleInProject();
            console.log(`üîç Actions pour "${doc.name}" (${doc.status}):`, {
                userRoleGlobal: currentUser.role,
                userRoleInProject: userRoleInProject,
                docStatus: doc.status,
                targetRoles: doc.targetRoles,
                permissions: permissions
            });
            
            // Bouton Soumettre (TOUS les utilisateurs connect√©s, document en brouillon)
            if (permissions.canSubmit) {
                actions.push(`<button class="btn btn-sm btn-primary" onclick="submitDocument('${doc.id}')" title="Soumettre le document pour validation">
                    <i class="icon">üì§</i> Soumettre
                </button>`);
            }
            
            // Bouton R√©viser (Auteur du document, apr√®s observations ou refus)
            if (permissions.canRevise) {
                actions.push(`<button class="btn btn-sm btn-warning" onclick="reviseDocument('${doc.id}')" title="Marquer le document comme r√©vis√©">
                    <i class="icon">‚úèÔ∏è</i> R√©viser
                </button>`);
            }
            
            // Boutons de visa (Destinataires uniquement, document soumis ou en revue)
            if (permissions.canReview) {
                actions.push(`<button class="btn btn-sm btn-success" onclick="reviewDocument('${doc.id}', 'approve')" title="Approuver le document">
                    <i class="icon">‚úÖ</i> Viser
                </button>`);
                actions.push(`<button class="btn btn-sm btn-warning" onclick="reviewDocument('${doc.id}', 'observations')" title="Ajouter des observations ou demander des modifications">
                    <i class="icon">‚ö†Ô∏è</i> Observations
                </button>`);
                actions.push(`<button class="btn btn-sm btn-danger" onclick="reviewDocument('${doc.id}', 'reject')" title="Refuser le document">
                    <i class="icon">‚ùå</i> Refuser
                </button>`);
            }
            
            
            // Bouton T√©l√©charger (tous les utilisateurs connect√©s)
            if (permissions.canDownload) {
                actions.push(`<button class="btn btn-sm btn-info" onclick="downloadDocument('${doc.id}')" title="T√©l√©charger le document">
                    <i class="icon">üì•</i> T√©l√©charger
                </button>`);
            }
            
            // Bouton Historique (toujours visible)
            if (permissions.canViewHistory) {
                actions.push(`<button class="btn btn-sm btn-secondary" onclick="showDocumentHistory('${doc.id}')" title="Voir l'historique du document">
                    <i class="icon">üìã</i> Historique
                </button>`);
            }
            
            // Si aucune action n'est disponible, afficher un message
            if (actions.length === 0) {
                return '<span class="text-muted">Aucune action disponible</span>';
            }
            
            return actions.join(' ');
        }


        // T√©l√©charger un document - Fonction globale
        window.downloadDocument = function(documentId) {
            const doc = localRepository.getDocument(documentId);
            if (!doc) {
                alert('Document non trouv√©');
                return;
            }

            if (doc.externalUrl) {
                // Ouvrir l'URL externe dans un nouvel onglet
                window.open(doc.externalUrl, '_blank');
                alert('Ouverture du document externe');
            } else if (doc.fileName) {
                // Pour les fichiers upload√©s, cr√©er un lien de t√©l√©chargement
                // Dans une vraie application, ceci ferait un appel API
                const link = document.createElement('a');
                link.href = '#'; // Placeholder - dans une vraie app, ce serait l'URL du fichier
                link.download = doc.fileName;
                link.textContent = 'T√©l√©charger ' + doc.fileName;
                
                // Simuler le t√©l√©chargement
                alert(`T√©l√©chargement de "${doc.fileName}" d√©marr√©`);
                
                // Dans une vraie application, vous feriez :
                // fetch(`/api/documents/${documentId}/download`)
                //   .then(response => response.blob())
                //   .then(blob => {
                //     const url = window.URL.createObjectURL(blob);
                //     link.href = url;
                //     link.click();
                //     window.URL.revokeObjectURL(url);
                //   });
            } else {
                alert('Aucun fichier disponible pour ce document');
            }
        };

        // Fermer la modal de document
        function closeDocumentModal() {
            const modal = document.getElementById('submitDocumentModal');
            if (modal) {
                modal.classList.remove('open');
                modal.style.display = 'none'; // Force la fermeture
                const form = document.getElementById('submitDocumentForm');
                if (form) {
                    form.reset();
                }
                console.log('‚úÖ Modal ferm√©e');
            }
        }

        // G√©rer la soumission du document
        function handleDocumentSubmit(e) {
            try {
                e.preventDefault();
                console.log('üìÑ Soumission du document...');
                
                // R√©cup√©rer les donn√©es du formulaire
                const form = document.getElementById('submitDocumentForm');
                if (!form) {
                    console.error('‚ùå Formulaire non trouv√©');
                    return;
                }
                
                // R√©cup√©rer les valeurs directement des champs
                const title = document.getElementById('documentTitle').value;
                const type = document.getElementById('documentType').value;
                const file = document.getElementById('documentFile').files[0];
                const externalUrl = document.getElementById('externalUrl').value;
                
                // R√©cup√©rer les destinataires s√©lectionn√©s
                const targetRoles = [];
                const checkboxes = document.querySelectorAll('input[name="targetRoles"]:checked');
                checkboxes.forEach(checkbox => {
                    targetRoles.push(checkbox.value);
                });
                
                // Debug: V√©rifier toutes les valeurs
                console.log('üîç Debug valeurs directes:');
                console.log('  title:', title);
                console.log('  type:', type);
                console.log('  file:', file?.name);
                console.log('  externalUrl:', externalUrl);
                console.log('  targetRoles:', targetRoles);
                
                console.log('üìã Donn√©es du formulaire:', {
                    title, type, file: file?.name, externalUrl, targetRoles
                });
                
                // Debug: V√©rifier que le titre n'est pas vide
                if (!title || title.trim() === '') {
                    console.error('‚ùå Titre vide ou invalide:', title);
                    alert('Le titre du document ne peut pas √™tre vide');
                    return;
                }
                
                if (!title || !type) {
                    alert('Veuillez remplir le titre et le type du document');
                    return;
                }
                
                if (!file && !externalUrl) {
                    alert('Veuillez fournir un fichier ou une URL externe');
                    return;
                }
                
                if (targetRoles.length === 0) {
                    alert('Veuillez s√©lectionner au moins un destinataire');
                    return;
                }
                
                if (!currentProject) {
                    console.error('‚ùå Projet non trouv√©');
                    alert('Erreur: Projet non trouv√©');
                    return;
                }
            
            // Cr√©er le document
            const documentData = {
                projectId: currentProject.id,
                name: title,
                type: type,
                targetRoles: targetRoles,
                externalUrl: externalUrl,
                status: 'draft', // Commence en brouillon
                submittedBy: localRepository.getCurrentUser().id,
                submittedAt: new Date().toISOString()
            };
            
            // Si un fichier est fourni, le convertir en base64
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    documentData.fileName = file.name;
                    documentData.fileSize = file.size;
                    documentData.fileType = file.type;
                    documentData.fileBase64 = e.target.result;
                    
                    // Sauvegarder le document
                    const document = localRepository.createDocument(documentData);
                    console.log('üìÑ Document cr√©√©:', document);
                    
                    // Recharger la liste des documents
                    loadDocumentsTable();
                    
                    // Recharger le journal
                    loadJournalActions();
                    
                    // Cr√©er des notifications
                    createDocumentNotifications(document, 'created', 'Cr√©√©');
                    
                    // Mettre √† jour le badge de notification
                    updateNotificationBadge();
                    
                    alert('Document cr√©√© avec succ√®s !');
                    closeDocumentModal();
                };
                reader.readAsDataURL(file);
            } else {
                // Document sans fichier (lien externe uniquement)
                const document = localRepository.createDocument(documentData);
                console.log('üìÑ Document cr√©√©:', document);
                
                // Recharger la liste des documents
                loadDocumentsTable();
                
                // Recharger le journal
                loadJournalActions();
                
                // Cr√©er des notifications
                createDocumentNotifications(document, 'created', 'Cr√©√©');
                
                // Mettre √† jour le badge de notification
                updateNotificationBadge();
                
                alert('Document cr√©√© avec succ√®s !');
                closeDocumentModal();
            }
            } catch (error) {
                console.error('‚ùå Erreur lors de la soumission:', error);
                alert('Erreur lors de la soumission du document: ' + error.message);
            }
        }

        // Fonctions utilitaires
        function getStatusLabel(status) {
            const labels = {
                'draft': 'Brouillon',
                'active': 'Actif',
                'completed': 'Termin√©',
                'on_hold': 'En attente',
                'cancelled': 'Annul√©'
            };
            return labels[status] || status;
        }

        function getStatusClass(status) {
            const classes = {
                'draft': 'warning',
                'active': 'success',
                'completed': 'info',
                'on_hold': 'secondary',
                'cancelled': 'danger'
            };
            return classes[status] || 'secondary';
        }

        // Fonctions pour les documents
        function getDocStatusLabel(status) {
            const labels = {
                'draft': 'Brouillon',
                'submitted': 'Soumis',
                'under_review': 'En revue',
                'observations': 'Observations',
                'revised': 'R√©vis√©',
                'approved': 'Valid√©',
                'rejected': 'Refus√©'
            };
            return labels[status] || status;
        }

        function getDocStatusClass(status) {
            const classes = {
                'draft': 'secondary',
                'submitted': 'info',
                'under_review': 'warning',
                'observations': 'warning',
                'revised': 'info',
                'approved': 'success',
                'rejected': 'danger'
            };
            return classes[status] || 'secondary';
        }

        function getDocTypeLabel(type) {
            const labels = {
                'plan': 'Plan architectural',
                'rapport': 'Rapport technique',
                'cahier': 'Cahier des charges',
                'etude': '√âtude de faisabilit√©',
                'autre': 'Autre'
            };
            return labels[type] || type;
        }

        function getRoleLabel(role) {
            const labels = {
                'moa': 'Ma√Ætre d\'ouvrage',
                'architect': 'Architecte',
                'bet': 'Bureau d\'√âtudes',
                'bct': 'Bureau de Contr√¥le',
                'contractor': 'Entrepreneur',
                'entreprise': 'Entreprise',
                'urbanisme': 'Services d\'urbanisme',
                'mairie': 'Mairie/Commune',
                'admin': 'Administrateur'
            };
            return labels[role] || role;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('fr-FR');
        }

        // Actions de workflow (fonctions globales pour onclick)
        window.submitDocument = function(docId) {
            // V√©rifier l'appartenance au projet
            if (!isCurrentUserProjectMember()) {
                showNonMemberAlert();
                return;
            }

            const doc = localRepository.getDocument(docId);
            const currentUser = localRepository.getCurrentUser();
            
            if (!doc || !currentUser) {
                alert('Erreur: Document ou utilisateur non trouv√©');
                return;
            }
            
            // V√©rifier les permissions
            if (!canSubmitDocument(doc, currentUser)) {
                alert('Erreur: Vous n\'avez pas l\'autorisation de soumettre ce document');
                const userRoleInProject = getCurrentUserRoleInProject();
                console.warn('Tentative de soumission non autoris√©e:', { docId, userId: currentUser.id, userRoleGlobal: currentUser.role, userRoleInProject });
                return;
            }
            
            try {
                doc.submit(currentUser.id);
                localRepository.updateDocument(doc);
                loadDocumentsTable();
                loadJournalActions();
                
                // Cr√©er des notifications
                createDocumentNotifications(doc, 'submitted', 'Soumis');
                
                // Mettre √† jour le badge de notification
                updateNotificationBadge();
                
                alert('Document soumis avec succ√®s !');
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        window.reviewDocument = function(docId, action) {
            // V√©rifier l'appartenance au projet
            if (!isCurrentUserProjectMember()) {
                showNonMemberAlert();
                return;
            }

            const doc = localRepository.getDocument(docId);
            const currentUser = localRepository.getCurrentUser();
            
            if (!doc || !currentUser) {
                alert('Erreur: Document ou utilisateur non trouv√©');
                return;
            }
            
            // V√©rifier les permissions
            if (!canReviewDocument(doc, currentUser)) {
                alert('Erreur: Vous n\'avez pas l\'autorisation de viser ce document');
                const userRoleInProject = getCurrentUserRoleInProject();
                console.warn('Tentative de visa non autoris√©e:', { docId, userId: currentUser.id, userRoleGlobal: currentUser.role, userRoleInProject, action });
                return;
            }
            
            let comment = '';
            if (action === 'reject' || action === 'observations') {
                comment = prompt(`Commentaire pour ${action === 'reject' ? 'le refus' : 'les observations'}:`);
                if (comment === null) return; // Annul√©
            }
            
            try {
                doc.review(currentUser.id, action, comment);
                localRepository.updateDocument(doc);
                loadDocumentsTable();
                loadJournalActions();
                
                // Cr√©er des notifications
                const actionLabel = action === 'approve' ? 'Approuv√©' : action === 'reject' ? 'Refus√©' : 'Avec observations';
                createDocumentNotifications(doc, action, actionLabel);
                
                // Mettre √† jour le badge de notification
                updateNotificationBadge();
                
                alert(`Document ${action === 'approve' ? 'approuv√©' : action === 'reject' ? 'refus√©' : 'avec observations'} !`);
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        window.reviseDocument = function(docId) {
            // V√©rifier l'appartenance au projet
            if (!isCurrentUserProjectMember()) {
                showNonMemberAlert();
                return;
            }

            const doc = localRepository.getDocument(docId);
            const currentUser = localRepository.getCurrentUser();
            
            if (!doc || !currentUser) {
                alert('Erreur: Document ou utilisateur non trouv√©');
                return;
            }
            
            // V√©rifier les permissions
            if (!canReviseDocument(doc, currentUser)) {
                alert('Erreur: Vous n\'avez pas l\'autorisation de r√©viser ce document');
                const userRoleInProject = getCurrentUserRoleInProject();
                console.warn('Tentative de r√©vision non autoris√©e:', { docId, userId: currentUser.id, userRoleGlobal: currentUser.role, userRoleInProject });
                return;
            }
            
            try {
                doc.revise(currentUser.id);
                localRepository.updateDocument(doc);
                loadDocumentsTable();
                loadJournalActions();
                
                // Cr√©er des notifications
                createDocumentNotifications(doc, 'revised', 'R√©vis√©');
                
                // Mettre √† jour le badge de notification
                updateNotificationBadge();
                
                alert('Document marqu√© comme r√©vis√© !');
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        window.showDocumentHistory = function(docId) {
            const doc = localRepository.getDocument(docId);
            if (!doc) return;
            
            let historyText = `Historique du document: ${doc.name}\n\n`;
            if (doc.history && doc.history.length > 0) {
                doc.history.forEach(entry => {
                    const date = new Date(entry.timestamp).toLocaleString('fr-FR');
                    historyText += `${date}: ${entry.action} - ${entry.comment || 'Aucun commentaire'}\n`;
                });
            } else {
                historyText += 'Aucun historique disponible.';
            }
            
            alert(historyText);
        }

        // ========================================
        // FONCTIONS KANBAN
        // ========================================

        // Fermer la modal de t√¢che
        function closeTaskModal() {
            const modal = document.getElementById('createTaskModal');
            modal.classList.remove('open');
            modal.style.display = 'none';
            document.getElementById('createTaskForm').reset();
            console.log('Modal t√¢che ferm√©e');
        }

        // G√©rer la cr√©ation de t√¢che
        function handleTaskSubmit(e) {
            e.preventDefault();
            
            // V√©rifier les permissions
            const currentUser = localRepository.getCurrentUser();
            if (!canCreateTask(currentUser)) {
                alert('Erreur: Vous n\'avez pas l\'autorisation de cr√©er des t√¢ches dans ce projet');
                return;
            }
            
            // R√©cup√©rer les valeurs directement des inputs
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const assigneeName = document.getElementById('taskAssignee').value;
            const dueDate = document.getElementById('taskDueDate').value;
            const priority = document.getElementById('taskPriority').value;
            
            if (!title) {
                alert('Veuillez saisir un titre pour la t√¢che');
                return;
            }
            
            if (!assigneeName) {
                alert('Veuillez saisir un responsable pour la t√¢che');
                return;
            }
            
            // Cr√©er la t√¢che
            const taskData = {
                projectId: currentProject.id,
                title: title,
                description: description || '',
                assigneeName: assigneeName,
                dueDate: dueDate || null,
                priority: priority,
                status: 'todo', // Commence en "√Ä faire"
                assignedTo: localRepository.getCurrentUser().id,
                createdBy: localRepository.getCurrentUser().id,
                createdAt: new Date().toISOString()
            };
            
            const task = localRepository.createTask(taskData);
            console.log('‚úÖ T√¢che cr√©√©e:', task);
            
            // Recharger le Kanban
            loadKanbanBoard();
            
            // Recharger le journal
            loadJournalActions();
            
            // Mettre √† jour automatiquement le pourcentage d'avancement
            updateProjectProgressFromTasks();
            
            // Cr√©er des notifications
            createProjectNotification(
                'task_assigned',
                'Nouvelle t√¢che - ' + task.title,
                `Une nouvelle t√¢che "${task.title}" a √©t√© cr√©√©e dans le projet`,
                currentProject.id,
                { taskId: task.id }
            );
            
            // Mettre √† jour le badge de notification
            updateNotificationBadge();
            
            alert('T√¢che cr√©√©e avec succ√®s !');
            closeTaskModal();
        }

        // Charger le tableau Kanban
        function loadKanbanBoard() {
            if (!currentProject) return;
            
            const tasks = localRepository.getTasksByProject(currentProject.id);
            console.log('üìã T√¢ches charg√©es:', tasks);
            
            // Vider toutes les colonnes
            const columns = {
                todo: document.getElementById('todoColumn'),
                in_progress: document.getElementById('inProgressColumn'),
                review: document.getElementById('reviewColumn'),
                done: document.getElementById('completedColumn')
            };
            
            Object.values(columns).forEach(column => {
                column.innerHTML = '';
            });
            
            // Compter les t√¢ches par statut
            const counts = {
                todo: 0,
                in_progress: 0,
                review: 0,
                done: 0
            };
            
            // Ajouter les t√¢ches aux colonnes appropri√©es
            tasks.forEach(task => {
                const taskElement = createTaskElement(task);
                const status = task.status || 'todo';
                
                if (columns[status]) {
                    columns[status].appendChild(taskElement);
                    counts[status]++;
                }
            });
            
            // Mettre √† jour les compteurs
            document.getElementById('todoCount').textContent = counts.todo;
            document.getElementById('inProgressCount').textContent = counts.in_progress;
            document.getElementById('reviewCount').textContent = counts.review;
            document.getElementById('completedCount').textContent = counts.done;
            
            // Configurer le drag & drop
            setupDragAndDrop();
        }

        // Cr√©er un √©l√©ment de t√¢che
        function createTaskElement(task) {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-card';
            taskDiv.draggable = true;
            taskDiv.dataset.taskId = task.id;
            
            const priorityClass = task.priority || 'medium';
            const priorityLabel = getPriorityLabel(task.priority);
            const createdDate = new Date(task.createdAt).toLocaleDateString('fr-FR');
            
            // Gestion de la date limite et des badges
            let dueDateHtml = '';
            let overdueIcon = '';
            
            if (task.dueDate) {
                const dueDate = new Date(task.dueDate);
                const today = new Date();
                const diffTime = dueDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let badgeClass = 'badge-success'; // Vert par d√©faut
                let statusText = '';
                
                if (diffDays < 0) {
                    // En retard
                    badgeClass = 'badge-danger';
                    statusText = 'En retard';
                    overdueIcon = '<span class="overdue-icon">‚ö†Ô∏è</span>';
                } else if (diffDays <= 3) {
                    // √âch√©ance proche
                    badgeClass = 'badge-warning';
                    statusText = '√âch√©ance proche';
                } else {
                    // Dans les temps
                    statusText = 'Dans les temps';
                }
                
                const formattedDate = dueDate.toLocaleDateString('fr-FR', { 
                    day: '2-digit', 
                    month: '2-digit' 
                });
                
                dueDateHtml = `
                    <div class="task-due-date">
                        <span class="badge ${badgeClass}">üìÖ ${formattedDate}</span>
                    </div>
                `;
            }
            
            // Responsable
            const assigneeHtml = task.assigneeName ? `
                <div class="task-assignee">
                    <span class="assignee-icon">üë§</span>
                    <span class="assignee-name">${task.assigneeName}</span>
                </div>
            ` : '';
            
            taskDiv.innerHTML = `
                <div class="task-header">
                    <div class="task-title">${overdueIcon}${task.title}</div>
                    <div class="task-actions">
                        <button class="btn-edit-task" onclick="editTask('${task.id}')" title="Modifier">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn-delete-task" onclick="deleteTask('${task.id}')" title="Supprimer">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
                ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                ${assigneeHtml}
                ${dueDateHtml}
                <div class="task-meta">
                    <span class="task-priority ${priorityClass}">${priorityLabel}</span>
                    <span class="task-date">Cr√©√© le ${createdDate}</span>
                </div>
            `;
            
            return taskDiv;
        }

        // Configurer le drag & drop
        function setupDragAndDrop() {
            const taskCards = document.querySelectorAll('.task-card');
            const columns = document.querySelectorAll('.kanban-column-content');
            
            // √âv√©nements pour les cartes de t√¢che
            taskCards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });
            
            // √âv√©nements pour les colonnes
            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
                column.addEventListener('drop', handleDrop);
            });
        }

        // Gestionnaires de drag & drop
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.target.closest('.kanban-column').classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.target.closest('.kanban-column').classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            const column = e.target.closest('.kanban-column');
            column.classList.remove('drag-over');
            
            const taskId = e.dataTransfer.getData('text/plain');
            const newStatus = column.dataset.status;
            
            console.log(`üéØ Drop d√©tect√© - TaskId: ${taskId}, NewStatus: ${newStatus}`);
            
            // V√©rifier les permissions pour g√©rer les t√¢ches
            const currentUser = localRepository.getCurrentUser();
            if (!canManageTasks(currentUser)) {
                alert('Erreur: Vous n\'avez pas l\'autorisation de g√©rer les t√¢ches dans ce projet');
                return;
            }
            
            // Mettre √† jour la t√¢che
            const task = localRepository.getTask(taskId);
            if (task) {
                console.log(`üìã T√¢che trouv√©e: ${task.title}, ancien statut: ${task.status}`);
                task.status = newStatus;
                task.updatedAt = new Date().toISOString();
                localRepository.updateTask(taskId, task);
                
                console.log(`‚úÖ T√¢che ${taskId} d√©plac√©e vers ${newStatus}`);
                
                // Recharger le Kanban
                loadKanbanBoard();
                
                // Recharger le journal
                loadJournalActions();
                
                // Mettre √† jour automatiquement le pourcentage d'avancement
                updateProjectProgressFromTasks();
                
            } else {
                console.error(`‚ùå T√¢che ${taskId} non trouv√©e`);
            }
        }

        // Fonctions utilitaires pour les t√¢ches
        function getPriorityLabel(priority) {
            const labels = {
                'low': 'Faible',
                'medium': 'Moyenne',
                'high': '√âlev√©e',
                'urgent': 'Urgente'
            };
            return labels[priority] || 'Moyenne';
        }

        // Fonction pour modifier une t√¢che
        window.editTask = function(taskId) {
            const task = localRepository.getTask(taskId);
            if (!task) {
                alert('T√¢che non trouv√©e');
                return;
            }

            // V√©rifier les permissions
            const currentUser = localRepository.getCurrentUser();
            if (!canEditTask(task, currentUser)) {
                alert('Erreur: Vous n\'avez pas l\'autorisation de modifier cette t√¢che');
                return;
            }

            // Remplir le formulaire avec les donn√©es actuelles
            document.getElementById('editTaskTitle').value = task.title;
            document.getElementById('editTaskDescription').value = task.description || '';
            document.getElementById('editTaskAssignee').value = task.assigneeName || '';
            document.getElementById('editTaskDueDate').value = task.dueDate || '';
            document.getElementById('editTaskPriority').value = task.priority || 'medium';
            document.getElementById('editTaskStatus').value = task.status || 'todo';

            // Stocker l'ID de la t√¢che pour la modification
            document.getElementById('editTaskForm').dataset.taskId = taskId;

            // Afficher la modal
            const modal = document.getElementById('editTaskModal');
            modal.style.display = 'flex';
            modal.classList.add('open');
        }

        // Fonction pour supprimer une t√¢che
        window.deleteTask = function(taskId) {
            const task = localRepository.getTask(taskId);
            if (!task) {
                alert('T√¢che non trouv√©e');
                return;
            }

            // V√©rifier les permissions
            const currentUser = localRepository.getCurrentUser();
            if (!canDeleteTask(task, currentUser)) {
                alert('Erreur: Vous n\'avez pas l\'autorisation de supprimer cette t√¢che');
                return;
            }

            if (confirm(`√ätes-vous s√ªr de vouloir supprimer la t√¢che "${task.title}" ?`)) {
                localRepository.deleteTask(taskId);
                console.log(`üóëÔ∏è T√¢che ${taskId} supprim√©e`);
                
                // Recharger le Kanban
                loadKanbanBoard();
                
                // Recharger le journal
                loadJournalActions();
                
                alert('T√¢che supprim√©e avec succ√®s !');
            }
        }

        // Fonction pour fermer la modal de modification
        function closeEditTaskModal() {
            const modal = document.getElementById('editTaskModal');
            modal.style.display = 'none';
            modal.classList.remove('open');
            document.getElementById('editTaskForm').reset();
            console.log('Modal modification t√¢che ferm√©e');
        }

        // G√©rer la soumission du formulaire de modification
        function handleEditTaskSubmit(e) {
            e.preventDefault();
            
            // R√©cup√©rer l'ID de la t√¢che depuis le formulaire
            const taskId = document.getElementById('editTaskForm').dataset.taskId;
            
            if (!taskId) {
                alert('Erreur: ID de t√¢che manquant');
                return;
            }

            // R√©cup√©rer les valeurs directement des inputs
            const title = document.getElementById('editTaskTitle').value;
            const description = document.getElementById('editTaskDescription').value;
            const assigneeName = document.getElementById('editTaskAssignee').value;
            const dueDate = document.getElementById('editTaskDueDate').value;
            const priority = document.getElementById('editTaskPriority').value;
            const status = document.getElementById('editTaskStatus').value;
            
            if (!title) {
                alert('Veuillez saisir un titre pour la t√¢che');
                return;
            }
            
            if (!assigneeName) {
                alert('Veuillez saisir un responsable pour la t√¢che');
                return;
            }
            
            // R√©cup√©rer la t√¢che existante
            const task = localRepository.getTask(taskId);
            if (!task) {
                alert('T√¢che non trouv√©e');
                return;
            }
            
            // Mettre √† jour la t√¢che
            const updatedTask = {
                ...task,
                title: title,
                description: description || '',
                assigneeName: assigneeName,
                dueDate: dueDate || null,
                priority: priority,
                status: status,
                updatedAt: new Date().toISOString()
            };
            
            localRepository.updateTask(taskId, updatedTask);
            console.log('‚úÖ T√¢che modifi√©e:', updatedTask);
            
            // Recharger le Kanban
            loadKanbanBoard();
            
            // Recharger le journal
            loadJournalActions();
            
            // Mettre √† jour automatiquement le pourcentage d'avancement
            updateProjectProgressFromTasks();
            
            alert('T√¢che modifi√©e avec succ√®s !');
            closeEditTaskModal();
        }

        // ========================================
        // FONCTIONS SUIVI D'AVANCEMENT
        // ========================================

        // Mettre √† jour automatiquement le pourcentage d'avancement bas√© sur les t√¢ches
        function updateProjectProgressFromTasks() {
            if (!currentProject) return;
            
            // R√©cup√©rer toutes les t√¢ches du projet
            const tasks = localRepository.getTasksByProject(currentProject.id);
            
            if (tasks.length === 0) {
                console.log('üìä Aucune t√¢che trouv√©e pour calculer l\'avancement');
                return;
            }
            
            // Compter les t√¢ches termin√©es
            const completedTasks = tasks.filter(task => task.status === 'done').length;
            const totalTasks = tasks.length;
            
            // Calculer le pourcentage
            const progressPercentage = Math.round((completedTasks / totalTasks) * 100);
            
            console.log(`üìä Calcul automatique: ${completedTasks}/${totalTasks} t√¢ches termin√©es = ${progressPercentage}%`);
            
            // Mettre √† jour le projet avec le nouveau pourcentage
            currentProject.progress = progressPercentage;
            currentProject.updatedAt = new Date().toISOString();
            
            // Sauvegarder dans le store
            localRepository.updateProject(currentProject.id, currentProject);
            
            // Mettre √† jour l'affichage
            updateProgressDisplay(progressPercentage);
            
            // Recharger l'onglet de suivi si il est visible
            if (document.getElementById('tracking-tab').style.display !== 'none') {
                loadTrackingTab();
            }
            
            console.log(`‚úÖ Avancement du projet mis √† jour automatiquement: ${progressPercentage}%`);
        }

        // Charger l'onglet de suivi
        function loadTrackingTab() {
            if (!currentProject) return;
            
            // Charger la progression actuelle
            loadProjectProgress();
            
            // Charger les statistiques
            loadProjectStats();
        }

        // Charger la progression du projet
        function loadProjectProgress() {
            if (!currentProject) return;
            
            const progress = currentProject.progress || 0;
            
            // Mettre √† jour le slider
            const slider = document.getElementById('progressSlider');
            if (slider) {
                slider.value = progress;
            }
            
            // Mettre √† jour l'affichage
            updateProgressDisplay(progress);
        }

        // G√©rer le changement de progression
        function handleProgressChange(e) {
            const progress = parseInt(e.target.value);
            updateProgressDisplay(progress);
            saveProjectProgress(progress);
        }

        // Mettre √† jour l'affichage de la progression
        function updateProgressDisplay(progress) {
            // Badge de progression
            const progressValue = document.getElementById('progressValue');
            if (progressValue) {
                progressValue.textContent = progress;
            }
            
            // Barre de progression
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = `${progress}%`;
            }
            
            // Texte de progression
            const progressText = document.getElementById('progressText');
            if (progressText) {
                progressText.textContent = getProgressText(progress);
            }
            
            // Mettre √† jour l'en-t√™te du projet
            updateProjectHeaderProgress(progress);
        }

        // Obtenir le texte de progression
        function getProgressText(progress) {
            if (progress === 0) return 'Projet en cours de d√©marrage';
            if (progress < 25) return 'D√©but de projet - Phase de planification';
            if (progress < 50) return 'Projet en cours - Phase de d√©veloppement';
            if (progress < 75) return 'Projet avanc√© - Phase de finalisation';
            if (progress < 100) return 'Projet presque termin√© - Phase de validation';
            return 'Projet termin√© - Livraison compl√®te';
        }

        // Sauvegarder la progression du projet
        function saveProjectProgress(progress) {
            if (!currentProject) return;
            
            currentProject.progress = progress;
            currentProject.updatedAt = new Date().toISOString();
            
            // Sauvegarder dans le store
            localRepository.updateProject(currentProject.id, currentProject);
            
            // Recharger le journal
            loadJournalActions();
            
            console.log(`üìä Progression du projet mise √† jour: ${progress}%`);
        }

        // Mettre √† jour la progression dans l'en-t√™te du projet
        function updateProjectHeaderProgress(progress) {
            const progressText = document.getElementById('projectProgressText');
            const progressFill = document.getElementById('projectProgressFill');
            
            if (progressText) {
                progressText.textContent = `${progress}%`;
            }
            
            if (progressFill) {
                progressFill.style.width = `${progress}%`;
            }
        }

        // Charger les statistiques du projet
        function loadProjectStats() {
            if (!currentProject) return;
            
            // Compter les documents
            const documents = localRepository.getDocumentsByProject(currentProject.id);
            const documentsCount = documents.length;
            
            // Compter les t√¢ches
            const tasks = localRepository.getTasksByProject(currentProject.id);
            const tasksCount = tasks.length;
            
            // Compter les t√¢ches termin√©es
            const completedTasksCount = tasks.filter(task => task.status === 'done').length;
            
            // Calculer la dur√©e du projet
            const projectDuration = calculateProjectDuration();
            
            // Mettre √† jour l'affichage
            updateStatsDisplay({
                documents: documentsCount,
                tasks: tasksCount,
                completedTasks: completedTasksCount,
                duration: projectDuration
            });
        }

        // Calculer la dur√©e du projet en jours
        function calculateProjectDuration() {
            if (!currentProject || !currentProject.createdAt) return 0;
            
            const startDate = new Date(currentProject.createdAt);
            const currentDate = new Date();
            const diffTime = Math.abs(currentDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }

        // Mettre √† jour l'affichage des statistiques
        function updateStatsDisplay(stats) {
            const documentsCount = document.getElementById('documentsCount');
            const tasksCount = document.getElementById('tasksCount');
            const completedTasksCount = document.getElementById('completedTasksCount');
            const projectDuration = document.getElementById('projectDuration');
            
            if (documentsCount) documentsCount.textContent = stats.documents;
            if (tasksCount) tasksCount.textContent = stats.tasks;
            if (completedTasksCount) completedTasksCount.textContent = stats.completedTasks;
            if (projectDuration) projectDuration.textContent = stats.duration;
        }

        // ========================================
        // FONCTIONS MEMBRES DU PROJET
        // ========================================

        // Charger l'onglet membres
        function loadMembersTab() {
            if (!currentProject) return;
            
            // Charger le propri√©taire du projet
            loadProjectOwner();
            
            // Charger les membres du projet
            loadProjectMembers();
            
            // Charger la table des invitations
            loadInvitationsTable();
        }

        // Charger le propri√©taire du projet
        function loadProjectOwner() {
            if (!currentProject || !currentProject.ownerId) return;
            
            const owner = localRepository.getUser(currentProject.ownerId);
            if (!owner || !owner.name) return;
            
            // Mettre √† jour les √©l√©ments du propri√©taire
            const ownerName = document.getElementById('ownerName');
            const ownerEmail = document.getElementById('ownerEmail');
            const ownerInitials = document.getElementById('ownerInitials');
            
            if (ownerName) ownerName.textContent = owner.name;
            if (ownerEmail) ownerEmail.textContent = owner.email || 'Email non disponible';
            if (ownerInitials) {
                const initials = owner.name ? owner.name.split(' ').map(n => n[0]).join('').toUpperCase() : '??';
                ownerInitials.textContent = initials;
            }
        }

        // Charger les membres du projet
        function loadProjectMembers() {
            if (!currentProject || !currentProject.members) return;
            
            const membersList = document.getElementById('membersList');
            const membersEmptyState = document.getElementById('membersEmptyState');
            
            if (!membersList) return;
            
            // Filtrer les membres (exclure le propri√©taire)
            const members = currentProject.members.filter(member => member.userId !== currentProject.ownerId);
            
            if (members.length === 0) {
                // Afficher l'√©tat vide
                if (membersList) membersList.style.display = 'none';
                if (membersEmptyState) membersEmptyState.style.display = 'block';
                return;
            }
            
            // Masquer l'√©tat vide
            if (membersEmptyState) membersEmptyState.style.display = 'none';
            if (membersList) membersList.style.display = 'block';
            
            // Vider la liste
            membersList.innerHTML = '';
            
            // Ajouter chaque membre
            members.forEach(member => {
                const user = localRepository.getUser(member.userId);
                if (!user) return;
                
                const memberCard = createMemberCard(user, member);
                if (memberCard) {
                    membersList.appendChild(memberCard);
                }
            });
        }

        // Supprimer le projet
        function deleteProject() {
            if (!currentProject) {
                alert('‚ùå Aucun projet √† supprimer');
                return;
            }

            const currentUser = localRepository.getCurrentUser();
            if (!currentUser) {
                alert('‚ùå Vous devez √™tre connect√© pour supprimer un projet');
                return;
            }

            // V√©rifier que l'utilisateur est le propri√©taire du projet
            if (currentUser.id !== currentProject.ownerId && currentUser.role !== 'admin') {
                alert('‚ùå Seul le propri√©taire du projet ou un administrateur peut le supprimer');
                return;
            }

            // Demander confirmation
            const projectName = currentProject.name || 'ce projet';
            const confirmMessage = `‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer "${projectName}" ?\n\nCette action est irr√©versible et supprimera :\n‚Ä¢ Tous les documents du projet\n‚Ä¢ Toutes les t√¢ches\n‚Ä¢ Tous les commentaires\n‚Ä¢ Toutes les invitations\n‚Ä¢ L'historique du projet\n\nTapez "SUPPRIMER" pour confirmer :`;
            
            const userInput = prompt(confirmMessage);
            if (userInput !== 'SUPPRIMER') {
                console.log('‚ùå Suppression annul√©e par l\'utilisateur');
                return;
            }

            try {
                // Supprimer le projet et toutes ses donn√©es associ√©es
                localRepository.deleteProject(currentProject.id);
                
                // Cr√©er une notification de suppression
                localRepository.createNotification({
                    userId: currentUser.id,
                    type: 'project_deleted',
                    title: 'Projet supprim√©',
                    message: `Le projet "${projectName}" a √©t√© supprim√© avec succ√®s`,
                    read: false,
                    createdAt: new Date().toISOString()
                });

                console.log('‚úÖ Projet supprim√© avec succ√®s');
                alert('‚úÖ Projet supprim√© avec succ√®s');
                
                // Rediriger vers la liste des projets
                window.location.href = 'projects.html';
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la suppression du projet:', error);
                alert('‚ùå Erreur lors de la suppression : ' + error.message);
            }
        }

        // Modifier le projet
        function editProject() {
            if (!currentProject) {
                alert('‚ùå Aucun projet √† modifier');
                return;
            }

            const currentUser = localRepository.getCurrentUser();
            if (!currentUser) {
                alert('‚ùå Vous devez √™tre connect√© pour modifier un projet');
                return;
            }

            // V√©rifier que l'utilisateur est le propri√©taire du projet
            if (currentUser.id !== currentProject.ownerId && currentUser.role !== 'admin') {
                alert('‚ùå Seul le propri√©taire du projet ou un administrateur peut le modifier');
                return;
            }

            // Pr√©-remplir la modale avec les donn√©es actuelles
            document.getElementById('editProjectName').value = currentProject.name || '';
            document.getElementById('editProjectClient').value = currentProject.client || '';
            document.getElementById('editProjectDescription').value = currentProject.description || '';
            document.getElementById('editProjectLocation').value = currentProject.location || '';

            // Ouvrir la modale
            const modal = document.getElementById('editProjectModal');
            modal.classList.add('open');
            modal.style.display = 'flex';
        }

        // Fermer la modale de modification de projet
        function closeEditProjectModal() {
            const modal = document.getElementById('editProjectModal');
            modal.classList.remove('open');
            modal.style.display = 'none';
            
            // R√©initialiser le formulaire
            document.getElementById('editProjectForm').reset();
        }

        // Soumettre les modifications du projet
        function submitProjectEdit() {
            const name = document.getElementById('editProjectName').value.trim();
            const client = document.getElementById('editProjectClient').value.trim();
            const description = document.getElementById('editProjectDescription').value.trim();
            const location = document.getElementById('editProjectLocation').value.trim();

            // Validation
            if (!name) {
                alert('‚ùå Le nom du projet est obligatoire');
                return;
            }

            if (!client) {
                alert('‚ùå Le client du projet est obligatoire');
                return;
            }

            try {
                // Mettre √† jour le projet
                const updatedProject = {
                    ...currentProject,
                    name: name,
                    client: client,
                    description: description,
                    location: location,
                    updatedAt: new Date().toISOString()
                };

                // Sauvegarder les modifications
                localRepository.updateProject(updatedProject);
                currentProject = updatedProject;

                // Mettre √† jour l'affichage
                updateProjectHeader();
                loadProjectStats();

                // Cr√©er une notification de modification
                const currentUser = localRepository.getCurrentUser();
                localRepository.createNotification({
                    userId: currentUser.id,
                    type: 'project_updated',
                    title: 'Projet modifi√©',
                    message: `Le projet "${name}" a √©t√© modifi√© avec succ√®s`,
                    read: false,
                    createdAt: new Date().toISOString()
                });

                console.log('‚úÖ Projet modifi√© avec succ√®s');
                alert('‚úÖ Projet modifi√© avec succ√®s');
                
                // Fermer la modale
                closeEditProjectModal();
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la modification du projet:', error);
                alert('‚ùå Erreur lors de la modification : ' + error.message);
            }
        }

        // Cr√©er une carte membre
        function createMemberCard(user, member) {
            const card = document.createElement('div');
            card.className = 'member-card';
            
            // V√©rifier que l'utilisateur existe et a un nom
            if (!user || !user.name) return null;
            
            // G√©n√©rer les initiales
            const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
            
            // Formater la date d'ajout (utiliser joinedAt si disponible, sinon addedAt)
            const addedDate = (member.joinedAt || member.addedAt) ? 
                new Date(member.joinedAt || member.addedAt).toLocaleDateString('fr-FR') : 'Date inconnue';
            
            // Utiliser roleInProject si disponible, sinon le r√¥le global
            const roleToDisplay = member.roleInProject || member.role || user.role;
            
            // D√©finir la couleur du r√¥le
            const roleColors = {
                'architect': { bg: '#dbeafe', color: '#1e40af' },
                'bct': { bg: '#fef3c7', color: '#b45309' },
                'bet': { bg: '#d1fae5', color: '#047857' },
                'contractor': { bg: '#e0e7ff', color: '#3730a3' },
                'admin': { bg: '#fce7f3', color: '#be185d' }
            };
            
            const roleStyle = roleColors[roleToDisplay] || roleColors['architect'];
            
            card.innerHTML = `
                <div class="member-avatar" style="background-color: ${roleStyle.color};">
                    <span class="avatar-text">${initials}</span>
                </div>
                <div class="member-info">
                    <div class="member-name">${user.name}</div>
                    <div class="member-email">${user.email}</div>
                    <div class="member-role" style="background-color: ${roleStyle.bg}; color: ${roleStyle.color};">
                        ${getRoleLabel(roleToDisplay)}
                    </div>
                    <div class="member-date" style="font-size: 0.75rem; color: var(--color-text-secondary); margin-top: 0.25rem;">
                        Ajout√© le ${addedDate}
                    </div>
                </div>
                <div class="member-status">
                    <span class="status-badge" style="background-color: ${roleStyle.bg}; color: ${roleStyle.color};">
                        ${getRoleIcon(member.role)}
                    </span>
                </div>
            `;
            
            return card;
        }


        // Obtenir l'ic√¥ne du r√¥le
        function getRoleIcon(role) {
            const icons = {
                'architect': 'üèóÔ∏è',
                'bct': 'üîç',
                'bet': 'üìê',
                'contractor': 'üë∑',
                'admin': '‚öôÔ∏è'
            };
            return icons[role] || 'üë§';
        }

        // Afficher la modal d'invitation de membres
        function showInviteMembersModal() {
            const modal = document.getElementById('inviteMembersModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('open');
                
                // R√©initialiser le formulaire
                document.getElementById('inviteMembersForm').reset();
                document.getElementById('inviteResult').style.display = 'none';
                
                // Focus sur le premier champ
                document.getElementById('inviteEmail').focus();
            }
        }

        // Fermer la modale d'invitation
        function closeInviteModalHandler() {
            const modal = document.getElementById('inviteMembersModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('open');
            }
        }

        // Cr√©er une invitation
        function createInviteHandler() {
            try {
                const form = document.getElementById('inviteMembersForm');
                const formData = new FormData(form);
                
                const email = formData.get('email');
                const role = formData.get('role');
                const inviteType = formData.get('inviteType');
                const message = formData.get('message');

                if (!email || !role) {
                    alert('Veuillez remplir tous les champs obligatoires');
                    return;
                }

                if (!currentProject) {
                    alert('Aucun projet s√©lectionn√©');
                    return;
                }

                const currentUser = localRepository.getCurrentUser();
                if (!currentUser) {
                    alert('Utilisateur non connect√©');
                    return;
                }

                // Cr√©er l'invitation
                const inviteData = {
                    projectId: currentProject.id,
                    emailCible: email,
                    rolePropose: role,
                    creePar: currentUser.id
                };

                const invite = localRepository.createInvite(inviteData);
                console.log('‚úÖ Invitation cr√©√©e:', invite);

                // G√©n√©rer le lien d'invitation
                const baseUrl = window.location.origin + window.location.pathname;
                const inviteLink = `${baseUrl}?id=${currentProject.id}&invite=${invite.token}`;

                // Afficher le r√©sultat
                showInviteResult(invite, inviteLink, role);

                // Recharger la liste des invitations
                loadInvitationsTable();

            } catch (error) {
                console.error('‚ùå Erreur lors de la cr√©ation de l\'invitation:', error);
                alert('‚ùå Erreur : ' + error.message);
            }
        }

        // ========================================================================================
        // üìß √âTAPE 30 - FONCTIONS D'ENVOI D'E-MAILS (PR√âPARATION BACKEND)
        // ========================================================================================

        // Variable globale pour d√©tecter le mode backend
        window.GECC_BACKEND_AVAILABLE = false;

        // D√©tecter si le backend est disponible
        async function detectBackendMode() {
            try {
                const response = await fetch('/api/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    window.GECC_BACKEND_AVAILABLE = (data.status === 'ok');
                } else {
                    window.GECC_BACKEND_AVAILABLE = false;
                }
            } catch (error) {
                console.log('Backend non disponible, mode MVP activ√©:', error.message);
                window.GECC_BACKEND_AVAILABLE = false;
            }
            
            updateUIForCurrentMode();
        }

        // Mettre √† jour l'interface selon le mode d√©tect√©
        function updateUIForCurrentMode() {
            if (window.GECC_BACKEND_AVAILABLE) {
                updateUIForBackendMode();
            } else {
                updateUIForMVPMode();
            }
        }

        // Interface pour le mode backend (envoi automatique d'e-mails)
        function updateUIForBackendMode() {
            console.log('üîÑ Mode Backend activ√© - Envoi automatique d\'e-mails');
            
            // Mettre √† jour le bouton principal
            const createInviteText = document.getElementById('createInviteText');
            const createInviteIcon = document.getElementById('createInviteIcon');
            
            if (createInviteText) {
                createInviteText.textContent = 'üìß Envoyer l\'e-mail';
            }
            if (createInviteIcon) {
                createInviteIcon.textContent = 'üìß';
            }
            
            // Masquer les instructions MVP
            const mvpInstructions = document.getElementById('mvpInstructions');
            if (mvpInstructions) {
                mvpInstructions.style.display = 'none';
            }
        }

        // Interface pour le mode MVP (copie de lien)
        function updateUIForMVPMode() {
            console.log('üîÑ Mode MVP activ√© - Copie de lien d\'invitation');
            
            // Mettre √† jour le bouton principal
            const createInviteText = document.getElementById('createInviteText');
            const createInviteIcon = document.getElementById('createInviteIcon');
            
            if (createInviteText) {
                createInviteText.textContent = 'üìã Copier le lien';
            }
            if (createInviteIcon) {
                createInviteIcon.textContent = 'üìã';
            }
            
            // Afficher les instructions MVP
            const mvpInstructions = document.getElementById('mvpInstructions');
            if (mvpInstructions) {
                mvpInstructions.style.display = 'block';
            }
        }

        // Envoyer une invitation (mode adaptatif)
        async function sendInvitationEmail(invitationData) {
            try {
                if (window.GECC_BACKEND_AVAILABLE) {
                    // Mode backend - Envoi automatique
                    return await sendEmailViaBackend(invitationData);
                } else {
                    // Mode MVP - Copie du lien
                    return await copyInvitationLink(invitationData);
                }
            } catch (error) {
                console.error('Erreur envoi invitation:', error);
                showNotification('‚ùå Erreur lors de l\'envoi: ' + error.message, 'error');
                return { success: false, error: error.message };
            }
        }

        // Envoyer l'e-mail via le backend
        async function sendEmailViaBackend(invitationData) {
            const response = await fetch('/api/invitations/send-invitation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('gecc_token')}`
                },
                body: JSON.stringify(invitationData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('‚úÖ E-mail envoy√© avec succ√®s', 'success');
                return { success: true, messageId: result.messageId };
            } else {
                throw new Error(result.message);
            }
        }

        // Copier le lien d'invitation (mode MVP)
        async function copyInvitationLink(invitationData) {
            const { email, role, projectName, inviteLink } = invitationData;
            
            try {
                await navigator.clipboard.writeText(inviteLink);
                showNotification('‚úÖ Lien copi√© dans le presse-papiers', 'success');
                
                // Afficher les instructions MVP
                const mvpInstructions = document.getElementById('mvpInstructions');
                if (mvpInstructions) {
                    mvpInstructions.style.display = 'block';
                }
                
                return { success: true, mode: 'mvp' };
            } catch (error) {
                // Fallback pour les navigateurs plus anciens
                const textArea = document.createElement('textarea');
                textArea.value = inviteLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                showNotification('‚úÖ Lien copi√© dans le presse-papiers', 'success');
                return { success: true, mode: 'mvp' };
            }
        }

        // Afficher le r√©sultat de l'invitation (adaptatif)
        function showInviteResultAdaptive(invite, inviteLink, role, result) {
            const resultDiv = document.getElementById('inviteResult');
            const resultTitle = document.getElementById('resultTitle');
            const backendResult = document.getElementById('backendResult');
            const mvpResult = document.getElementById('mvpResult');
            const resultEmail = document.getElementById('resultEmail');
            const resultRole = document.getElementById('resultRole');
            const resultExpiry = document.getElementById('resultExpiry');
            const messageId = document.getElementById('messageId');

            if (resultDiv) {
                resultDiv.style.display = 'block';
            }

            // Mettre √† jour les informations communes
            if (resultEmail) resultEmail.textContent = invite.emailCible;
            if (resultRole) resultRole.textContent = role;
            if (resultExpiry) {
                const expiryDate = new Date(invite.expiresAt);
                resultExpiry.textContent = expiryDate.toLocaleDateString('fr-FR');
            }

            // Afficher le r√©sultat selon le mode
            if (window.GECC_BACKEND_AVAILABLE && result.success && result.messageId) {
                // Mode backend - E-mail envoy√©
                if (resultTitle) resultTitle.textContent = 'üìß E-mail envoy√© avec succ√®s';
                if (backendResult) backendResult.style.display = 'block';
                if (mvpResult) mvpResult.style.display = 'none';
                if (messageId) messageId.textContent = result.messageId;
            } else {
                // Mode MVP - Lien √† copier
                if (resultTitle) resultTitle.textContent = '‚úÖ Lien d\'invitation g√©n√©r√©';
                if (backendResult) backendResult.style.display = 'none';
                if (mvpResult) mvpResult.style.display = 'block';
                
                const linkInput = document.getElementById('generatedInviteLink');
                if (linkInput) {
                    linkInput.value = inviteLink;
                }
            }
        }

        // ========================================================================================
        // üß™ √âTAPE 31 - GESTION DES CAS LIMITES D'INVITATIONS
        // ========================================================================================

        // G√©rer les cas limites d'invitations
        function handleInvitationEdgeCases(invite, project, currentUser) {
            // Cas 1: Invitation expir√©e
            if (invite.isExpired()) {
                return {
                    type: 'expired',
                    message: '‚ùå Cette invitation a expir√©',
                    action: 'error',
                    showBanner: true,
                    bannerType: 'error'
                };
            }

            // Cas 2: Invitation d√©j√† accept√©e
            if (invite.status === 'accepted') {
                return {
                    type: 'already_accepted',
                    message: '‚úÖ Vous avez d√©j√† accept√© cette invitation',
                    action: 'redirect',
                    showBanner: true,
                    bannerType: 'success'
                };
            }

            // Cas 3: Invitation annul√©e
            if (invite.status === 'cancelled') {
                return {
                    type: 'cancelled',
                    message: '‚ùå Cette invitation a √©t√© annul√©e',
                    action: 'error',
                    showBanner: true,
                    bannerType: 'error'
                };
            }

            // Cas 4: Utilisateur d√©j√† membre du projet
            if (currentUser && project.isMember(currentUser.id)) {
                return {
                    type: 'already_member',
                    message: '‚ÑπÔ∏è Vous √™tes d√©j√† membre de ce projet',
                    action: 'redirect',
                    showBanner: true,
                    bannerType: 'info'
                };
            }

            // Cas normal - invitation valide
            return {
                type: 'valid',
                message: 'Invitation valide',
                action: 'proceed',
                showBanner: false
            };
        }

        // Afficher une banni√®re d'erreur ou d'info pour les cas limites
        function showInvitationEdgeCaseBanner(message, type = 'info', action = null) {
            // Supprimer toute banni√®re existante
            const existingBanner = document.getElementById('invitationBanner');
            if (existingBanner) {
                existingBanner.remove();
            }

            // Cr√©er la nouvelle banni√®re
            const banner = document.createElement('div');
            banner.id = 'invitationBanner';
            banner.className = `invitation-banner ${type}`;
            
            let bannerHTML = `
                <div class="banner-content">
                    <div class="banner-message">
                        <span class="banner-icon">${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
                        <span class="banner-text">${message}</span>
                    </div>
                    <button class="banner-close" onclick="closeInvitationBanner()">√ó</button>
                </div>
            `;

            // Ajouter des actions selon le type
            if (action === 'error') {
                bannerHTML += `
                    <div class="banner-actions">
                        <button class="btn btn-secondary btn-sm" onclick="requestNewInvitation()">
                            Demander une nouvelle invitation
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="contactProjectOwner()">
                            Contacter le propri√©taire
                        </button>
                    </div>
                `;
            } else if (action === 'redirect') {
                bannerHTML += `
                    <div class="banner-actions">
                        <button class="btn btn-primary btn-sm" onclick="redirectToProject()">
                            Acc√©der au projet
                        </button>
                    </div>
                `;
            }

            banner.innerHTML = bannerHTML;

            // Ins√©rer la banni√®re en haut de la page
            const mainContent = document.querySelector('.main-content') || document.body;
            mainContent.insertBefore(banner, mainContent.firstChild);

            // Auto-fermer apr√®s 10 secondes pour les messages d'info
            if (type === 'info' || type === 'success') {
                setTimeout(() => {
                    if (banner && banner.parentNode) {
                        banner.remove();
                    }
                }, 10000);
            }
        }

        // Fermer la banni√®re d'invitation
        function closeInvitationBanner() {
            const banner = document.getElementById('invitationBanner');
            if (banner) {
                banner.remove();
            }
        }

        // Actions pour les cas d'erreur
        function requestNewInvitation() {
            alert('Pour demander une nouvelle invitation, contactez le propri√©taire du projet.');
            closeInvitationBanner();
        }

        function contactProjectOwner() {
            alert('Contactez le propri√©taire du projet pour plus d\'informations.');
            closeInvitationBanner();
        }

        function redirectToProject() {
            // Rediriger vers le projet sans param√®tre d'invitation
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.delete('invite');
            window.location.href = currentUrl.toString();
        }

        // ========================================================================================

        // Afficher le r√©sultat de l'invitation
        function showInviteResult(invite, inviteLink, role) {
            const resultDiv = document.getElementById('inviteResult');
            const linkInput = document.getElementById('generatedInviteLink');
            const resultEmail = document.getElementById('resultEmail');
            const resultRole = document.getElementById('resultRole');
            const resultExpiry = document.getElementById('resultExpiry');

            if (linkInput) linkInput.value = inviteLink;
            if (resultEmail) resultEmail.textContent = invite.emailCible;
            if (resultRole) resultRole.textContent = getRoleLabel(role);
            if (resultExpiry) {
                const expiryDate = new Date(invite.expiresAt).toLocaleDateString('fr-FR');
                resultExpiry.textContent = expiryDate;
            }

            if (resultDiv) {
                resultDiv.style.display = 'block';
                resultDiv.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Copier le lien d'invitation
        function copyInviteLinkHandler() {
            const linkInput = document.getElementById('generatedInviteLink');
            if (linkInput) {
                linkInput.select();
                linkInput.setSelectionRange(0, 99999); // Pour mobile
                
                try {
                    document.execCommand('copy');
                    const btn = document.getElementById('copyInviteLink');
                    if (btn) {
                        const originalText = btn.textContent;
                        btn.textContent = '‚úÖ Copi√© !';
                        btn.style.background = 'var(--color-success)';
                        btn.style.color = 'white';
                        
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.style.background = '';
                            btn.style.color = '';
                        }, 2000);
                    }
                } catch (err) {
                    console.error('Erreur lors de la copie:', err);
                    alert('Impossible de copier automatiquement. Veuillez s√©lectionner et copier manuellement.');
                }
            }
        }

        // Charger la table des invitations
        function loadInvitationsTable() {
            if (!currentProject) return;

            const invites = localRepository.listInvites(currentProject.id);
            const tbody = document.getElementById('invitationsTableBody');
            const emptyState = document.getElementById('invitationsEmptyState');
            const table = document.getElementById('invitationsTable');

            if (!tbody) return;

            if (invites.length === 0) {
                if (table) table.style.display = 'none';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }

            if (table) table.style.display = 'table';
            if (emptyState) emptyState.style.display = 'none';

            tbody.innerHTML = '';

            invites.forEach(invite => {
                const row = createInvitationRow(invite);
                tbody.appendChild(row);
            });
        }

        // Cr√©er une ligne d'invitation
        function createInvitationRow(invite) {
            const row = document.createElement('tr');
            
            const createdDate = new Date(invite.createdAt).toLocaleDateString('fr-FR');
            const expiryDate = new Date(invite.expiresAt).toLocaleDateString('fr-FR');
            
            row.innerHTML = `
                <td class="invitation-email">${invite.emailCible}</td>
                <td>
                    <span class="invitation-role">${getRoleLabel(invite.rolePropose)}</span>
                </td>
                <td>
                    <span class="invitation-status ${invite.status}">${invite.getStatusLabel()}</span>
                </td>
                <td>${createdDate}</td>
                <td class="invitation-actions">
                    ${invite.status === 'pending' ? `
                        <button class="btn btn-secondary btn-sm" onclick="copyInviteLinkFromTable('${invite.token}')">
                            üìã Copier
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="cancelInviteFromTable('${invite.id}')">
                            ‚ùå Annuler
                        </button>
                    ` : ''}
                </td>
            `;
            
            return row;
        }

        // Copier le lien depuis la table
        window.copyInviteLinkFromTable = function(token) {
            const baseUrl = window.location.origin + window.location.pathname;
            const inviteLink = `${baseUrl}?id=${currentProject.id}&invite=${token}`;
            
            navigator.clipboard.writeText(inviteLink).then(() => {
                alert('‚úÖ Lien copi√© dans le presse-papiers !');
            }).catch(() => {
                // Fallback pour les navigateurs plus anciens
                const textArea = document.createElement('textarea');
                textArea.value = inviteLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ Lien copi√© dans le presse-papiers !');
            });
        }

        // Annuler une invitation depuis la table
        window.cancelInviteFromTable = function(inviteId) {
            if (confirm('√ätes-vous s√ªr de vouloir annuler cette invitation ?')) {
                try {
                    localRepository.cancelInvite(inviteId);
                    loadInvitationsTable();
                    alert('‚úÖ Invitation annul√©e');
                } catch (error) {
                    console.error('Erreur lors de l\'annulation:', error);
                    alert('‚ùå Erreur lors de l\'annulation : ' + error.message);
                }
            }
        }

        // ========================================
        // FONCTIONS GESTION DES INVITATIONS
        // ========================================

        // G√©rer le flux d'invitation
        function handleInvitationFlow(inviteToken, projectId) {
            try {
                // V√©rifier la validit√© de l'invitation
                const invite = localRepository.getInviteByToken(inviteToken);
                if (!invite) {
                    console.error('‚ùå Invitation non trouv√©e ou invalide');
                    showInvitationEdgeCaseBanner('‚ùå Invitation non trouv√©e ou invalide', 'error', 'error');
                    return;
                }

                // V√©rifier que le projet existe
                const project = localRepository.getProject(projectId);
                if (!project) {
                    console.error('‚ùå Projet non trouv√©:', projectId);
                    showInvitationEdgeCaseBanner('‚ùå Projet non trouv√©', 'error', 'error');
                    return;
                }

                // R√©cup√©rer l'utilisateur connect√©
                const currentUser = localRepository.getCurrentUser();

                // G√©rer les cas limites d'invitations
                const edgeCase = handleInvitationEdgeCases(invite, project, currentUser);
                
                if (edgeCase.type !== 'valid') {
                    console.log(`üß™ Cas limite d√©tect√©: ${edgeCase.type}`, edgeCase);
                    
                    // Afficher la banni√®re appropri√©e
                    if (edgeCase.showBanner) {
                        showInvitationEdgeCaseBanner(edgeCase.message, edgeCase.bannerType, edgeCase.action);
                    }
                    
                    // Ne pas alt√©rer les donn√©es pour les cas d'erreur
                    if (edgeCase.action === 'error') {
                        console.log('üõ°Ô∏è Protection des donn√©es: aucune modification effectu√©e');
                        return;
                    }
                    
                    // Rediriger pour les cas d'info
                    if (edgeCase.action === 'redirect') {
                        setTimeout(() => {
                            redirectToProject();
                        }, 2000);
                        return;
                    }
                }

                console.log('‚úÖ Invitation valide trouv√©e:', invite);

                // Plus de v√©rification d'authentification n√©cessaire

                // Afficher la banni√®re d'invitation
                showInvitationBanner(invite, project);

            } catch (error) {
                console.error('‚ùå Erreur lors du traitement de l\'invitation:', error);
                alert('‚ùå Erreur lors du traitement de l\'invitation: ' + error.message);
                window.location.href = 'projects.html';
            }
        }

        // Afficher la banni√®re d'invitation
        function showInvitationBanner(invite, project) {
            const banner = document.getElementById('invitationBanner');
            const roleElement = document.getElementById('invitationRole');
            
            if (!banner || !roleElement) {
                console.error('‚ùå √âl√©ments de la banni√®re non trouv√©s');
                return;
            }

            // Afficher le r√¥le propos√©
            roleElement.textContent = getRoleLabel(invite.rolePropose);
            
            // Afficher la banni√®re
            banner.style.display = 'block';
            
            // Charger les donn√©es du projet pour l'affichage
            currentProject = project;
            loadProjectDetails();
            setupTabs();
            setupEventListeners();
            loadDocumentsTable();
            loadKanbanBoard();
            loadTrackingTab();
            loadMembersTab();
            setupKeyboardNavigation();
            
            console.log('‚úÖ Banni√®re d\'invitation affich√©e');
        }

        // Accepter l'invitation
        function acceptInvitation() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const inviteToken = urlParams.get('invite');
                
                if (!inviteToken) {
                    alert('‚ùå Token d\'invitation manquant');
                    return;
                }

                const invite = localRepository.getInviteByToken(inviteToken);
                if (!invite) {
                    alert('‚ùå Invitation non trouv√©e');
                    return;
                }

                const currentUser = localRepository.getCurrentUser();
                if (!currentUser) {
                    alert('‚ùå Utilisateur non connect√©');
                    return;
                }

                // V√©rifier si l'utilisateur n'est pas d√©j√† membre du projet
                const project = localRepository.getProject(invite.projectId);
                if (!project) {
                    alert('‚ùå Projet non trouv√©');
                    return;
                }

                // V√©rifier si l'utilisateur est d√©j√† membre
                const existingMember = project.members.find(member => member.userId === currentUser.id);
                if (existingMember) {
                    alert('‚úÖ Vous √™tes d√©j√† membre de ce projet');
                    hideInvitationBanner();
                    return;
                }

                // Ajouter l'utilisateur au projet avec le r√¥le propos√©
                const newMember = {
                    userId: currentUser.id,
                    roleInProject: invite.rolePropose,
                    joinedAt: new Date().toISOString()
                };

                project.members.push(newMember);
                localRepository.updateProject(project);

                // Marquer l'invitation comme accept√©e
                localRepository.acceptInvite(inviteToken, currentUser.id);

                // Cr√©er une notification pour le propri√©taire
                const notification = {
                    id: 'notif-' + Date.now(),
                    userId: project.ownerId,
                    type: 'invitation_accepted',
                    title: 'Invitation accept√©e',
                    message: `${currentUser.name} a accept√© l'invitation en tant que ${getRoleLabel(invite.rolePropose)}`,
                    read: false,
                    createdAt: new Date().toISOString(),
                    projectId: project.id
                };
                localRepository.createNotification(notification);

                // Masquer la banni√®re
                hideInvitationBanner();

            // Recharger la liste des membres
            loadMembersTab();

            // Mettre √† jour les permissions UI
            updateUIPermissions();

            // Afficher un message de succ√®s
            alert('‚úÖ Invitation accept√©e ! Vous √™tes maintenant membre du projet.');

                // Nettoyer l'URL
                const newUrl = window.location.pathname + '?id=' + project.id;
                window.history.replaceState({}, '', newUrl);

                console.log('‚úÖ Invitation accept√©e avec succ√®s');

            } catch (error) {
                console.error('‚ùå Erreur lors de l\'acceptation de l\'invitation:', error);
                alert('‚ùå Erreur lors de l\'acceptation: ' + error.message);
            }
        }

        // Refuser l'invitation
        function declineInvitation() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const inviteToken = urlParams.get('invite');
                
                if (!inviteToken) {
                    alert('‚ùå Token d\'invitation manquant');
                    return;
                }

                const invite = localRepository.getInviteByToken(inviteToken);
                if (!invite) {
                    alert('‚ùå Invitation non trouv√©e');
                    return;
                }

                // Marquer l'invitation comme annul√©e
                localRepository.cancelInvite(invite.id);

                // Masquer la banni√®re
                hideInvitationBanner();

                // Rediriger vers la page des projets
                window.location.href = 'projects.html';

                console.log('‚úÖ Invitation refus√©e');

            } catch (error) {
                console.error('‚ùå Erreur lors du refus de l\'invitation:', error);
                alert('‚ùå Erreur lors du refus: ' + error.message);
            }
        }

        // Masquer la banni√®re d'invitation
        function hideInvitationBanner() {
            const banner = document.getElementById('invitationBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }

        // ========================================
        // FONCTIONS √âCHANGES ET COMMENTAIRES
        // ========================================

        // Charger l'onglet d'√©changes
        function loadExchangesTab() {
            if (!currentProject) return;
            
            // Charger les commentaires
            loadComments();
        }

        // Charger les commentaires du projet
        function loadComments() {
            if (!currentProject) return;
            
            const comments = localRepository.getCommentsByProject(currentProject.id);
            const commentsList = document.getElementById('commentsList');
            const commentsEmptyState = document.getElementById('commentsEmptyState');
            const commentsCount = document.getElementById('commentsCount');
            
            // Mettre √† jour le compteur
            if (commentsCount) {
                const count = comments.length;
                commentsCount.textContent = `${count} commentaire${count > 1 ? 's' : ''}`;
            }
            
            if (comments.length === 0) {
                commentsList.style.display = 'none';
                commentsEmptyState.style.display = 'block';
                return;
            }
            
            commentsList.style.display = 'block';
            commentsEmptyState.style.display = 'none';
            
            // Trier les commentaires par date (plus r√©cents en premier)
            const sortedComments = comments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // G√©n√©rer le HTML des commentaires
            commentsList.innerHTML = sortedComments.map(comment => createCommentElement(comment)).join('');
        }

        // Cr√©er un √©l√©ment de commentaire
        function createCommentElement(comment) {
            // Utiliser le nom stock√© dans le commentaire ou r√©cup√©rer depuis l'utilisateur
            const author = localRepository.getUser(comment.authorId);
            const authorName = comment.authorName || (author ? author.name : 'Utilisateur inconnu');
            const authorRole = author ? getRoleLabel(author.role) : 'N/A';
            const authorInitial = authorName && authorName.length > 0 ? authorName.charAt(0).toUpperCase() : '?';
            const commentDate = new Date(comment.createdAt).toLocaleString('fr-FR');
            const currentUser = localRepository.getCurrentUser();
            const userRoleInProject = getCurrentUserRoleInProject();
            const canDelete = currentUser && (currentUser.id === comment.authorId || userRoleInProject === 'admin' || currentUser.role === 'admin');
            
            return `
                <div class="comment-item" data-comment-id="${comment.id}">
                    <div class="comment-header">
                        <div class="comment-author">
                            <div class="comment-avatar">${authorInitial}</div>
                            <div class="comment-author-info">
                                <div class="comment-author-name">${authorName}</div>
                                <div class="comment-author-role">${authorRole}</div>
                            </div>
                        </div>
                        <div class="comment-date">${commentDate}</div>
                    </div>
                    <div class="comment-content">${escapeHtml(comment.content)}</div>
                    ${canDelete ? `
                        <div class="comment-actions">
                            <button class="comment-action-btn delete" onclick="deleteComment('${comment.id}')">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // G√©rer la soumission du formulaire de commentaire
        function handleCommentSubmit(e) {
            e.preventDefault();
            
            // V√©rifier l'appartenance au projet
            if (!isCurrentUserProjectMember()) {
                showNonMemberAlert();
                return;
            }
            
            const formData = new FormData(e.target);
            const text = formData.get('text').trim();
            
            if (!text) {
                alert('Veuillez saisir un message');
                return;
            }
            
            if (!currentProject) {
                alert('Erreur: Projet non trouv√©');
                return;
            }
            
            const currentUser = localRepository.getCurrentUser();
            if (!currentUser) {
                alert('Erreur: Utilisateur non connect√©');
                return;
            }
            
            // Cr√©er le commentaire
            const commentData = {
                projectId: currentProject.id,
                content: text,  // Le mod√®le Comment attend 'content', pas 'text'
                authorId: currentUser.id,
                authorName: currentUser.name,  // Ajouter le nom de l'auteur
                createdAt: new Date().toISOString()
            };
            
            const comment = localRepository.createComment(commentData);
            
            // Recharger la liste des commentaires
            loadComments();
            
            // Recharger le journal
            loadJournalActions();
            
            // Cr√©er des notifications
            createProjectNotification(
                'comment_added',
                'Nouveau commentaire',
                `Un nouveau commentaire a √©t√© ajout√© au projet par ${currentUser.name}`,
                currentProject.id,
                { commentId: comment.id }
            );
            
            // Mettre √† jour le badge de notification
            updateNotificationBadge();
            
            // Vider le formulaire
            e.target.reset();
            
            alert('Commentaire publi√© avec succ√®s !');
        }

        // Supprimer un commentaire - Fonction globale
        window.deleteComment = function(commentId) {
            // V√©rifier l'appartenance au projet
            if (!isCurrentUserProjectMember()) {
                showNonMemberAlert();
                return;
            }

            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce commentaire ?')) {
                return;
            }
            
            const success = localRepository.deleteComment(commentId);
            if (success) {
                console.log('üí¨ Commentaire supprim√©:', commentId);
                loadComments();
                alert('Commentaire supprim√© avec succ√®s !');
            } else {
                alert('Erreur lors de la suppression du commentaire');
            }
        };

        // Fonction utilitaire pour √©chapper le HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // FONCTIONS NOTIFICATIONS
        // ========================================

        // Cr√©er une notification pour le propri√©taire du projet
        function createProjectNotification(type, title, message, projectId, additionalData = {}) {
            if (!currentProject || !currentProject.ownerId) return;
            
            const notificationData = {
                userId: currentProject.ownerId,
                type: type,
                title: title,
                message: message,
                projectId: projectId,
                actionUrl: `project.html?id=${projectId}`,
                ...additionalData
            };
            
            const notification = localRepository.createNotification(notificationData);
            console.log('üîî Notification cr√©√©e:', notification);
            return notification;
        }

        // Cr√©er une notification pour un utilisateur sp√©cifique
        function createUserNotification(userId, type, title, message, projectId, additionalData = {}) {
            const notificationData = {
                userId: userId,
                type: type,
                title: title,
                message: message,
                projectId: projectId,
                actionUrl: `project.html?id=${projectId}`,
                ...additionalData
            };
            
            const notification = localRepository.createNotification(notificationData);
            console.log('üîî Notification cr√©√©e pour utilisateur:', notification);
            return notification;
        }

        // Cr√©er des notifications pour les destinataires d'un document
        function createDocumentNotifications(document, action, actionLabel) {
            if (!document || !document.targetRoles) return;
            
            const currentUser = localRepository.getCurrentUser();
            const project = localRepository.getProject(document.projectId);
            if (!project) return;
            
            // Notification pour le propri√©taire du projet
            createProjectNotification(
                action === 'submitted' ? 'document_submitted' : 
                action === 'approved' ? 'document_approved' : 
                action === 'rejected' ? 'document_rejected' : 'project_update',
                `${actionLabel} - ${document.name}`,
                `Le document "${document.name}" a √©t√© ${actionLabel.toLowerCase()} par ${currentUser.name}`,
                document.projectId,
                { documentId: document.id }
            );
            
            // Notifications pour les autres destinataires du document
            document.targetRoles.forEach(role => {
                const roleUsers = project.members.filter(member => member.role === role);
                roleUsers.forEach(member => {
                    if (member.userId !== currentUser.id) {
                        createUserNotification(
                            member.userId,
                            action === 'submitted' ? 'document_submitted' : 
                            action === 'approved' ? 'document_approved' : 
                            action === 'rejected' ? 'document_rejected' : 'project_update',
                            `${actionLabel} - ${document.name}`,
                            `Le document "${document.name}" a √©t√© ${actionLabel.toLowerCase()} par ${currentUser.name}`,
                            document.projectId,
                            { documentId: document.id }
                        );
                    }
                });
            });
        }

        // ========================================
        // FONCTIONS JOURNAL D'AUDIT
        // ========================================

        // Charger l'onglet de journal
        function loadJournalTab() {
            if (!currentProject) return;
            
            // Charger les actions du journal
            loadJournalActions();
        }

        // Charger les actions du journal
        function loadJournalActions(filter = 'all') {
            if (!currentProject) return;
            
            const allActions = [];
            
            // R√©cup√©rer les actions des documents
            const documents = localRepository.getDocumentsByProject(currentProject.id);
            documents.forEach(doc => {
                if (doc.history && doc.history.length > 0) {
                    doc.history.forEach(historyEntry => {
                        allActions.push({
                            id: `${doc.id}-${historyEntry.timestamp}`,
                            type: 'document',
                            timestamp: historyEntry.timestamp,
                            title: `${getActionLabel(historyEntry.action)} - ${doc.name}`,
                            description: `Document "${doc.name}" - ${getActionDescription(historyEntry.action, doc)}`,
                            authorId: historyEntry.userId,
                            documentId: doc.id,
                            action: historyEntry.action,
                            comment: historyEntry.comment
                        });
                    });
                } else {
                    // Action de cr√©ation du document
                    allActions.push({
                        id: `${doc.id}-created`,
                        type: 'document',
                        timestamp: doc.submittedAt || doc.createdAt,
                        title: `Cr√©ation - ${doc.name}`,
                        description: `Document "${doc.name}" cr√©√©`,
                        authorId: doc.submittedBy || doc.createdBy,
                        documentId: doc.id,
                        action: 'created'
                    });
                }
            });
            
            // R√©cup√©rer les actions des t√¢ches
            const tasks = localRepository.getTasksByProject(currentProject.id);
            tasks.forEach(task => {
                allActions.push({
                    id: `${task.id}-created`,
                    type: 'task',
                    timestamp: task.createdAt,
                    title: `Nouvelle t√¢che - ${task.title}`,
                    description: `T√¢che "${task.title}" cr√©√©e avec priorit√© ${getPriorityLabel(task.priority)}`,
                    authorId: task.createdBy,
                    taskId: task.id,
                    action: 'created'
                });
                
                if (task.updatedAt && task.updatedAt !== task.createdAt) {
                    allActions.push({
                        id: `${task.id}-updated`,
                        type: 'task',
                        timestamp: task.updatedAt,
                        title: `T√¢che mise √† jour - ${task.title}`,
                        description: `T√¢che "${task.title}" d√©plac√©e vers ${getTaskStatusLabel(task.status)}`,
                        authorId: task.assignedTo,
                        taskId: task.id,
                        action: 'updated'
                    });
                }
            });
            
            // R√©cup√©rer les actions des commentaires
            const comments = localRepository.getCommentsByProject(currentProject.id);
            comments.forEach(comment => {
                allActions.push({
                    id: `${comment.id}-created`,
                    type: 'comment',
                    timestamp: comment.createdAt,
                    title: `Nouveau commentaire`,
                    description: `Commentaire ajout√© au projet`,
                    authorId: comment.authorId,
                    commentId: comment.id,
                    action: 'created'
                });
            });
            
            // R√©cup√©rer les actions du projet
            if (currentProject.updatedAt && currentProject.updatedAt !== currentProject.createdAt) {
                allActions.push({
                    id: `${currentProject.id}-updated`,
                    type: 'project',
                    timestamp: currentProject.updatedAt,
                    title: `Projet mis √† jour`,
                    description: `Progression du projet mise √† jour √† ${currentProject.progress || 0}%`,
                    authorId: currentProject.ownerId,
                    projectId: currentProject.id,
                    action: 'updated'
                });
            }
            
            // Filtrer les actions
            const filteredActions = filter === 'all' ? allActions : allActions.filter(action => action.type === filter);
            
            // Trier par date (plus r√©cent en premier)
            const sortedActions = filteredActions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Afficher les actions
            displayJournalActions(sortedActions);
        }

        // Afficher les actions du journal
        function displayJournalActions(actions) {
            const journalList = document.getElementById('journalList');
            const journalEmptyState = document.getElementById('journalEmptyState');
            const journalCount = document.getElementById('journalCount');
            
            // Mettre √† jour le compteur
            if (journalCount) {
                const count = actions.length;
                journalCount.textContent = `${count} action${count > 1 ? 's' : ''}`;
            }
            
            if (actions.length === 0) {
                journalList.style.display = 'none';
                journalEmptyState.style.display = 'block';
                return;
            }
            
            journalList.style.display = 'block';
            journalEmptyState.style.display = 'none';
            
            // G√©n√©rer le HTML des actions
            journalList.innerHTML = actions.map(action => createJournalItemElement(action)).join('');
        }

        // Cr√©er un √©l√©ment d'action du journal
        function createJournalItemElement(action) {
            const author = localRepository.getUser(action.authorId);
            const authorName = author ? author.name : 'Utilisateur inconnu';
            const authorInitial = authorName && authorName.length > 0 ? authorName.charAt(0).toUpperCase() : '?';
            const actionDate = new Date(action.timestamp).toLocaleString('fr-FR');
            const actionIcon = getActionIcon(action.type);
            const typeLabel = getTypeLabel(action.type);
            
            return `
                <div class="journal-action-item" data-action-id="${action.id}">
                    <div class="journal-action-header">
                        <div class="journal-action-info">
                            <div class="journal-action-icon">${actionIcon}</div>
                            <div class="journal-action-details">
                                <div class="journal-action-title">${action.title}</div>
                                <div class="journal-action-type">${typeLabel}</div>
                            </div>
                        </div>
                        <div class="journal-action-date">${actionDate}</div>
                    </div>
                    <div class="journal-action-content">${action.description}</div>
                    <div class="journal-action-meta">
                        <div class="journal-action-user">
                            <div class="journal-action-user-avatar">${authorInitial}</div>
                            <span>Par ${authorName}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // G√©rer le changement de filtre du journal
        function handleJournalFilter(e) {
            const filter = e.target.value;
            loadJournalActions(filter);
        }

        // Fonctions utilitaires pour le journal
        function getActionLabel(action) {
            const labels = {
                'created': 'Cr√©ation',
                'submitted': 'Soumission',
                'approved': 'Validation',
                'rejected': 'Refus',
                'observations': 'Observations',
                'revised': 'R√©vision',
                'updated': 'Mise √† jour'
            };
            return labels[action] || action;
        }

        function getActionDescription(action, doc) {
            const descriptions = {
                'created': 'Document cr√©√©',
                'submitted': 'Document soumis pour validation',
                'approved': 'Document valid√©',
                'rejected': 'Document refus√©',
                'observations': 'Document avec observations',
                'revised': 'Document r√©vis√©'
            };
            return descriptions[action] || 'Action effectu√©e';
        }

        function getActionIcon(type) {
            const icons = {
                'document': 'üìÑ',
                'task': '‚úÖ',
                'comment': 'üí¨',
                'project': 'üìä'
            };
            return icons[type] || 'üìù';
        }

        function getTypeLabel(type) {
            const labels = {
                'document': 'Document',
                'task': 'T√¢che',
                'comment': 'Commentaire',
                'project': 'Projet'
            };
            return labels[type] || type;
        }

        function getTaskStatusLabel(status) {
            const labels = {
                'todo': '√Ä faire',
                'in_progress': 'En cours',
                'review': 'En revue',
                'completed': 'Termin√©'
            };
            return labels[status] || status;
        }

        // ========================================
        // ANIMATIONS ET EFFETS VISUELS
        // ========================================

        // Animation au changement de fichier
        function setupFileUploadAnimation() {
            const fileInput = document.getElementById('documentFile');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const label = document.querySelector('.file-upload-label span:last-child');
                    if (e.target.files.length > 0) {
                        label.textContent = `üìÅ ${e.target.files[0].name}`;
                        label.parentElement.style.borderColor = '#667eea';
                        label.parentElement.style.background = 'rgba(102, 126, 234, 0.1)';
                    }
                });
            }
        }

        // Effet de ripple sur les boutons
        function setupRippleEffect() {
            document.querySelectorAll('.document-modal .btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const rect = button.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    ripple.style.position = 'absolute';
                    ripple.style.borderRadius = '50%';
                    ripple.style.background = 'rgba(255, 255, 255, 0.3)';
                    ripple.style.transform = 'scale(0)';
                    ripple.style.animation = 'ripple 0.6s linear';
                    ripple.style.pointerEvents = 'none';
                    
                    button.appendChild(ripple);
                    
                    setTimeout(() => ripple.remove(), 600);
                });
            });
        }

        // Ajouter les styles pour l'animation ripple
        function addRippleStyles() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes ripple {
                    to {
                        transform: scale(2);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        // ========================================
        // FONCTIONNALIT√â D'IMPRESSION
        // ========================================
        
        function setupPrintFunctionality() {
            const printBtn = document.getElementById('printBtn');
            const printProjectBtn = document.getElementById('printProjectBtn');
            
            if (printBtn) {
                printBtn.addEventListener('click', handlePrint);
            }
            
            if (printProjectBtn) {
                printProjectBtn.addEventListener('click', handlePrint);
            }
        }
        
        function handlePrint() {
            // Pr√©parer le contenu pour l'impression
            preparePrintContent();
            
            // Lancer l'impression
            window.print();
        }
        
        function preparePrintContent() {
            // Ajouter des classes pour l'impression
            const projectHeader = document.querySelector('.project-header');
            if (projectHeader) {
                projectHeader.classList.add('project-header');
            }
            
            // Ajouter un footer d'impression
            addPrintFooter();
            
            // Optimiser les tableaux pour l'impression
            optimizeTablesForPrint();
        }
        
        function addPrintFooter() {
            // Supprimer l'ancien footer s'il existe
            const existingFooter = document.querySelector('.print-footer');
            if (existingFooter) {
                existingFooter.remove();
            }
            
            // Cr√©er le footer d'impression
            const footer = document.createElement('div');
            footer.className = 'print-footer';
            footer.innerHTML = `
                <div>GECC - Gestion √âlectronique des Contrats de Construction</div>
                <div>Imprim√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}</div>
            `;
            
            document.body.appendChild(footer);
        }
        
        function optimizeTablesForPrint() {
            const tables = document.querySelectorAll('table');
            tables.forEach(table => {
                // Ajouter des classes pour l'impression
                table.classList.add('no-break');
                
                // Optimiser les cellules
                const cells = table.querySelectorAll('td, th');
                cells.forEach(cell => {
                    // √âviter les coupures dans les cellules
                    cell.style.pageBreakInside = 'avoid';
                });
            });
        }

        // Initialiser la page quand le DOM est pr√™t
        document.addEventListener('DOMContentLoaded', () => {
            init();
            setupFileUploadAnimation();
            setupRippleEffect();
            addRippleStyles();
            setupPrintFunctionality();
            setupCsvImport();
            
            // Initialiser l'affichage des profils
            if (window.profileDisplay) {
                window.profileDisplay.updateAllDisplays();
            }
        });
        
        // ========================================
        // IMPORT CSV DE MEMBRES
        // ========================================
        
        function setupCsvImport() {
            // Bouton d'import CSV
            const importCsvBtn = document.getElementById('importCsvBtn');
            if (importCsvBtn) {
                importCsvBtn.addEventListener('click', showImportCsvModal);
            }
            
            // Boutons de la modal
            const closeImportCsvModal = document.getElementById('closeImportCsvModal');
            const cancelImportCsvBtn = document.getElementById('cancelImportCsvBtn');
            const processCsvBtn = document.getElementById('processCsvBtn');
            const csvFileInput = document.getElementById('csvFile');
            
            if (closeImportCsvModal) {
                closeImportCsvModal.addEventListener('click', closeImportCsvModalHandler);
            }
            if (cancelImportCsvBtn) {
                cancelImportCsvBtn.addEventListener('click', closeImportCsvModalHandler);
            }
            if (processCsvBtn) {
                processCsvBtn.addEventListener('click', processCsvFile);
            }
            if (csvFileInput) {
                csvFileInput.addEventListener('change', handleCsvFileSelect);
            }
        }
        
        // Afficher la modal d'import CSV
        function showImportCsvModal() {
            const modal = document.getElementById('importCsvModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('open');
                
                // R√©initialiser le formulaire
                document.getElementById('importCsvForm').reset();
                document.getElementById('importResult').style.display = 'none';
                document.getElementById('processCsvBtn').disabled = true;
            }
        }
        
        // Fermer la modal d'import CSV
        function closeImportCsvModalHandler() {
            const modal = document.getElementById('importCsvModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('open');
            }
        }
        
        // G√©rer la s√©lection du fichier CSV
        function handleCsvFileSelect(e) {
            const file = e.target.files[0];
            const processBtn = document.getElementById('processCsvBtn');
            
            if (file && file.type === 'text/csv') {
                processBtn.disabled = false;
            } else {
                processBtn.disabled = true;
                if (file) {
                    alert('Veuillez s√©lectionner un fichier CSV valide.');
                }
            }
        }
        
        // Traiter le fichier CSV
        function processCsvFile() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Veuillez s√©lectionner un fichier CSV.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const results = parseCsvAndProcess(csvContent);
                    displayImportResults(results);
                } catch (error) {
                    console.error('Erreur lors du traitement du CSV:', error);
                    alert('Erreur lors du traitement du fichier CSV: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }
        
        // Parser le CSV et traiter les donn√©es
        function parseCsvAndProcess(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            
            // V√©rifier les en-t√™tes requis
            const requiredHeaders = ['name', 'email', 'roleinproject'];
            const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
            
            if (missingHeaders.length > 0) {
                throw new Error(`Colonnes manquantes: ${missingHeaders.join(', ')}`);
            }
            
            const results = {
                totalProcessed: 0,
                membersAdded: 0,
                invitationsCreated: 0,
                errors: 0,
                details: []
            };
            
            // Traiter chaque ligne
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCsvLine(line);
                if (values.length !== headers.length) {
                    results.errors++;
                    results.details.push({
                        type: 'error',
                        message: `Ligne ${i + 1}: Nombre de colonnes incorrect`
                    });
                    continue;
                }
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index].trim();
                });
                
                results.totalProcessed++;
                
                try {
                    processCsvRow(row, results);
                } catch (error) {
                    results.errors++;
                    results.details.push({
                        type: 'error',
                        message: `Ligne ${i + 1}: ${error.message}`
                    });
                }
            }
            
            return results;
        }
        
        // Parser une ligne CSV (g√®re les virgules dans les guillemets)
        function parseCsvLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        // Traiter une ligne du CSV
        function processCsvRow(row, results) {
            const { name, email, roleinproject } = row;
            
            // Validation des donn√©es
            if (!name || !email || !roleinproject) {
                throw new Error('Donn√©es manquantes');
            }
            
            if (!isValidEmail(email)) {
                throw new Error(`Email invalide: ${email}`);
            }
            
            const validRoles = ['architect', 'bct', 'bet', 'contractor', 'admin'];
            if (!validRoles.includes(roleinproject.toLowerCase())) {
                throw new Error(`R√¥le invalide: ${roleinproject}`);
            }
            
            // V√©rifier si l'utilisateur existe d√©j√†
            const existingUser = localRepository.getUserByEmail(email);
            
            if (existingUser) {
                // Utilisateur existe - l'ajouter comme membre
                const memberData = {
                    userId: existingUser.id,
                    roleInProject: roleinproject.toLowerCase(),
                    joinedAt: new Date().toISOString(),
                    invitedBy: localRepository.getCurrentUser().id
                };
                
                currentProject.addMember(existingUser.id, roleinproject.toLowerCase());
                localRepository.updateProject(currentProject.id, currentProject);
                
                results.membersAdded++;
                results.details.push({
                    type: 'success',
                    message: `Membre ajout√©: ${name} (${email}) ‚Üí ${roleinproject}`
                });
            } else {
                // Utilisateur n'existe pas - cr√©er une invitation
                const invitationData = {
                    projectId: currentProject.id,
                    emailCible: email,
                    rolePropose: roleinproject.toLowerCase(),
                    creePar: localRepository.getCurrentUser().id,
                    status: 'pending',
                    token: generateId(),
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
                };
                
                const invitation = localRepository.createInvite(invitationData);
                
                results.invitationsCreated++;
                results.details.push({
                    type: 'info',
                    message: `Invitation cr√©√©e: ${name} (${email}) ‚Üí ${roleinproject}`
                });
            }
        }
        
        // Afficher les r√©sultats de l'import
        function displayImportResults(results) {
            const importResult = document.getElementById('importResult');
            const totalProcessed = document.getElementById('totalProcessed');
            const membersAdded = document.getElementById('membersAdded');
            const invitationsCreated = document.getElementById('invitationsCreated');
            const errorsCount = document.getElementById('errorsCount');
            const importDetails = document.getElementById('importDetails');
            
            if (importResult) {
                importResult.style.display = 'block';
            }
            
            if (totalProcessed) totalProcessed.textContent = results.totalProcessed;
            if (membersAdded) membersAdded.textContent = results.membersAdded;
            if (invitationsCreated) invitationsCreated.textContent = results.invitationsCreated;
            if (errorsCount) errorsCount.textContent = results.errors;
            
            if (importDetails) {
                importDetails.innerHTML = results.details.map(detail => 
                    `<div class="detail-item ${detail.type}">${detail.message}</div>`
                ).join('');
            }
            
            // Recharger les onglets
            loadMembersTab();
            loadInvitationsTable();
        }
        
        // Fonction utilitaire pour valider un email
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // T√©l√©charger un document
        window.downloadDocument = function(docId) {
            const documents = localRepository.getProjectDocuments(currentProject.id);
            const doc = documents.find(d => d.id === docId);
            if (!doc) {
                alert('‚ùå Document non trouv√©');
                return;
            }
            
            // Simuler le t√©l√©chargement
            const link = document.createElement('a');
            link.href = doc.url || '#';
            link.download = doc.name;
            link.click();
            
            console.log(`üì• T√©l√©chargement de: ${doc.name}`);
        };

        // Soumettre un document
        window.submitDocument = function(docId) {
            const documents = localRepository.getProjectDocuments(currentProject.id);
            const doc = documents.find(d => d.id === docId);
            if (!doc) {
                alert('‚ùå Document non trouv√©');
                return;
            }
            
            const currentUser = localRepository.getCurrentUser();
            
            // Debug: Afficher les informations
            console.log('üîç Debug soumission document:');
            console.log('- Document:', doc);
            console.log('- Utilisateur:', currentUser);
            console.log('- Statut document:', doc.status);
            console.log('- Peut soumettre:', canSubmitDocument(doc, currentUser));
            
            if (!canSubmitDocument(doc, currentUser)) {
                alert('‚ùå Vous n\'avez pas les permissions pour soumettre ce document');
                return;
            }
            
            doc.status = 'submitted';
            doc.submittedAt = new Date().toISOString();
            localRepository.updateDocument(doc);
            
            // Recharger la liste des documents
            loadDocumentsTable();
            alert('‚úÖ Document soumis avec succ√®s');
        };

        // R√©viser un document
        window.reviseDocument = function(docId) {
            if (!canReviseDocument()) {
                alert('‚ùå Vous n\'avez pas les permissions pour r√©viser ce document');
                return;
            }
            
            const doc = currentProject.documents.find(d => d.id === docId);
            if (!doc) {
                alert('‚ùå Document non trouv√©');
                return;
            }
            
            doc.status = 'revised';
            doc.revisedAt = new Date().toISOString();
            localRepository.updateProject(currentProject.id, currentProject);
            
            loadDocumentsTab();
            alert('‚úÖ Document marqu√© comme r√©vis√©');
        };

        // R√©viser un document (approbation/refus/observations)
        window.reviewDocument = function(docId, action) {
            if (!canReviewDocument()) {
                alert('‚ùå Vous n\'avez pas les permissions pour r√©viser ce document');
                return;
            }
            
            const doc = currentProject.documents.find(d => d.id === docId);
            if (!doc) {
                alert('‚ùå Document non trouv√©');
                return;
            }
            
            if (action === 'approve') {
                doc.status = 'approved';
                doc.approvedAt = new Date().toISOString();
                alert('‚úÖ Document approuv√©');
            } else if (action === 'reject') {
                doc.status = 'rejected';
                doc.rejectedAt = new Date().toISOString();
                alert('‚úÖ Document refus√©');
            } else if (action === 'observations') {
                const observations = prompt('Ajoutez vos observations :');
                if (observations) {
                    doc.observations = observations;
                    doc.status = 'needs_revision';
                    doc.observationsAt = new Date().toISOString();
                    alert('‚úÖ Observations ajout√©es');
                }
            }
            
            localRepository.updateProject(currentProject.id, currentProject);
            loadDocumentsTab();
        };

        // Afficher l'historique d'un document
        window.showDocumentHistory = function(docId) {
            const documents = localRepository.getProjectDocuments(currentProject.id);
            const doc = documents.find(d => d.id === docId);
            if (!doc) {
                alert('‚ùå Document non trouv√©');
                return;
            }
            
            let history = `üìã Historique du document: ${doc.name}\n\n`;
            history += `üìÖ Cr√©√©: ${new Date(doc.createdAt).toLocaleString('fr-FR')}\n`;
            
            if (doc.submittedAt) {
                history += `üì§ Soumis: ${new Date(doc.submittedAt).toLocaleString('fr-FR')}\n`;
            }
            if (doc.revisedAt) {
                history += `‚úèÔ∏è R√©vis√©: ${new Date(doc.revisedAt).toLocaleString('fr-FR')}\n`;
            }
            if (doc.approvedAt) {
                history += `‚úÖ Approuv√©: ${new Date(doc.approvedAt).toLocaleString('fr-FR')}\n`;
            }
            if (doc.rejectedAt) {
                history += `‚ùå Refus√©: ${new Date(doc.rejectedAt).toLocaleString('fr-FR')}\n`;
            }
            if (doc.observations) {
                history += `üí¨ Observations: ${doc.observations}\n`;
            }
            
            alert(history);
        };

        // Supprimer un commentaire
        window.deleteComment = function(commentId) {
            if (!isCurrentUserProjectMember()) {
                showNonMemberAlert();
                return;
            }
            
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce commentaire ?')) {
                try {
                    localRepository.deleteComment(commentId);
                    loadCommentsTab();
                    alert('‚úÖ Commentaire supprim√©');
                } catch (error) {
                    console.error('Erreur lors de la suppression:', error);
                    alert('‚ùå Erreur lors de la suppression : ' + error.message);
                }
            }
        };
        
        // ========================================
        // GESTION DE L'EN-T√äTE UTILISATEUR
        // ========================================
        
        // Charger les informations utilisateur dans l'en-t√™te
        function loadUserHeaderInfo() {
            try {
                const savedUser = localStorage.getItem('geccp-currentUser');
                if (!savedUser) {
                    console.log('Aucun utilisateur connect√©');
                    return;
                }
                
                const currentUser = JSON.parse(savedUser);
                
                // Mettre √† jour l'avatar
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar) {
                    if (currentUser.fullName) {
                        const initials = currentUser.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
                        userAvatar.textContent = initials;
                    } else {
                        userAvatar.textContent = 'U';
                    }
                }
                
                // Mettre √† jour le nom
                const userName = document.getElementById('userName');
                if (userName) {
                    userName.textContent = currentUser.fullName || 'Utilisateur';
                }
                
                // Mettre √† jour le r√¥le
                const userRole = document.getElementById('userRole');
                if (userRole) {
                    const roleMap = {
                        'ADMIN': 'Administrateur',
                        'SUPER_ADMIN': 'Super Administrateur',
                        'ARCHITECT': 'Architecte',
                        'ENGINEER': 'Ing√©nieur',
                        'CONTRACTOR': 'Entrepreneur',
                        'BET': 'Bureau d\'√âtudes Techniques',
                        'CLIENT': 'Client'
                    };
                    userRole.textContent = roleMap[currentUser.role] || currentUser.role;
                }
                
                // G√©rer l'affichage du lien d'administration
                const adminLink = document.getElementById('adminLink');
                if (adminLink) {
                    console.log('R√¥le utilisateur:', currentUser.role); // Debug
                    if (currentUser.role === 'ADMIN' || currentUser.role === 'SUPER_ADMIN' || 
                        currentUser.role === 'Administrator' || currentUser.role === 'admin') {
                        adminLink.style.display = 'block';
                        console.log('Lien d\'administration affich√©'); // Debug
                    } else {
                        adminLink.style.display = 'none';
                        console.log('Lien d\'administration masqu√©'); // Debug
                    }
                }
                
            } catch (error) {
                console.error('Erreur lors du chargement des informations utilisateur:', error);
            }
        }
        
        // G√©rer la navigation vers l'accueil
        function handleHomeNavigation() {
            const homeBtn = document.getElementById('logoutBtn');
            if (homeBtn) {
                // Le lien redirigera naturellement vers landing.html
            }
        }
        
        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            loadUserHeaderInfo();
            handleHomeNavigation();
            
            // √âcouter les mises √† jour de profil
            window.addEventListener('profileUpdated', function(event) {
                console.log('üîÑ Profil mis √† jour, rechargement des informations...');
                loadUserHeaderInfo();
            });
            
            // √âcouter les changements de localStorage
            window.addEventListener('storage', function(event) {
                if (event.key === 'geccp-currentUser') {
                    console.log('üîÑ Utilisateur modifi√© dans localStorage, mise √† jour...');
                    loadUserHeaderInfo();
                }
            });
        });
    </script>
    <script src="js/theme-manager.js"></script>
    <script src="js/profile-display.js"></script>
</body>
</html>

