# üöÄ GECC Backend API

API Backend s√©curis√©e pour GECC - Gestion √âlectronique des Contrats de Construction.

## üìã Table des mati√®res

- [Installation](#installation)
- [Configuration](#configuration)
- [D√©marrage](#d√©marrage)
- [API Endpoints](#api-endpoints)
- [Migration depuis localStorage](#migration-depuis-localstorage)
- [S√©curit√©](#s√©curit√©)
- [D√©veloppement](#d√©veloppement)

## üõ†Ô∏è Installation

### Pr√©requis

- Node.js 16+ 
- npm ou yarn

### Installation des d√©pendances

```bash
cd backend
npm install
```

## ‚öôÔ∏è Configuration

1. Copiez le fichier de configuration :
```bash
cp env.example .env
```

2. Modifiez les variables dans `.env` :
```env
# Configuration du serveur
PORT=3000
NODE_ENV=development

# Base de donn√©es
DB_PATH=./database/gecc.db

# JWT Configuration (CHANGEZ CES CL√âS EN PRODUCTION !)
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
JWT_EXPIRES_IN=15m
REFRESH_SECRET=your-super-secret-refresh-key-change-this-in-production
REFRESH_EXPIRES_IN=7d

# Upload Configuration
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=10485760

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# CORS
CORS_ORIGIN=http://localhost:8000
```

## üöÄ D√©marrage

### 1. Initialiser la base de donn√©es

```bash
npm run init-db
```

### 2. D√©marrer le serveur

**Mode d√©veloppement :**
```bash
npm run dev
```

**Mode production :**
```bash
npm start
```

Le serveur sera accessible sur `http://localhost:3000`

### 3. V√©rifier la sant√© du serveur

```bash
curl http://localhost:3000/health
```

## üì° API Endpoints

### üîê Authentification

| M√©thode | Endpoint | Description | Auth |
|---------|----------|-------------|------|
| POST | `/api/auth/register` | Inscription | ‚ùå |
| POST | `/api/auth/login` | Connexion | ‚ùå |
| POST | `/api/auth/refresh` | Renouveler token | ‚ùå |
| POST | `/api/auth/logout` | D√©connexion | ‚úÖ |
| GET | `/api/auth/me` | Profil utilisateur | ‚úÖ |

### üèóÔ∏è Projets

| M√©thode | Endpoint | Description | Auth |
|---------|----------|-------------|------|
| GET | `/api/projects` | Mes projets | ‚úÖ |
| GET | `/api/projects/all` | Tous les projets (admin) | ‚úÖ |
| GET | `/api/projects/:id` | D√©tails projet | ‚úÖ |
| POST | `/api/projects` | Cr√©er projet | ‚úÖ |
| PUT | `/api/projects/:id` | Modifier projet | ‚úÖ |
| DELETE | `/api/projects/:id` | Supprimer projet | ‚úÖ |
| GET | `/api/projects/:id/members` | Membres du projet | ‚úÖ |
| POST | `/api/projects/:id/members` | Ajouter membre | ‚úÖ |
| PUT | `/api/projects/:id/members/:userId` | Modifier r√¥le | ‚úÖ |
| DELETE | `/api/projects/:id/members/:userId` | Supprimer membre | ‚úÖ |

### üìÑ Documents

| M√©thode | Endpoint | Description | Auth |
|---------|----------|-------------|------|
| GET | `/api/documents/project/:projectId` | Documents du projet | ‚úÖ |
| GET | `/api/documents/:id` | D√©tails document | ‚úÖ |
| POST | `/api/documents` | Cr√©er document | ‚úÖ |
| PUT | `/api/documents/:id/status` | Changer statut | ‚úÖ |
| GET | `/api/documents/:id/history` | Historique document | ‚úÖ |
| GET | `/api/documents/:id/download` | T√©l√©charger document | ‚úÖ |
| DELETE | `/api/documents/:id` | Supprimer document | ‚úÖ |

### ‚úÖ T√¢ches

| M√©thode | Endpoint | Description | Auth |
|---------|----------|-------------|------|
| GET | `/api/tasks/project/:projectId` | T√¢ches du projet | ‚úÖ |
| POST | `/api/tasks` | Cr√©er t√¢che | ‚úÖ |
| PUT | `/api/tasks/:id` | Modifier t√¢che | ‚úÖ |
| DELETE | `/api/tasks/:id` | Supprimer t√¢che | ‚úÖ |

### üí¨ Commentaires

| M√©thode | Endpoint | Description | Auth |
|---------|----------|-------------|------|
| GET | `/api/comments/project/:projectId` | Commentaires du projet | ‚úÖ |
| POST | `/api/comments` | Cr√©er commentaire | ‚úÖ |
| PUT | `/api/comments/:id` | Modifier commentaire | ‚úÖ |
| DELETE | `/api/comments/:id` | Supprimer commentaire | ‚úÖ |

### üîî Notifications

| M√©thode | Endpoint | Description | Auth |
|---------|----------|-------------|------|
| GET | `/api/notifications` | Mes notifications | ‚úÖ |
| PUT | `/api/notifications/:id/read` | Marquer comme lue | ‚úÖ |
| PUT | `/api/notifications/read-all` | Tout marquer comme lu | ‚úÖ |
| DELETE | `/api/notifications/:id` | Supprimer notification | ‚úÖ |

## üîÑ Migration depuis localStorage

### √âtape 1 : Modifier le frontend

Remplacez les appels √† `localStorage` par des appels API :

**Avant (localStorage) :**
```javascript
// js/store.js
const projects = JSON.parse(localStorage.getItem('projects'));
localStorage.setItem('projects', JSON.stringify(projects));
```

**Apr√®s (API) :**
```javascript
// js/api.js
const response = await fetch('/api/projects', {
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});
const data = await response.json();
```

### √âtape 2 : Gestion de l'authentification

**Avant :**
```javascript
// Session stock√©e en localStorage
localStorage.setItem('currentUser', JSON.stringify(user));
```

**Apr√®s :**
```javascript
// Token JWT stock√© en localStorage
localStorage.setItem('accessToken', response.accessToken);
localStorage.setItem('refreshToken', response.refreshToken);
```

### √âtape 3 : Migration des donn√©es

1. **Exporter les donn√©es localStorage :**
```javascript
// Script de migration
const exportData = () => {
  const data = {
    users: JSON.parse(localStorage.getItem('users') || '[]'),
    projects: JSON.parse(localStorage.getItem('projects') || '[]'),
    documents: JSON.parse(localStorage.getItem('documents') || '[]'),
    tasks: JSON.parse(localStorage.getItem('tasks') || '[]'),
    comments: JSON.parse(localStorage.getItem('comments') || '[]')
  };
  
  // Sauvegarder dans un fichier JSON
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'gecc-data-export.json';
  a.click();
};
```

2. **Importer via l'API :**
```javascript
// Script d'import
const importData = async (data) => {
  // Cr√©er les utilisateurs
  for (const user of data.users) {
    await fetch('/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: user.name,
        email: user.email,
        password: 'temp-password-123', // √Ä changer apr√®s
        role: user.role
      })
    });
  }
  
  // Cr√©er les projets
  for (const project of data.projects) {
    await fetch('/api/projects', {
      method: 'POST',
      headers: { 
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json' 
      },
      body: JSON.stringify(project)
    });
  }
  
  // ... autres entit√©s
};
```

### √âtape 4 : Mise √† jour du frontend

1. **Cr√©er un module API :**
```javascript
// js/api.js
class APIClient {
  constructor(baseURL = 'http://localhost:3000') {
    this.baseURL = baseURL;
    this.token = localStorage.getItem('accessToken');
  }

  async request(endpoint, options = {}) {
    const url = `${this.baseURL}${endpoint}`;
    const config = {
      headers: {
        'Content-Type': 'application/json',
        ...(this.token && { 'Authorization': `Bearer ${this.token}` }),
        ...options.headers
      },
      ...options
    };

    const response = await fetch(url, config);
    
    if (response.status === 401) {
      // Token expir√©, essayer de le renouveler
      await this.refreshToken();
      return this.request(endpoint, options);
    }
    
    return response.json();
  }

  async refreshToken() {
    const refreshToken = localStorage.getItem('refreshToken');
    const response = await fetch(`${this.baseURL}/api/auth/refresh`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ refreshToken })
    });
    
    const data = await response.json();
    this.token = data.accessToken;
    localStorage.setItem('accessToken', data.accessToken);
  }

  // M√©thodes pour chaque entit√©
  async getProjects() {
    return this.request('/api/projects');
  }

  async createProject(projectData) {
    return this.request('/api/projects', {
      method: 'POST',
      body: JSON.stringify(projectData)
    });
  }

  // ... autres m√©thodes
}

export default new APIClient();
```

2. **Remplacer les appels dans les modules :**
```javascript
// js/projects.js
import api from './api.js';

class ProjectsManager {
  async loadProjects() {
    try {
      const response = await api.getProjects();
      this.projects = response.projects;
      this.renderProjects();
    } catch (error) {
      console.error('Erreur lors du chargement des projets:', error);
    }
  }

  async createProject(projectData) {
    try {
      const response = await api.createProject(projectData);
      this.projects.push(response.project);
      this.renderProjects();
      return response.project;
    } catch (error) {
      console.error('Erreur lors de la cr√©ation du projet:', error);
      throw error;
    }
  }
}
```

## üîí S√©curit√©

### Authentification JWT

- **Access Token** : Expire en 15 minutes
- **Refresh Token** : Expire en 7 jours
- **Rotation automatique** des tokens

### Middleware de s√©curit√©

- **Helmet** : Headers s√©curis√©s
- **CORS** : Configuration restrictive
- **Rate Limiting** : Protection contre les attaques par d√©ni de service
- **Validation** : Sanitisation des entr√©es

### Base de donn√©es

- **SQLite** avec contraintes d'int√©grit√©
- **Cl√©s √©trang√®res** activ√©es
- **Index** pour les performances

## üõ†Ô∏è D√©veloppement

### Structure du projet

```
backend/
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ init.js          # Initialisation SQLite
‚îÇ   ‚îî‚îÄ‚îÄ gecc.db          # Base de donn√©es (cr√©√©e automatiquement)
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ auth.js          # Authentification JWT
‚îÇ   ‚îî‚îÄ‚îÄ errorHandler.js  # Gestion d'erreurs
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ User.js          # Mod√®le utilisateur
‚îÇ   ‚îî‚îÄ‚îÄ Project.js       # Mod√®le projet
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ auth.js          # Routes authentification
‚îÇ   ‚îú‚îÄ‚îÄ projects.js      # Routes projets
‚îÇ   ‚îú‚îÄ‚îÄ documents.js     # Routes documents
‚îÇ   ‚îú‚îÄ‚îÄ tasks.js         # Routes t√¢ches
‚îÇ   ‚îú‚îÄ‚îÄ comments.js      # Routes commentaires
‚îÇ   ‚îî‚îÄ‚îÄ notifications.js # Routes notifications
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ init-database.js # Script d'initialisation
‚îú‚îÄ‚îÄ uploads/             # Fichiers upload√©s
‚îú‚îÄ‚îÄ server.js            # Serveur principal
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ README.md
```

### Scripts disponibles

```bash
npm start          # D√©marrer en production
npm run dev        # D√©marrer en d√©veloppement (nodemon)
npm run init-db    # Initialiser la base de donn√©es
```

### Variables d'environnement

| Variable | Description | D√©faut |
|----------|-------------|---------|
| `PORT` | Port du serveur | `3000` |
| `NODE_ENV` | Environnement | `development` |
| `DB_PATH` | Chemin base de donn√©es | `./database/gecc.db` |
| `JWT_SECRET` | Cl√© secr√®te JWT | **OBLIGATOIRE** |
| `REFRESH_SECRET` | Cl√© refresh token | **OBLIGATOIRE** |
| `UPLOAD_PATH` | Dossier uploads | `./uploads` |
| `MAX_FILE_SIZE` | Taille max fichier | `10485760` (10MB) |
| `CORS_ORIGIN` | Origine CORS | `http://localhost:8000` |

## üöÄ D√©ploiement

### Production

1. **Variables d'environnement :**
```bash
export NODE_ENV=production
export JWT_SECRET=your-super-secure-secret-key
export REFRESH_SECRET=your-super-secure-refresh-key
export CORS_ORIGIN=https://yourdomain.com
```

2. **D√©marrage :**
```bash
npm start
```

### Docker (optionnel)

```dockerfile
FROM node:16-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

## üìù Notes importantes

- ‚ö†Ô∏è **Changez les cl√©s JWT** en production
- üîí **Utilisez HTTPS** en production
- üìä **Configurez les logs** pour le monitoring
- üóÑÔ∏è **Sauvegardez r√©guli√®rement** la base de donn√©es
- üîÑ **Planifiez la rotation** des cl√©s JWT

## üÜò Support

Pour toute question ou probl√®me :

1. V√©rifiez les logs du serveur
2. Consultez la documentation des endpoints
3. V√©rifiez la configuration des variables d'environnement
4. Testez avec les comptes de d√©monstration

---

**üéâ F√©licitations !** Votre API GECC est maintenant pr√™te pour la production avec une s√©curit√© renforc√©e.