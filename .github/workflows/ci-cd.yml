name: ğŸš€ CI/CD GECC

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  NPM_VERSION: '9'

jobs:
  # ========================================
  # VÃ‰RIFICATIONS PRÃ‰LIMINAIRES
  # ========================================
  check:
    name: ğŸ” VÃ©rifications
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies (Frontend)
        run: npm install

      - name: ğŸ“¦ Install dependencies (Backend)
        run: |
          cd server
          npm install

      - name: ğŸ” Lint Frontend
        run: |
          # VÃ©rifier la syntaxe des fichiers JS
          find . -name "*.js" -not -path "./node_modules/*" -not -path "./server/node_modules/*" -exec node -c {} \;

      - name: ğŸ” Lint Backend
        run: |
          cd server
          npm run lint || echo "Linting non configurÃ©"

      - name: ğŸ§ª Test Backend
        run: |
          cd server
          npm run test || echo "Tests non configurÃ©s"

  # ========================================
  # BUILD ET TEST
  # ========================================
  build:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: check
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm install
          cd server && npm install

      - name: ğŸ§ª Run tests
        run: |
          cd server
          npm run test || echo "Tests non configurÃ©s"

      - name: ğŸ” Security audit
        run: |
          npm audit --audit-level moderate || true
          cd server && npm audit --audit-level moderate || true

      - name: ğŸ“Š Build check
        run: |
          echo "VÃ©rification de la structure du projet..."
          ls -la
          ls -la server/

  # ========================================
  # DÃ‰PLOIEMENT STAGING
  # ========================================
  deploy-staging:
    name: ğŸš€ Deploy Staging
    runs-on: ubuntu-latest
    needs: [check, build]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          npm install
          cd server && npm install

      - name: ğŸ—„ï¸ Database migration (Staging)
        run: |
          cd server
          echo "Simulation des migrations pour staging"
          # npm run migrate || echo "Migrations non configurÃ©es"

      - name: ğŸš€ Deploy to Railway (Staging)
        if: env.RAILWAY_TOKEN
        run: |
          echo "DÃ©ploiement vers Railway staging..."
          # Ici vous pourriez ajouter les commandes Railway CLI

      - name: ğŸš€ Deploy to Vercel (Staging)
        if: env.VERCEL_TOKEN
        run: |
          echo "DÃ©ploiement vers Vercel staging..."
          # Ici vous pourriez ajouter les commandes Vercel CLI

      - name: ğŸ” Health check (Staging)
        run: |
          echo "VÃ©rification de la santÃ© de l'application staging..."
          # Ajouter des vÃ©rifications d'endpoints

  # ========================================
  # DÃ‰PLOIEMENT PRODUCTION
  # ========================================
  deploy-production:
    name: ğŸš€ Deploy Production
    runs-on: ubuntu-latest
    needs: [check, build]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          npm install
          cd server && npm install

      - name: ğŸ—„ï¸ Database migration (Production)
        run: |
          cd server
          echo "Simulation des migrations pour production"
          # npm run migrate || echo "Migrations non configurÃ©es"

      - name: ğŸš€ Deploy to Railway (Production)
        if: env.RAILWAY_TOKEN
        run: |
          echo "DÃ©ploiement vers Railway production..."
          # Ici vous pourriez ajouter les commandes Railway CLI

      - name: ğŸš€ Deploy to Vercel (Production)
        if: env.VERCEL_TOKEN
        run: |
          echo "DÃ©ploiement vers Vercel production..."
          # Ici vous pourriez ajouter les commandes Vercel CLI

      - name: ğŸ” Health check (Production)
        run: |
          echo "VÃ©rification de la santÃ© de l'application production..."
          # Ajouter des vÃ©rifications d'endpoints

      - name: ğŸ“¢ Notify deployment
        run: |
          echo "DÃ©ploiement en production terminÃ©!"
          # Ici vous pourriez ajouter des notifications (Slack, Discord, etc.)

  # ========================================
  # NETTOYAGE
  # ========================================
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    steps:
      - name: ğŸ§¹ Cleanup artifacts
        run: |
          echo "Nettoyage des artifacts..."
          # Nettoyage des fichiers temporaires si nÃ©cessaire
