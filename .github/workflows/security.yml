name: ðŸ”’ Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1'  # Chaque lundi Ã  2h du matin

env:
  NODE_VERSION: '18'

jobs:
  # ========================================
  # AUDIT DE SÃ‰CURITÃ‰
  # ========================================
  security-audit:
    name: ðŸ” Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm install
          cd server && npm install

      - name: ðŸ” NPM Audit (Frontend)
        run: |
          npm audit --audit-level moderate --json > frontend-audit.json || true
          npm audit --audit-level moderate

      - name: ðŸ” NPM Audit (Backend)
        run: |
          cd server
          npm audit --audit-level moderate --json > ../backend-audit.json || true
          npm audit --audit-level moderate

      - name: ðŸ“Š Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results
          path: |
            frontend-audit.json
            backend-audit.json

  # ========================================
  # ANALYSE DE CODE
  # ========================================
  code-analysis:
    name: ðŸ” Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: |
          npm install
          cd server && npm install

      - name: ðŸ” ESLint Security Plugin
        run: |
          cd server
          npx eslint-plugin-security || echo "Plugin de sÃ©curitÃ© non installÃ©"

      - name: ðŸ” Check for hardcoded secrets
        run: |
          # VÃ©rifier les mots de passe en dur
          if grep -r "password.*=" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âš ï¸ Mots de passe potentiels dÃ©tectÃ©s"
          fi
          
          # VÃ©rifier les clÃ©s API en dur
          if grep -r "api.*key.*=" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âš ï¸ ClÃ©s API potentielles dÃ©tectÃ©es"
          fi

  # ========================================
  # VULNÃ‰RABILITÃ‰S
  # ========================================
  vulnerability-scan:
    name: ðŸ›¡ï¸ Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: |
          npm install
          cd server && npm install

      - name: ðŸ›¡ï¸ Snyk Security Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: ðŸ›¡ï¸ OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'GECC'
          path: '.'
          format: 'JSON'
          args: >
            --enableRetired
            --enableExperimental
            --failOnCVSS 7

  # ========================================
  # CONFIGURATION SÃ‰CURISÃ‰E
  # ========================================
  security-config:
    name: âš™ï¸ Security Configuration
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Check .env files
        run: |
          # VÃ©rifier qu'aucun fichier .env n'est commitÃ©
          if find . -name ".env" -not -path "./.git/*"; then
            echo "âŒ Fichiers .env dÃ©tectÃ©s dans le repository"
            exit 1
          fi
          echo "âœ… Aucun fichier .env commitÃ©"

      - name: ðŸ” Check .gitignore
        run: |
          # VÃ©rifier que .gitignore contient les bonnes exclusions
          if ! grep -q "\.env" .gitignore; then
            echo "âŒ .env non exclu dans .gitignore"
            exit 1
          fi
          echo "âœ… .gitignore correctement configurÃ©"

      - name: ðŸ” Check for secrets in code
        run: |
          # VÃ©rifier les patterns de secrets communs
          if grep -r "sk_live_" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ ClÃ©s Stripe en dur dÃ©tectÃ©es"
            exit 1
          fi
          
          if grep -r "AKIA" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ ClÃ©s AWS en dur dÃ©tectÃ©es"
            exit 1
          fi
          
          echo "âœ… Aucun secret dÃ©tectÃ© dans le code"

  # ========================================
  # RAPPORT DE SÃ‰CURITÃ‰
  # ========================================
  security-report:
    name: ðŸ“Š Security Report
    runs-on: ubuntu-latest
    needs: [security-audit, code-analysis, vulnerability-scan, security-config]
    if: always()
    steps:
      - name: ðŸ“¥ Download audit results
        uses: actions/download-artifact@v4
        with:
          name: security-audit-results
          path: ./audit-results

      - name: ðŸ“Š Generate security report
        run: |
          echo "# ðŸ”’ Rapport de SÃ©curitÃ© GECC" > security-report.md
          echo "" >> security-report.md
          echo "Date: $(date)" >> security-report.md
          echo "Commit: ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md
          
          echo "## ðŸ“‹ RÃ©sumÃ©" >> security-report.md
          echo "- Audit NPM: ${{ needs.security-audit.result }}" >> security-report.md
          echo "- Analyse de code: ${{ needs.code-analysis.result }}" >> security-report.md
          echo "- Scan de vulnÃ©rabilitÃ©s: ${{ needs.vulnerability-scan.result }}" >> security-report.md
          echo "- Configuration: ${{ needs.security-config.result }}" >> security-report.md
          echo "" >> security-report.md
          
          echo "## ðŸ” DÃ©tails" >> security-report.md
          if [ -f "./audit-results/frontend-audit.json" ]; then
            echo "### Frontend Audit" >> security-report.md
            cat ./audit-results/frontend-audit.json >> security-report.md
            echo "" >> security-report.md
          fi
          
          if [ -f "./audit-results/backend-audit.json" ]; then
            echo "### Backend Audit" >> security-report.md
            cat ./audit-results/backend-audit.json >> security-report.md
            echo "" >> security-report.md
          fi

      - name: ðŸ“¤ Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md

      - name: ðŸ“¢ Comment PR with security report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
