<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projets - GECC</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta name="description" content="Gestion des projets GECC - Liste, cr√©ation et suivi des projets de construction">
    <meta name="theme-color" content="#667eea">
    <link rel="stylesheet" href="styles/design-system.css?v=3.0">
    <link rel="stylesheet" href="styles/header-design.css">
    <link rel="stylesheet" href="styles/projects.css?v=3.0">
    
    <style>
        /* Correction imm√©diate de l'espacement des boutons de navigation */
        .header .nav {
            gap: 24px !important;
        }
        
        .header .nav-link {
            padding: 12px 20px !important;
            margin: 0 8px !important;
            white-space: nowrap !important;
        }
        
        /* Assurer que les boutons ne se collent pas */
        .header .nav-link:not(:last-child) {
            margin-right: 16px !important;
        }
        
        /* Style pour les s√©parateurs de navigation */
        .nav-separator {
            color: #cbd5e1 !important;
            font-weight: 300 !important;
            margin: 0 8px !important;
            user-select: none !important;
        }
        
        /* Espacement forc√© entre les √©l√©ments de navigation */
        .header .nav > * {
            margin: 0 12px !important;
        }
        
        /* Correction de la superposition du bouton Accueil et du profil */
        .header .user-section {
            position: relative !important;
            z-index: 10 !important;
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
        }
        
        .header .logout-btn {
            position: relative !important;
            z-index: 11 !important;
            margin-left: 8px !important;
        }
        
        /* Assurer que le header ne d√©borde pas */
        .header .container {
            overflow: visible !important;
            position: relative !important;
        }
        
        /* Style pour le logo PNG */
        .header .logo-icon {
            background: transparent !important; /* Enlever le fond violet */
            box-shadow: none !important; /* Enlever l'ombre */
        }
        
        .header .logo-icon img {
            width: 32px !important;
            height: 32px !important;
            object-fit: contain !important;
            /* Pas de filtre n√©cessaire car le PNG a un fond transparent */
        }
    </style>
</head>
<body>
    <!-- 
    ========================================
    PAGE PROJETS - LISTE ET GESTION
    ========================================
    R√¥le : Gestion des projets BTP
    - Affichage de la liste des projets
    - Filtrage et recherche
    - Cr√©ation de nouveaux projets
    - √âdition et suppression
    - Navigation vers le d√©tail d'un projet
    ========================================
    -->
    
    <header class="header">
        <div class="container">
            <div class="logo">
                <div class="logo-icon">
                    <img src="assets/logo-removebg-preview.png" alt="GECC Logo" style="width: 32px; height: 32px;">
                </div>
                <div class="logo-text">GECC PROJECT</div>
            </div>
            <nav class="nav">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <span class="nav-separator">|</span>
                <a href="projects.html" class="nav-link active">Projets</a>
                <span class="nav-separator">|</span>
                <a href="profile.html" class="nav-link">Mon Profil</a>
                <span class="nav-separator">|</span>
                <a href="settings.html" class="nav-link">Param√®tres</a>
                <a href="admin.html" class="nav-link admin-link" id="adminLink" style="display: none;">üëë Administration</a>
            </nav>
            <div class="user-section">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">JD</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Jean Dupont</div>
                        <div class="user-role" id="userRole">Administrateur</div>
                    </div>
                </div>
                <a href="#" class="logout-btn" id="logoutBtn">
                    <span>üö™</span>
                    D√©connexion
                </a>
            </div>
        </div>
    </header>
    <hr class="header-separator">

    <main class="main">
        <div class="container">
            <div class="page-header">
                <h2>Gestion des Projets</h2>
                <button id="createProjectBtn" class="btn btn-primary">Nouveau Projet</button>
            </div>

            <div class="filters-section">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Rechercher un projet...">
                    <button id="searchBtn" class="btn btn-secondary">Rechercher</button>
                </div>
                
                <div class="filters">
                    <select id="statusFilter">
                        <option value="">Tous les statuts</option>
                        <option value="draft">Brouillon</option>
                        <option value="active">Actif</option>
                        <option value="completed">Termin√©</option>
                        <option value="on_hold">En attente</option>
                        <option value="cancelled">Annul√©</option>
                    </select>
                    
                    <select id="roleFilter">
                        <option value="">Tous les r√¥les</option>
                        <option value="architect">Architecte</option>
                        <option value="bct">BCT</option>
                        <option value="bet">BET</option>
                        <option value="contractor">Entreprise</option>
                    </select>
                </div>
            </div>

            <div class="projects-container">
                <div class="table-container">
                    <table class="table" id="projectsTable">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Nom</th>
                                <th>Localisation</th>
                                <th>Ma√Ætre d'ouvrage</th>
                                <th>Statut</th>
                                <th>Date de cr√©ation</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <!-- Liste des projets -->
                        </tbody>
                    </table>
                </div>
                
                <div class="projects-empty" id="projectsEmpty" style="display: none;">
                    <div class="empty-state">
                        <div class="empty-icon">üìÅ</div>
                        <h4>Aucun projet trouv√©</h4>
                        <p>Cr√©ez votre premier projet pour commencer.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>



    <!-- Modal de cr√©ation de projet -->
    <div id="createProjectModal" class="modal" style="display: none;">
        <div class="modal-content project-modal-content">
            <div class="form-container">
                <div class="project-icon">üèóÔ∏è</div>
                <h1 class="form-title">Nouveau Projet</h1>
                
                <form id="projectForm">
                    <div class="form-group">
                        <label class="form-label" for="project-code">
                            Code du projet <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="project-code" 
                            class="form-input" 
                            placeholder="Ex: PROJ-2024-001"
                            required
                            pattern="^[A-Z]{3,4}-[0-9]{4}-[0-9]{3}$"
                        >
                        <div class="form-hint">Code unique pour identifier le projet</div>
                        <div class="validation-message" id="code-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="project-name">
                            Nom du projet <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="project-name" 
                            class="form-input" 
                            placeholder="Ex: R√©sidence Les Jardins"
                            required
                            minlength="3"
                            maxlength="100"
                        >
                        <div class="form-hint">Nom descriptif du projet</div>
                        <div class="validation-message" id="name-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="project-address">
                            Adresse du projet <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="project-address" 
                            class="form-input" 
                            placeholder="Ex: 15 rue de la R√©publique, 75001 Paris"
                            required
                            minlength="10"
                        >
                        <div class="form-hint">Adresse compl√®te du projet</div>
                        <div class="validation-message" id="address-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="project-type">
                            Type de projet <span class="required">*</span>
                        </label>
                        <select id="project-type" class="form-select" required>
                            <option value="">S√©lectionner un type</option>
                            <option value="residentiel">üè† R√©sidentiel</option>
                            <option value="commercial">üè¢ Commercial</option>
                            <option value="industriel">üè≠ Industriel</option>
                            <option value="tertiaire">üèõÔ∏è Tertiaire</option>
                            <option value="equipement">üè• √âquipement public</option>
                            <option value="renovation">üî® R√©novation</option>
                            <option value="autre">üìã Autre</option>
                        </select>
                        <div class="validation-message" id="type-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="project-surface">
                            Surface de plancher totale <span class="required">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="project-surface" 
                            class="form-input" 
                            placeholder="Ex: 1500"
                            required
                            min="1"
                            max="999999"
                        >
                        <div class="form-hint">Surface de plancher en m¬≤ (tous √©tages confondus)</div>
                        <div class="validation-message" id="surface-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="project-owner">
                            Ma√Ætre d'ouvrage <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="project-owner" 
                            class="form-input" 
                            placeholder="Ex: SCI Les Jardins"
                            required
                            minlength="2"
                        >
                        <div class="form-hint">Nom du ma√Ætre d'ouvrage</div>
                        <div class="validation-message" id="owner-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="project-description">
                            Description (facultatif)
                        </label>
                        <textarea 
                            id="project-description" 
                            class="form-input" 
                            placeholder="Description courte du projet..."
                            rows="3"
                            maxlength="300"
                        ></textarea>
                        <div class="form-hint">Description courte du projet (300 caract√®res max)</div>
                        <div class="validation-message" id="description-message"></div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-cancel" id="cancelProjectBtn">
                            ‚úï Annuler
                        </button>
                        <button type="submit" class="btn btn-save" id="saveProjectBtn">
                            üíæ Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 GECC - Gestion & Suivi de Projet BTP</p>
        </div>
    </footer>

    <script src="js/auth.js"></script>
    <script src="js/store.js?v=3.0"></script>
    <script src="js/models.js?v=3.0"></script>
    <script src="js/ui.js?v=3.0"></script>
    <script src="js/app.js?v=3.0"></script>
    <script src="js/projects.js?v=3.1"></script>
    <script src="js/theme-manager.js"></script>
    
    <script src="js/projects-ux.js?v=3.0"></script>
    
    <script>
        // ========================================
        // MISE √Ä JOUR DU HEADER UTILISATEUR
        // ========================================
        
        function loadUserHeaderInfo() {
            try {
                // V√©rifier d'abord la session active
                let currentUser = null;
                const sessionData = localStorage.getItem('currentSession');
                
                if (sessionData) {
                    try {
                        const session = JSON.parse(sessionData);
                        // R√©cup√©rer l'utilisateur complet depuis les donn√©es GECC
                        const geccData = JSON.parse(localStorage.getItem('gecc_data') || '{}');
                        const users = geccData.users || [];
                        currentUser = users.find(user => user.id === session.id);
                    } catch (error) {
                        console.error('Erreur lors de la lecture de la session:', error);
                    }
                }
                
                // Fallback vers l'ancien syst√®me si n√©cessaire
                if (!currentUser) {
                    const savedUser = localStorage.getItem('geccp-currentUser');
                    if (savedUser) {
                        currentUser = JSON.parse(savedUser);
                    }
                }
                
                if (!currentUser) {
                    console.log('Aucun utilisateur connect√©');
                    return;
                }
                
                // Mettre √† jour l'avatar
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar) {
                    if (currentUser.fullName) {
                        const initials = currentUser.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
                        userAvatar.textContent = initials;
                    } else {
                        userAvatar.textContent = 'U';
                    }
                }
                
                // Mettre √† jour le nom
                const userName = document.getElementById('userName');
                if (userName) {
                    userName.textContent = currentUser.fullName || 'Utilisateur';
                }
                
                // Mettre √† jour le r√¥le
                const userRole = document.getElementById('userRole');
                if (userRole) {
                    const roleMap = {
                        'architect': 'Architecte',
                        'bct': 'Bureau de Contr√¥le Technique',
                        'bet': 'Bureau d\'√âtudes Techniques',
                        'contractor': 'Entreprise',
                        'admin': 'Administrateur'
                    };
                    userRole.textContent = roleMap[currentUser.role] || currentUser.role;
                }
                
                console.log('‚úÖ Header mis √† jour pour:', currentUser.fullName);
                
            } catch (error) {
                console.error('Erreur lors de la mise √† jour du header:', error);
            }
        }
        
        // Initialiser le header au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            loadUserHeaderInfo();
        });
        
        // √âcouter les changements de session
        window.addEventListener('storage', function(event) {
            if (event.key === 'currentSession') {
                console.log('üîÑ Session chang√©e, mise √† jour du header...');
                loadUserHeaderInfo();
            }
        });
    </script>
</body>
</html>